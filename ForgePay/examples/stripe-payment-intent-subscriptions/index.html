<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ForgePay â€” æ–¹æ¡ˆ3: PaymentIntent API (Subscriptions)</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #252836;
            --border: #2e3347;
            --accent: #635bff;
            --accent-hover: #7b74ff;
            --text: #e8eaf0;
            --text-muted: #8b90a8;
            --success: #30d158;
            --error: #ff453a;
            --warning: #ffd60a;
            --radius: 12px;
            --font: 'Inter', system-ui, sans-serif;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 520px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, .4);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(99, 91, 255, .15);
            color: var(--accent);
            border: 1px solid rgba(99, 91, 255, .3);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: .5px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        /* ãƒ—ãƒ©ãƒ³é¸æŠ */
        .plans {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 24px;
        }

        .plan {
            background: var(--surface2);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 16px 12px;
            cursor: pointer;
            transition: border-color .2s, background .2s;
            text-align: center;
            position: relative;
        }

        .plan:hover {
            border-color: var(--accent);
        }

        .plan.selected {
            border-color: var(--accent);
            background: rgba(99, 91, 255, .1);
        }

        .plan-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .plan-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .plan-price span {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
        }

        .plan-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .field {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text);
            font-size: 14px;
            font-family: var(--font);
            outline: none;
            transition: border-color .2s;
        }

        input:focus {
            border-color: var(--accent);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        #payment-element-container {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 16px;
            min-height: 56px;
        }

        button {
            width: 100%;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: var(--font);
            cursor: pointer;
            transition: background .2s, transform .1s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button:active {
            transform: scale(.98);
        }

        button:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: rgba(255, 69, 58, .15);
            border: 1px solid rgba(255, 69, 58, .3);
            color: var(--error);
            margin-top: 10px;
        }

        .btn-danger:hover {
            background: rgba(255, 69, 58, .25);
        }

        .info-box {
            background: rgba(99, 91, 255, .08);
            border: 1px solid rgba(99, 91, 255, .2);
            border-radius: 8px;
            padding: 14px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--text);
        }

        .status {
            margin-top: 16px;
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status.success {
            background: rgba(48, 209, 88, .1);
            border: 1px solid rgba(48, 209, 88, .3);
            color: var(--success);
            display: block;
        }

        .status.error {
            background: rgba(255, 69, 58, .1);
            border: 1px solid rgba(255, 69, 58, .3);
            color: var(--error);
            display: block;
        }

        .status.loading {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text-muted);
            display: block;
        }

        /* ã‚¿ãƒ– */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: color .2s, border-color .2s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ãƒ‘ãƒãƒ« */
        .sub-info {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .sub-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .sub-info-row:last-child {
            border-bottom: none;
        }

        .sub-info-label {
            color: var(--text-muted);
        }

        .sub-info-value {
            font-weight: 500;
        }

        .status-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
        }

        .status-badge.active {
            background: rgba(48, 209, 88, .15);
            color: var(--success);
        }

        .status-badge.past_due {
            background: rgba(255, 69, 58, .15);
            color: var(--error);
        }

        .status-badge.canceled {
            background: var(--surface);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .config-note {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-muted);
        }

        .config-note code {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 6px;
            font-family: 'Fira Code', monospace;
            color: var(--accent);
        }

        /* ã‚¹ãƒ†ãƒƒãƒ— */
        #sub-step-1,
        #sub-step-2,
        #sub-step-3 {
            display: none;
        }

        #sub-step-1.active,
        #sub-step-2.active,
        #sub-step-3.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="badge">ğŸš€ æ–¹æ¡ˆ3</div>
        <h1>PaymentIntent API</h1>
        <p class="subtitle">
            å®Œå…¨åˆ¶å¾¡ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã€‚ã‚«ãƒ¼ãƒ‰ç™»éŒ²ãƒ»ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’
            ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å®Œå…¨åˆ¶å¾¡ã€‚
        </p>

        <!-- ã‚¿ãƒ– -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('subscribe')">æ–°è¦ç™»éŒ²</div>
            <div class="tab" onclick="switchTab('manage')">ãƒ—ãƒ©ãƒ³ç®¡ç†</div>
        </div>

        <!-- ===== ã‚¿ãƒ–: æ–°è¦ç™»éŒ² ===== -->
        <div id="tab-subscribe" class="tab-content active">

            <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ—ãƒ©ãƒ³é¸æŠ -->
            <div id="sub-step-1" class="active">
                <div class="plans">
                    <div class="plan" onclick="selectPlan(this, 'starter')" data-plan="starter">
                        <div class="plan-name">ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼</div>
                        <div class="plan-price">Â¥980<span>/æœˆ</span></div>
                    </div>
                    <div class="plan selected" onclick="selectPlan(this, 'pro')" data-plan="pro">
                        <div class="plan-badge">äººæ°—</div>
                        <div class="plan-name">ãƒ—ãƒ­</div>
                        <div class="plan-price">Â¥2,980<span>/æœˆ</span></div>
                    </div>
                    <div class="plan" onclick="selectPlan(this, 'business')" data-plan="business">
                        <div class="plan-name">ãƒ“ã‚¸ãƒã‚¹</div>
                        <div class="plan-price">Â¥9,800<span>/æœˆ</span></div>
                    </div>
                </div>

                <div class="field">
                    <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                    <input type="email" id="email" placeholder="you@example.com" />
                </div>

                <div class="field">
                    <label for="productId">Product ID</label>
                    <input type="text" id="productId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                </div>

                <div class="field">
                    <label for="priceId">Price ID</label>
                    <input type="text" id="priceId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                </div>

                <button onclick="startSetupIntent()">ã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ â†’</button>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ã‚«ãƒ¼ãƒ‰ç™»éŒ² (SetupIntent) -->
            <div id="sub-step-2">
                <div class="info-box">
                    <strong>ğŸ”’ ã‚«ãƒ¼ãƒ‰ç™»éŒ²ï¼ˆèª²é‡‘ãªã—ï¼‰:</strong>
                    ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å®‰å…¨ã«ç™»éŒ²ã—ã¾ã™ã€‚ç™»éŒ²å¾Œã«æœˆæ¬¡èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚
                    ã‚«ãƒ¼ãƒ‰ç•ªå·ã¯ã‚µãƒ¼ãƒãƒ¼ã‚’é€šéã—ã¾ã›ã‚“ã€‚
                </div>

                <div class="field">
                    <label>ã‚«ãƒ¼ãƒ‰æƒ…å ±</label>
                    <div id="payment-element-container">
                        <div id="payment-element"></div>
                    </div>
                </div>

                <button id="setupBtn" onclick="confirmSetup()">ã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ã¦ã‚µãƒ–ã‚¹ã‚¯ã‚’é–‹å§‹</button>
                <button class="btn-secondary" onclick="goToStep(1)">â† æˆ»ã‚‹</button>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—3: å®Œäº† -->
            <div id="sub-step-3">
                <div class="info-box" style="border-color:rgba(48,209,88,.3);background:rgba(48,209,88,.08);">
                    <strong style="color:var(--success)">âœ… ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³é–‹å§‹!</strong><br />
                    <span id="successDetail">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚</span>
                </div>
                <button onclick="goToStep(1)">æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ã‚’ä½œæˆ</button>
            </div>
        </div>

        <!-- ===== ã‚¿ãƒ–: ãƒ—ãƒ©ãƒ³ç®¡ç† ===== -->
        <div id="tab-manage" class="tab-content">
            <div class="field">
                <label for="manageSubId">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID</label>
                <input type="text" id="manageSubId" placeholder="sub_xxxxxxxxxxxxxxxxxxxxxxxx" />
            </div>

            <button onclick="loadSubscription()" style="margin-bottom:16px">ã‚µãƒ–ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€</button>

            <div id="sub-detail" style="display:none">
                <div class="sub-info">
                    <div class="sub-info-row">
                        <span class="sub-info-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                        <span class="sub-info-value"><span id="subStatus"
                                class="status-badge active">active</span></span>
                    </div>
                    <div class="sub-info-row">
                        <span class="sub-info-label">æ¬¡å›è«‹æ±‚æ—¥</span>
                        <span class="sub-info-value" id="subPeriodEnd">â€”</span>
                    </div>
                    <div class="sub-info-row">
                        <span class="sub-info-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«äºˆç´„</span>
                        <span class="sub-info-value" id="subCancelAtEnd">ãªã—</span>
                    </div>
                </div>

                <div class="field">
                    <label for="newPriceId">æ–°ã—ã„ Price IDï¼ˆãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼‰</label>
                    <input type="text" id="newPriceId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                </div>

                <button onclick="upgradePlan()">ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ï¼‰</button>
                <button class="btn-danger" onclick="cancelSubscription(false)">æœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-danger" onclick="cancelSubscription(true)">å³åº§ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>

        <div id="status" class="status"></div>

        <div class="config-note">
            æœ‰åŠ¹åŒ–: <code>PAYMENT_MODE=payment-intent</code> ã‚’ .env ã«è¨­å®š
        </div>
    </div>

    <script>
        // ============================================================
        // è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ³¨å…¥ï¼‰
        // ============================================================
        const CONFIG = {
            apiBase: 'http://localhost:3000/api/v1',
            apiKey: 'YOUR_API_KEY',
            returnUrl: window.location.origin + '/success.html',
        };

        let stripe = null;
        let elements = null;
        let paymentElement = null;
        let customerId = null;
        let currentSubscriptionId = null;

        // ============================================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ============================================================
        function showStatus(type, msg) {
            const el = document.getElementById('status');
            el.className = 'status ' + type;
            el.textContent = msg;
        }
        function clearStatus() {
            const el = document.getElementById('status');
            el.className = 'status';
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', ['subscribe', 'manage'][i] === name);
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            clearStatus();
        }

        function selectPlan(el, plan) {
            document.querySelectorAll('.plan').forEach(p => p.classList.remove('selected'));
            el.classList.add('selected');
        }

        function goToStep(n) {
            [1, 2, 3].forEach(i => {
                document.getElementById('sub-step-' + i).classList.toggle('active', i === n);
            });
            clearStatus();
        }

        async function apiCall(method, path, body) {
            const res = await fetch(`${CONFIG.apiBase}${path}`, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': CONFIG.apiKey,
                },
                ...(body ? { body: JSON.stringify(body) } : {}),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error?.message || `HTTP ${res.status}`);
            return data;
        }

        // ============================================================
        // ã‚¹ãƒ†ãƒƒãƒ—1 â†’ ã‚¹ãƒ†ãƒƒãƒ—2: SetupIntent ä½œæˆ
        // ============================================================
        async function startSetupIntent() {
            const email = document.getElementById('email').value.trim();
            const productId = document.getElementById('productId').value.trim();
            const priceId = document.getElementById('priceId').value.trim();

            if (!email || !productId || !priceId) {
                showStatus('error', 'ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showStatus('loading', 'ã‚«ãƒ¼ãƒ‰ç™»éŒ²ã‚’æº–å‚™ä¸­...');

            try {
                const data = await apiCall('POST', '/subscriptions/setup-intent', {
                    customer_email: email,
                });

                customerId = data.customer_id;
                clearStatus();

                // Stripe Elements ã‚’åˆæœŸåŒ–ï¼ˆSetupIntent ç”¨ï¼‰
                stripe = Stripe(data.publishable_key);
                elements = stripe.elements({
                    clientSecret: data.client_secret,
                    appearance: {
                        theme: 'night',
                        variables: {
                            colorPrimary: '#635bff',
                            colorBackground: '#252836',
                            colorText: '#e8eaf0',
                            colorDanger: '#ff453a',
                            fontFamily: 'Inter, system-ui, sans-serif',
                            borderRadius: '8px',
                        },
                    },
                });

                paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

                goToStep(2);
            } catch (err) {
                showStatus('error', err.message);
            }
        }

        // ============================================================
        // ã‚¹ãƒ†ãƒƒãƒ—2: SetupIntent ç¢ºèª â†’ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ
        // ============================================================
        async function confirmSetup() {
            if (!stripe || !elements) return;

            const btn = document.getElementById('setupBtn');
            btn.disabled = true;
            showStatus('loading', 'ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç¢ºèªä¸­...');

            // SetupIntent ã‚’ç¢ºèªï¼ˆã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ã ã‘ã€èª²é‡‘ãªã—ï¼‰
            const { error, setupIntent } = await stripe.confirmSetup({
                elements,
                confirmParams: { return_url: CONFIG.returnUrl },
                redirect: 'if_required',
            });

            if (error) {
                showStatus('error', error.message);
                btn.disabled = false;
                return;
            }

            // ç™»éŒ²ã•ã‚ŒãŸ PaymentMethod ID ã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
            showStatus('loading', 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆä¸­...');

            try {
                const email = document.getElementById('email').value.trim();
                const productId = document.getElementById('productId').value.trim();
                const priceId = document.getElementById('priceId').value.trim();
                const paymentMethodId = setupIntent?.payment_method;

                const data = await apiCall('POST', '/subscriptions', {
                    product_id: productId,
                    price_id: priceId,
                    customer_email: email,
                    payment_method_id: paymentMethodId,
                    purchase_intent_id: 'demo_' + Date.now(),
                });

                currentSubscriptionId = data.subscription_id;

                // client_secret ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ã®ç¢ºèªãŒå¿…è¦ï¼ˆ3DSç­‰ï¼‰
                if (data.client_secret) {
                    const { error: confirmError } = await stripe.confirmPayment({
                        clientSecret: data.client_secret,
                        confirmParams: { return_url: CONFIG.returnUrl },
                        redirect: 'if_required',
                    });
                    if (confirmError) {
                        showStatus('error', confirmError.message);
                        btn.disabled = false;
                        return;
                    }
                }

                const periodEnd = new Date(data.current_period_end).toLocaleDateString('ja-JP');
                document.getElementById('successDetail').textContent =
                    `ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID: ${data.subscription_id} | æ¬¡å›è«‹æ±‚: ${periodEnd}`;

                clearStatus();
                goToStep(3);
            } catch (err) {
                showStatus('error', err.message);
                btn.disabled = false;
            }
        }

        // ============================================================
        // ç®¡ç†ã‚¿ãƒ–: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿
        // ============================================================
        async function loadSubscription() {
            const subId = document.getElementById('manageSubId').value.trim();
            if (!subId) { showStatus('error', 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            showStatus('loading', 'èª­ã¿è¾¼ã¿ä¸­...');

            try {
                const data = await apiCall('GET', `/subscriptions/${subId}`);
                currentSubscriptionId = subId;

                const statusEl = document.getElementById('subStatus');
                statusEl.textContent = data.status;
                statusEl.className = 'status-badge ' + data.status;

                document.getElementById('subPeriodEnd').textContent =
                    new Date(data.current_period_end).toLocaleDateString('ja-JP');
                document.getElementById('subCancelAtEnd').textContent =
                    data.cancel_at_period_end ? 'æœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«äºˆå®š' : 'ãªã—';

                document.getElementById('sub-detail').style.display = 'block';
                clearStatus();
            } catch (err) {
                showStatus('error', err.message);
            }
        }

        // ============================================================
        // ç®¡ç†ã‚¿ãƒ–: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰
        // ============================================================
        async function upgradePlan() {
            const newPriceId = document.getElementById('newPriceId').value.trim();
            if (!newPriceId) { showStatus('error', 'æ–°ã—ã„ Price ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (!currentSubscriptionId) { showStatus('error', 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }

            showStatus('loading', 'ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´ä¸­...');

            try {
                const data = await apiCall('PUT', `/subscriptions/${currentSubscriptionId}`, {
                    new_price_id: newPriceId,
                    proration_behavior: 'create_prorations',
                });

                showStatus('success', `ãƒ—ãƒ©ãƒ³å¤‰æ›´å®Œäº†ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${data.status}`);
                await loadSubscription();
            } catch (err) {
                showStatus('error', err.message);
            }
        }

        // ============================================================
        // ç®¡ç†ã‚¿ãƒ–: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        // ============================================================
        async function cancelSubscription(immediately) {
            if (!currentSubscriptionId) { showStatus('error', 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }

            const msg = immediately
                ? 'æœ¬å½“ã«å³åº§ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ'
                : 'æœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ';
            if (!confirm(msg)) return;

            showStatus('loading', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­...');

            try {
                const data = await apiCall('DELETE', `/subscriptions/${currentSubscriptionId}`, {
                    immediately,
                });

                const result = immediately
                    ? `ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${data.status}`
                    : `æœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«äºˆç´„æ¸ˆã¿ã€‚`;
                showStatus('success', result);
                await loadSubscription();
            } catch (err) {
                showStatus('error', err.message);
            }
        }
    </script>
</body>

</html>