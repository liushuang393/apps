<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ForgePay â€” æ–¹æ¡ˆ2: Stripe Elements (Custom UI)</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #252836;
            --border: #2e3347;
            --accent: #635bff;
            --accent-hover: #7b74ff;
            --text: #e8eaf0;
            --text-muted: #8b90a8;
            --success: #30d158;
            --error: #ff453a;
            --radius: 12px;
            --font: 'Inter', system-ui, sans-serif;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, .4);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(99, 91, 255, .15);
            color: var(--accent);
            border: 1px solid rgba(99, 91, 255, .3);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: .5px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .product-box {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-name {
            font-weight: 600;
            font-size: 15px;
        }

        .product-price {
            color: var(--accent);
            font-size: 22px;
            font-weight: 700;
        }

        .field {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text);
            font-size: 14px;
            font-family: var(--font);
            outline: none;
            transition: border-color .2s;
        }

        input:focus {
            border-color: var(--accent);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        /* Stripe Elements ã‚³ãƒ³ãƒ†ãƒŠ */
        #payment-element-container {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 16px;
            min-height: 56px;
            transition: border-color .2s;
        }

        #payment-element-container.focused {
            border-color: var(--accent);
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 12px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        button {
            width: 100%;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: var(--font);
            cursor: pointer;
            transition: background .2s, transform .1s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button:active {
            transform: scale(.98);
        }

        button:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            margin-bottom: 12px;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .info-box {
            background: rgba(99, 91, 255, .08);
            border: 1px solid rgba(99, 91, 255, .2);
            border-radius: 8px;
            padding: 14px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--text);
        }

        .status {
            margin-top: 16px;
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status.success {
            background: rgba(48, 209, 88, .1);
            border: 1px solid rgba(48, 209, 88, .3);
            color: var(--success);
            display: block;
        }

        .status.error {
            background: rgba(255, 69, 58, .1);
            border: 1px solid rgba(255, 69, 58, .3);
            color: var(--error);
            display: block;
        }

        .status.loading {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text-muted);
            display: block;
        }

        /* ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º */
        .steps {
            display: flex;
            gap: 0;
            margin-bottom: 28px;
        }

        .step-item {
            flex: 1;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            position: relative;
            padding-bottom: 12px;
        }

        .step-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
            border-radius: 2px;
        }

        .step-item.active {
            color: var(--accent);
        }

        .step-item.active::after {
            background: var(--accent);
        }

        .step-item.done {
            color: var(--success);
        }

        .step-item.done::after {
            background: var(--success);
        }

        .config-note {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-muted);
        }

        .config-note code {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 6px;
            font-family: 'Fira Code', monospace;
            color: var(--accent);
        }

        #step-setup,
        #step-payment {
            display: none;
        }

        #step-setup.active,
        #step-payment.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="badge">ğŸ¨ æ–¹æ¡ˆ2</div>
        <h1>Stripe Elements</h1>
        <p class="subtitle">
            è‡ªå‰ãƒ‡ã‚¶ã‚¤ãƒ³ã®æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ã€‚Stripe Elements ãŒã‚«ãƒ¼ãƒ‰å…¥åŠ›ã‚’å®‰å…¨ã«å‡¦ç†ã€‚
            ãƒ–ãƒ©ãƒ³ãƒ‰UIã‚’ç¶­æŒã—ãªãŒã‚‰ PCI æº–æ‹ ã‚’å®Ÿç¾ã€‚
        </p>

        <div class="steps">
            <div class="step-item active" id="step-indicator-1">â‘  å•†å“é¸æŠ</div>
            <div class="step-item" id="step-indicator-2">â‘¡ ã‚«ãƒ¼ãƒ‰å…¥åŠ›</div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: å•†å“ãƒ»é¡§å®¢æƒ…å ± -->
        <div id="step-setup" class="active">
            <div class="product-box">
                <div>
                    <div class="product-name">ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ï¼ˆä¸€å›æ‰•ã„ï¼‰</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:2px">å³æ™‚ã‚¢ã‚¯ã‚»ã‚¹ä»˜ä¸</div>
                </div>
                <div class="product-price">Â¥9,800</div>
            </div>

            <div class="field">
                <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                <input type="email" id="email" placeholder="you@example.com" required />
            </div>

            <div class="field">
                <label for="productId">Product ID</label>
                <input type="text" id="productId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
            </div>

            <div class="field">
                <label for="priceId">Price ID</label>
                <input type="text" id="priceId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
            </div>

            <button onclick="initPayment()">ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ â†’</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: Stripe Elements ã‚«ãƒ¼ãƒ‰å…¥åŠ› -->
        <div id="step-payment">
            <div class="product-box">
                <div class="product-name" id="summaryName">ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³</div>
                <div class="product-price" id="summaryPrice">Â¥9,800</div>
            </div>

            <div class="info-box">
                <strong>ğŸ”’ å®‰å…¨ãªæ±ºæ¸ˆ:</strong> ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯ Stripe ãŒç›´æ¥å‡¦ç†ã€‚
                ã“ã®ã‚µãƒ¼ãƒãƒ¼ã¯ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’å—ã‘å–ã‚‰ãªã„ï¼ˆPCI SAQ A æº–æ‹ ï¼‰ã€‚
            </div>

            <div class="field">
                <label>ã‚«ãƒ¼ãƒ‰æƒ…å ±</label>
                <div id="payment-element-container">
                    <div id="payment-element"><!-- Stripe Elements ãŒã“ã“ã«æŒ¿å…¥ --></div>
                </div>
            </div>

            <button id="payBtn" onclick="confirmPayment()">ä»Šã™ãæ”¯æ‰•ã†</button>
            <button class="btn-secondary" onclick="goBack()" style="margin-top:10px">â† æˆ»ã‚‹</button>
        </div>

        <div id="status" class="status"></div>

        <div class="config-note">
            æœ‰åŠ¹åŒ–: <code>PAYMENT_MODE=elements</code> ã‚’ .env ã«è¨­å®š
        </div>
    </div>

    <script>
        // ============================================================
        // è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ³¨å…¥ï¼‰
        // ============================================================
        const CONFIG = {
            apiBase: 'http://localhost:3000/api/v1',
            apiKey: 'YOUR_API_KEY',
            returnUrl: window.location.origin + '/success.html',
        };

        let stripe = null;
        let elements = null;
        let paymentElement = null;

        function showStatus(type, msg) {
            const el = document.getElementById('status');
            el.className = 'status ' + type;
            el.textContent = msg;
        }

        function clearStatus() {
            const el = document.getElementById('status');
            el.className = 'status';
            el.textContent = '';
        }

        function setStep(n) {
            document.getElementById('step-setup').classList.toggle('active', n === 1);
            document.getElementById('step-payment').classList.toggle('active', n === 2);
            document.getElementById('step-indicator-1').className = 'step-item ' + (n === 1 ? 'active' : 'done');
            document.getElementById('step-indicator-2').className = 'step-item ' + (n === 2 ? 'active' : '');
        }

        async function initPayment() {
            const email = document.getElementById('email').value.trim();
            const productId = document.getElementById('productId').value.trim();
            const priceId = document.getElementById('priceId').value.trim();

            if (!email || !productId || !priceId) {
                showStatus('error', 'ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showStatus('loading', 'PaymentIntent ã‚’ä½œæˆä¸­...');

            try {
                const res = await fetch(`${CONFIG.apiBase}/payment-intents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.apiKey,
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        price_id: priceId,
                        customer_email: email,
                        purchase_intent_id: 'demo_' + Date.now(),
                    }),
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error?.message || 'ä½œæˆå¤±æ•—');
                }

                const data = await res.json();
                clearStatus();

                // Stripe ã‚’åˆæœŸåŒ–
                stripe = Stripe(data.publishable_key);
                elements = stripe.elements({
                    clientSecret: data.client_secret,
                    appearance: {
                        theme: 'night',
                        variables: {
                            colorPrimary: '#635bff',
                            colorBackground: '#252836',
                            colorText: '#e8eaf0',
                            colorDanger: '#ff453a',
                            fontFamily: 'Inter, system-ui, sans-serif',
                            borderRadius: '8px',
                        },
                    },
                });

                paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

                // é‡‘é¡è¡¨ç¤ºã‚’æ›´æ–°
                const formatted = new Intl.NumberFormat('ja-JP', {
                    style: 'currency',
                    currency: data.currency.toUpperCase(),
                }).format(data.amount / 100);
                document.getElementById('summaryPrice').textContent = formatted;

                setStep(2);
            } catch (err) {
                showStatus('error', err.message);
            }
        }

        async function confirmPayment() {
            if (!stripe || !elements) return;

            const btn = document.getElementById('payBtn');
            btn.disabled = true;
            showStatus('loading', 'æ±ºæ¸ˆå‡¦ç†ä¸­...');

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: { return_url: CONFIG.returnUrl },
            });

            if (error) {
                showStatus('error', error.message);
                btn.disabled = false;
            }
            // æˆåŠŸæ™‚ã¯ return_url ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
        }

        function goBack() {
            if (paymentElement) {
                paymentElement.destroy();
                paymentElement = null;
            }
            clearStatus();
            setStep(1);
        }
    </script>
</body>

</html>