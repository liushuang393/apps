PASS src/__tests__/unit/repositories/CouponRepository.test.ts (73.671 s)
  CouponRepository
    create
      竏・should create a new coupon with all fields (74 ms)
      竏・should create a coupon with minimal required fields (312 ms)
      竏・should create a fixed_amount coupon (4 ms)
      竏・should convert code to uppercase (39 ms)
      竏・should throw error on database failure (779 ms)
      竏・should use provided client for transactions (13 ms)
    findById
      竏・should find a coupon by ID (1 ms)
      竏・should return null if coupon not found (1 ms)
      竏・should handle null expires_at (1 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (1 ms)
    findByCode
      竏・should find a coupon by developer ID and code (2 ms)
      竏・should convert code to uppercase for search (1 ms)
      竏・should return null if coupon not found (1 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (28 ms)
    findByDeveloperId
      竏・should find all coupons for a developer with pagination (3 ms)
      竏・should apply pagination options (1 ms)
      竏・should filter active coupons only when activeOnly is true (1 ms)
      竏・should use default limit and offset (1 ms)
      竏・should return empty array if no coupons found (2 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (2 ms)
    update
      竏・should update coupon name (1 ms)
      竏・should update coupon active status
      竏・should update coupon maxRedemptions (1 ms)
      竏・should update coupon expiresAt (3 ms)
      竏・should update coupon stripeCouponId
      竏・should update coupon metadata (86 ms)
      竏・should update multiple fields at once (11 ms)
      竏・should return null if coupon not found (4 ms)
      竏・should return existing coupon if no updates provided (331 ms)
      竏・should throw error on database failure (24 ms)
      竏・should use provided client for transactions (9 ms)
    deactivate
      竏・should deactivate a coupon (4 ms)
      竏・should return null if coupon not found (1 ms)
      竏・should use provided client for transactions (6 ms)
    delete
      竏・should delete a coupon with no redemptions (7 ms)
      竏・should throw error if coupon has existing redemptions (764 ms)
      竏・should return false if coupon not found (6 ms)
      竏・should throw error on database failure (7 ms)
      竏・should use provided client for transactions (4 ms)
    incrementRedemptionCount
      竏・should increment redemption count (266 ms)
      竏・should throw error on database failure (372 ms)
      竏・should use provided client for transactions (4 ms)
    recordRedemption
      竏・should record a coupon redemption with all fields (302 ms)
      竏・should record redemption without checkout session (5 ms)
      竏・should throw error on database failure (39 ms)
      竏・should use provided client for transactions (7 ms)
    getRedemptions
      竏・should get all redemptions for a coupon (2 ms)
      竏・should return empty array if no redemptions found (1 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (1 ms)
    getCustomerRedemptions
      竏・should get all redemptions for a customer (2 ms)
      竏・should return empty array if no redemptions found (1 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (1 ms)
    hasCustomerRedeemedCoupon
      竏・should return true if customer has redeemed the coupon (2 ms)
      竏・should return false if customer has not redeemed the coupon (1 ms)
      竏・should return true if customer redeemed multiple times
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (66 ms)
    edge cases
      竏・should handle coupon with empty name string (7 ms)
      竏・should handle coupon with empty applies_to_products array (3 ms)
      竏・should handle coupon with complex metadata (24 ms)
      竏・should handle special characters in coupon code (4 ms)
      竏・should handle zero discount value (1 ms)
      竏・should handle 100% percentage discount
      竏・should handle large fixed amount discount
      竏・should properly map dates from database rows (1 ms)
      竏・should handle multiple coupons with same code across developers (1 ms)
      竏・should handle empty metadata object from database (1 ms)
      竏・should handle unicode characters in coupon name
      竏・should handle very long stripe coupon ID (1 ms)
      竏・should handle very high redemption count (1 ms)
      竏・should handle coupon with many products in applies_to_products (1 ms)
    redemption edge cases
      竏・should handle redemption with zero discount amount
      竏・should handle redemption with discount equal to original amount (1 ms)
      竏・should handle redemption with different currency (1 ms)

PASS src/__tests__/unit/repositories/LegalTemplateRepository.test.ts (73.793 s)
  LegalTemplateRepository
    create
      竏・should create a new legal template with all fields (1310 ms)
      竏・should create a template with minimal fields and default values (417 ms)
      竏・should auto-increment version for existing template type (23 ms)
      竏・should throw error on database failure (998 ms)
      竏・should use provided client for transactions (1 ms)
    createNewVersion
      竏・should create a new version of an existing template (1 ms)
      竏・should throw error if template not found (49 ms)
      竏・should preserve original title if not provided (2 ms)
    findById
      竏・should find a template by ID (3 ms)
      竏・should return null if template not found (1 ms)
      竏・should throw error on database failure (33 ms)
      竏・should use provided client for transactions (12 ms)
    findActiveByDeveloperAndType
      竏・should find active template by developer and type (11 ms)
      竏・should return null if no active template found (3 ms)
      竏・should throw error on database failure (3 ms)
    findByDeveloperId
      竏・should find all templates for a developer (8 ms)
      竏・should filter by type when option provided (9 ms)
      竏・should filter by active only when option provided (200 ms)
      竏・should filter by both type and activeOnly (9 ms)
      竏・should return empty array if no templates found (5 ms)
      竏・should throw error on database failure (22 ms)
    findVersionHistory
      竏・should find all versions of a template type (13 ms)
      竏・should return empty array if no versions found (5 ms)
      竏・should throw error on database failure (8 ms)
    activate
      竏・should activate a template and deactivate others of same type (8 ms)
      竏・should return null if template not found (3 ms)
      竏・should return null if update fails (4 ms)
      竏・should throw error on database failure (497 ms)
    update
      竏・should update template title (12 ms)
      竏・should update template content (3 ms)
      竏・should update template language (8 ms)
      竏・should update template effectiveDate (10 ms)
      竏・should update template metadata (10 ms)
      竏・should update multiple fields at once (191 ms)
      竏・should return null if template not found (14 ms)
      竏・should return existing template if no updates provided (9 ms)
      竏・should throw error on database failure (7 ms)
      竏・should use provided client for transactions (16 ms)
    delete
      竏・should delete a template without acceptances (23 ms)
      竏・should throw error if template has acceptances (15 ms)
      竏・should return false if template not found or is active (4 ms)
      竏・should handle null rowCount (2 ms)
      竏・should throw error on database failure (12 ms)
      竏・should use provided client for transactions (6 ms)
    recordAcceptance
      竏・should record customer acceptance with all fields (8 ms)
      竏・should record acceptance without optional fields (16 ms)
      竏・should throw error on database failure (12 ms)
      竏・should use provided client for transactions (9 ms)
    getCustomerAcceptances
      竏・should get all acceptances for a customer (13 ms)
      竏・should return empty array if no acceptances found (4 ms)
      竏・should throw error on database failure (5 ms)
      竏・should use provided client for transactions (511 ms)
    hasAcceptedLatest
      竏・should return true if customer has accepted latest active template (5 ms)
      竏・should return false if customer has not accepted latest (2 ms)
      竏・should throw error on database failure (48 ms)
      竏・should use provided client for transactions (1 ms)
    edge cases
      竏・should handle template with null effective date (1 ms)
      竏・should handle template with empty metadata object (1 ms)
      竏・should handle template with complex metadata (1 ms)
      竏・should handle unicode content (2 ms)
      竏・should handle very long content (1 ms)
      竏・should handle all template types (2 ms)
      竏・should properly map dates from database rows (10 ms)
      竏・should handle special characters in HTML content (94 ms)
    error logging
      竏・should log error when create fails (9 ms)
      竏・should log error when findById fails (24 ms)
      竏・should log success when template is created (1 ms)
      竏・should log success when template is activated
      竏・should log success when template is deleted (1 ms)
      竏・should log success when acceptance is recorded (2 ms)
      竏・should log error when recordAcceptance fails (4 ms)
      竏・should log error when findActiveByDeveloperAndType fails (6 ms)
      竏・should log error when findByDeveloperId fails (2 ms)
      竏・should log error when findVersionHistory fails (3 ms)
      竏・should log error when update fails (2 ms)
      竏・should log error when delete fails (2 ms)
      竏・should log error when getCustomerAcceptances fails (5 ms)
      竏・should log error when hasAcceptedLatest fails (2 ms)

PASS src/__tests__/unit/repositories/WebhookLogRepository.test.ts (73.689 s)
  WebhookLogRepository
    create
      竏・should create a new webhook log with all fields (44 ms)
      竏・should create a webhook log with default status when not provided (3 ms)
      竏・should throw error on database failure (1265 ms)
      竏・should use provided client for transactions (13 ms)
    findById
      竏・should find a webhook log by ID (17 ms)
      竏・should return null if webhook log not found (11 ms)
      竏・should throw error on database failure (10 ms)
      竏・should use provided client for transactions (7 ms)
    findByStripeEventId
      竏・should find a webhook log by Stripe event ID (227 ms)
      竏・should return null if webhook log not found (497 ms)
      竏・should throw error on database failure (39 ms)
      竏・should use provided client for transactions (7 ms)
    isEventProcessed
      竏・should return true if event is processed (2 ms)
      竏・should return false if event is not processed (1 ms)
      竏・should return false if event does not exist (2 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (1 ms)
    findByStatus
      竏・should find webhook logs by status (2 ms)
      竏・should respect limit parameter (1 ms)
      竏・should return empty array if no logs found (1 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    findByEventType
      竏・should find webhook logs by event type (2 ms)
      竏・should respect limit parameter (1 ms)
      竏・should return empty array if no logs found
      竏・should throw error on database failure (4 ms)
      竏・should use provided client for transactions (1 ms)
    findFailedForRetry
      竏・should find failed webhook logs for retry (2 ms)
      竏・should respect maxAttempts parameter (1 ms)
      竏・should respect limit parameter
      竏・should return empty array if no failed logs found (1 ms)
      竏・should throw error on database failure (108 ms)
      竏・should use provided client for transactions (13 ms)
    findInDLQ
      竏・should find webhook logs in dead letter queue (10 ms)
      竏・should respect limit parameter (32 ms)
      竏・should return empty array if DLQ is empty (1 ms)
      竏・should use provided client for transactions (2 ms)
    update
      竏・should update webhook log status (39 ms)
      竏・should update webhook log attempts (1 ms)
      竏・should update webhook log lastAttemptAt (1 ms)
      竏・should update webhook log errorMessage (1 ms)
      竏・should update multiple fields at once (1 ms)
      竏・should set errorMessage to null (1 ms)
      竏・should return null if webhook log not found
      竏・should return existing webhook log if no updates provided (2 ms)
      竏・should throw error on database failure (4 ms)
      竏・should use provided client for transactions (1 ms)
    markProcessed
      竏・should mark webhook log as processed (2 ms)
      竏・should return null if webhook log not found
      竏・should use provided client for transactions
    markFailed
      竏・should mark webhook log as failed with error message (1 ms)
      竏・should increment attempts counter (1 ms)
      竏・should return null if webhook log not found
      竏・should use provided client for transactions (1 ms)
    moveToDLQ
      竏・should move webhook log to dead letter queue (1 ms)
      竏・should return null if webhook log not found (1 ms)
      竏・should use provided client for transactions (1 ms)
    delete
      竏・should delete a webhook log (2 ms)
      竏・should return false if webhook log not found
      竏・should handle null rowCount (1 ms)
      竏・should throw error on database failure (28 ms)
      竏・should use provided client for transactions (1 ms)
    edge cases
      竏・should handle webhook log with empty payload (4 ms)
      竏・should handle webhook log with complex payload (5 ms)
      竏・should handle very long Stripe event ID (2 ms)
      竏・should handle very long error message (10 ms)
      竏・should properly map dates from database rows (7 ms)
      竏・should handle null lastAttemptAt (3 ms)
      竏・should handle all webhook statuses (5 ms)
      竏・should handle special characters in event type (7 ms)
      竏・should handle unicode characters in error message (4 ms)
      竏・should handle high attempt count (4 ms)
    error logging
      竏・should log error when create fails (14 ms)
      竏・should log error when findById fails (15 ms)
      竏・should log error when findByStripeEventId fails (12 ms)
      竏・should log error when isEventProcessed fails (5 ms)
      竏・should log error when findByStatus fails (3 ms)
      竏・should log error when findByEventType fails (3 ms)
      竏・should log error when findFailedForRetry fails (2 ms)
      竏・should log error when update fails (4 ms)
      竏・should log error when delete fails (6 ms)
      竏・should log success when webhook log is created (6 ms)
      竏・should log success when webhook log is updated (6 ms)
      竏・should log success when webhook log is deleted (2 ms)
      竏・should not log delete when webhook log not found (1 ms)

PASS src/__tests__/unit/repositories/EntitlementRepository.test.ts (76.44 s)
  EntitlementRepository
    create
      竏・should create a new entitlement with all fields (94 ms)
      竏・should create an entitlement without optional fields (480 ms)
      竏・should throw error on database failure (875 ms)
      竏・should use provided client for transactions (20 ms)
    findById
      竏・should find an entitlement by ID (27 ms)
      竏・should return null if entitlement not found (3 ms)
      竏・should throw error on database failure (13 ms)
      竏・should use provided client for transactions (7 ms)
    findByPurchaseIntentId
      竏・should find an entitlement by purchase intent ID (9 ms)
      竏・should return null if entitlement not found (5 ms)
      竏・should throw error on database failure (11 ms)
      竏・should use provided client for transactions (7 ms)
    findByCustomerId
      竏・should find all entitlements for a customer (17 ms)
      竏・should return entitlements ordered by created_at descending (7 ms)
      竏・should return empty array if no entitlements found (6 ms)
      竏・should throw error on database failure (148 ms)
      竏・should use provided client for transactions (5 ms)
    findActiveByCustomerId
      竏・should find active entitlements for a customer (5 ms)
      竏・should filter out expired entitlements (34 ms)
      竏・should return empty array if no active entitlements (2 ms)
      竏・should throw error on database failure (15 ms)
      竏・should use provided client for transactions (3 ms)
    findByStatus
      竏・should find entitlements by status (30 ms)
      竏・should return entitlements ordered by created_at descending (10 ms)
      竏・should return empty array if no entitlements found (5 ms)
      竏・should throw error on database failure (12 ms)
      竏・should use provided client for transactions (14 ms)
    findBySubscriptionId
      竏・should find an entitlement by subscription ID (12 ms)
      竏・should return null if entitlement not found (3 ms)
      竏・should throw error on database failure (5 ms)
      竏・should use provided client for transactions (19 ms)
    findByPaymentId
      竏・should find an entitlement by payment ID (9 ms)
      竏・should return null if entitlement not found (9 ms)
      竏・should throw error on database failure (7 ms)
      竏・should use provided client for transactions (6 ms)
    update
      竏・should update entitlement status (6 ms)
      竏・should update entitlement expiresAt (5 ms)
      竏・should update entitlement revokedReason (1 ms)
      竏・should update multiple fields at once (1 ms)
      竏・should return null if entitlement not found
      竏・should return existing entitlement if no updates provided (1 ms)
      竏・should throw error on database failure (7 ms)
      竏・should use provided client for transactions (8 ms)
      竏・should set expiresAt to null when explicitly provided (6 ms)
    suspend
      竏・should suspend an entitlement with reason (216 ms)
      竏・should return null if entitlement not found (1 ms)
      竏・should use provided client for transactions (1 ms)
    revoke
      竏・should revoke an entitlement with reason (8 ms)
      竏・should return null if entitlement not found (4 ms)
      竏・should use provided client for transactions (7 ms)
    reactivate
      竏・should reactivate an entitlement (4 ms)
      竏・should return null if entitlement not found (1 ms)
      竏・should use provided client for transactions (4 ms)
    extendExpiration
      竏・should extend entitlement expiration date (7 ms)
      竏・should return null if entitlement not found (4 ms)
      竏・should use provided client for transactions (305 ms)
    delete
      竏・should delete an entitlement (69 ms)
      竏・should return false if entitlement not found (6 ms)
      竏・should handle null rowCount (5 ms)
      竏・should throw error on database failure (11 ms)
      竏・should use provided client for transactions (5 ms)
    findExpiredEntitlements
      竏・should find expired entitlements (12 ms)
      竏・should return empty array if no expired entitlements (5 ms)
      竏・should throw error on database failure (8 ms)
      竏・should use provided client for transactions (3 ms)
    edge cases
      竏・should handle entitlement with null subscription_id (7 ms)
      竏・should handle entitlement with null expires_at (7 ms)
      竏・should handle entitlement with revoked_reason (7 ms)
      竏・should properly map dates from database rows (8 ms)
      竏・should handle various entitlement statuses (154 ms)
      竏・should handle long purchase intent IDs (1 ms)
      竏・should handle unicode characters in revoked_reason (1 ms)
      竏・should handle multiple entitlements for same customer and product (2 ms)
    error logging
      竏・should log error when create fails (5 ms)
      竏・should log error when findById fails (16 ms)
      竏・should log error when findByPurchaseIntentId fails (7 ms)
      竏・should log error when findByCustomerId fails (13 ms)
      竏・should log error when findActiveByCustomerId fails (14 ms)
      竏・should log error when findByStatus fails (10 ms)
      竏・should log error when findBySubscriptionId fails (11 ms)
      竏・should log error when findByPaymentId fails (12 ms)
      竏・should log error when update fails (11 ms)
      竏・should log error when delete fails (14 ms)
      竏・should log error when findExpiredEntitlements fails (2 ms)
      竏・should log success when entitlement is created (1 ms)
      竏・should log success when entitlement is updated (1 ms)
      竏・should log success when entitlement is deleted (2 ms)
      竏・should not log success when delete finds no entitlement (3 ms)

{"level":"info","message":"Test message","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"error","message":"Test error","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"warn","message":"Test warning","timestamp":"2026-02-04 17:49:26:4926"}
{"action":"test","level":"info","message":"Test with metadata","timestamp":"2026-02-04 17:49:26:4926","userId":"123"}
{"code":500,"error":{},"level":"error","message":"Error with metadata","timestamp":"2026-02-04 17:49:26:4926"}
{"error":{},"level":"error","message":"Caught error","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"lz@:4+?","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"/NEG_W[SL","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"+=f0HW-z6#","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"gmc^2R$","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"name","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"%","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"F","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"xO","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"YIC","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"/!q=wd","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"@62#'","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"[eu|`|:HQ1","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"h;]0'bI.x","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"66wxGAh","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"mkp&Wy","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"C","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"J","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"j`yP!*^","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"i","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"sU(","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"R!Ax\"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"3DhT}OMI","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"H","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":" u;{xix4Y","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"v$8f","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"RW","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"^2JAM&'","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"Y%","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"kQ2G70w&c ","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"2","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"__proto__","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"k0>@X1J3D","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"_nkcL~h2","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"%g","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"iY","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"AIjF","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"zdv5F^Y","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"9kT~|}M1S","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"_iULo","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"Vn!","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"pYf3Y<\\Y","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"1Ai9Tc2!+]","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"g","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"bXnXq","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"D',=","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"u+w=NT-","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"call","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"]d{>3","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"!#z","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"%|&jE$%","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"oGy\"4X","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"bi+)(","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"}c","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"1Au9EfU# ","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"'kxAR\\","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"U:","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"gu&]|,`t]","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"!p","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"p","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"}$}","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"#","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"yrefkey_pp","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"/Z%","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"`","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"'m4x>i\"\\","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":".rcP","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":" |W","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"3`:.@N|6","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"l","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"-dUWD","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"<:~zwx4j>","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"^j}","timestamp":"2026-02-04 17:49:26:4926"}
{"level":"info","message":"s","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"0/d#Ds-l","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"pro","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"$}Y%SE=R9","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"toSt","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"Y*","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"jdt:","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"gig(!L~","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"s,XsVrB$$","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"3","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"\"u_IA","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"--=U-","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"vIE<","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"U[O=\\!$I+","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"aA","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"y<QYS","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"","timestamp":"2026-02-04 17:49:27:4927"}
{"level":"info","message":"=argument","timestamp":"2026-02-04 17:49:27:4927"}
{"":[-926332234799457,true,{"O5uOEt":-8.85103034115778e-53},-5.9548641458181066e-158],")}hj":"I,}MTfGWx ","B9n":[-6353920201243624,-5685366397093177,1.468419202478064e-18,797830834037161,null],"HZ":[{"\\#0iYVy=":8.199087024944225e-208},[-3656395259639517,"\\O$ccqF",false,"tvtL]ma7"],{"CWu\"(;~%":[null,"Qn0&A'(_","i8L*vsm/",-5.657249667824472e-93,[],4.5936570909714195e+147,"rgbmp"]}],"W":-3023348813532156,"cWXXKi^R":true,"level":"info","message":"","timestamp":"2026-02-04 17:49:27:4927","zX":{"pl{i:uI+`e":{"(":-5.466686262744205e+235,"=ha":"_Mn\\*",">>V":false,"[N$*O8C_d*":true,"pY05":{" r^tzuh":null,"8":false,"?f:Rq":null,"N8O{_p%`l":false,"Y?P(c&":true,"\\F VvwNv":false,"pc-gl":"e","wUiGu~":true,"~4{!":true},"vV":6608496257197835}}}
{"level":"info","message":"arguments","timestamp":"2026-02-04 17:49:27:4927"}
{"Fd,%iFhe":{"+*\\Z/}4u":-4.960003004704042e+124,";*FR,&":true,"c/!CII+":3202841732196559,"p?Q[SkwA`":"gU","q":false,"}(LK|{":836226802752003.9},"level":"info","message":"RAb(rIOf0","timestamp":"2026-02-04 17:49:27:4927"}
{"":[{"":"N,mbu8VG:b","!x ?":1.92835774522402e+153,"caller":true,"i":"","j":false},true],"CuZL;s=n|":-9.860970356126307e-197,"][E":"5","hasOwnPro":{"6":"6CR1&e@($","PD":true,"vuH)P[":true},"level":"info","message":"arguments","timestamp":"2026-02-04 17:49:27:4927"}
{"key":{"%l":[true,null,null,"!D",true,null,-7.88873172293116e-36,"","Q>FW"],"M'=X":[{"":false,"*cv17&h":8.794946271471353e-20,".":"+c#j","]j":true,"m;O(":5968732133270117,"n)":-6915761713667632,"n*7ub":-5786179699676210,"v~glT`f-":5815652049113011},["D@ Y"]],"`B":"Tfw@z@Sq3X"},"level":"info","message":"&]s nbvc","timestamp":"2026-02-04 17:49:27:4927"}
{"'=B":{"'#{H\"*5<Y ":["R",true,-6.741271933865943e+134],"YD3O46RV":[-508193351554504,1.9171648208787722e-202,-4.470368552773451e+31,"Xh5",true,4488332248360543,"ri+lsn1-g"],"grR@":["GYzr)p4d= ",3707573995476353,true,null,true,"^|To)y&",-6.475719056096705e-267,true],"l=":"L|7#i1`Y","~":true},"Y6*J*D":{"1(z%A0":{"!)n{":"G:-_3","P1B@oG->WX":".Tl?","[D rT":-8970097088696864},"LO":{"o_R'6":["/","+R"],"}a4z,M9/":","}},"Zj@<W<0M":[{"":"?","$\\#":null,"9Rg":{"":-2.08323864668246e+301,"):N4WL8q\"":true,"@zUm IBRDK":null,"GjaF/?":"N9","Jp":true,"q":"?Fte=1G:K","v\"3[zd9,T5":null},"J4":{"":3074692415962013,"#":false,")":true,"8":"I@KJW","L&1S&U0":-6.5291972010998e+85,"Z+zpo,":"HZ]p^I/V","\\n`e":-664382396494762,"c5O+V":"?<\""},"^&q":3915331223510521,"c])oA\\!m^w":-2038014864601193,"eqM5":true,"n8AJrUsKF":"8iaw#}!5(","s&<VW":5.7880053372210764e+265},[-1.8669664253119698e+112,-5082308589494247,"R`q,#d",null,6.077981518728214e-148,false,null,"%KmQM",5085900068683367,"*^"],[-6.733111358316271e+143,{"/%V3|Tmr]":null,":3":7241897361014017,"A":true,"B`QuJ_kJ":"u8","JsB,{E*":null,"cgGYQ~d":"2bw)","l>Sl6yGA":"b~]p/"},{"":false,"&":-3.1270232778073496e-17,"+V!Y-'^2w":null,"/<":-5709543299353569,"0xxVkt;2":-9.130681144504825e-237,"_O\"":-8228892847345129,"f &aQ":6808522658464763},true,null]],"`I~Wp":-3.251713964697045e-179,"level":"info","message":"{r4QYw.pHn","timestamp":"2026-02-04 17:49:27:4927"}
{"":[-3.5094941335449455e-158,[null,1.2825663850003452e+126,false,-6570964213425394,-1740932499408522,"LCF>i"],{"ran}w<1":false,"w|K~k":{"+Py`":false,"dupe9C":false,"~":false}},"^v#Pq"],".$o":{",9":3123063920182071,"0RQ?UmaP":8345996493459529,"GLN&1hC(7":5.057543009916517e+113,"R`p+EAqX0_":"!1.uBm0","_McY=":1105896250445173,"i":-3.069101519710928e-162,"l":["P|94`Ny+:,",2.835019202831958e+182,true,4292236297555343,6.368518363298947e+299,-1.8745122765376688e-89,true,2.992752912349393e-250,8542645658221433,"<"]},"3v:Y":-7521648459238481,"65\"":[null,{"":-3.49510101933065e-160,":$s>=":["=b+Ym",1.445466710341448e-113,null,true,5291555249819267,false,-3117278185027762],"S>0tZ":7.120494490770985e+198,"W'EV:Y":true,"g":-2282885698599402,"vu?zFz|wB":"`A"}],"F6*":[6573685392791429,-4902050546517582,-24398420990605.023,null,"",null,"cc^ }vjQU",false,false],"eNRVl":[1.5693800723566527e-204,7866587724309797,{"":null,"-@=":-2.7279369276437108e+23,"DQ":false,"IUj-0":4945059899128733,"d2Jlu":8989218457252861,"fJYy,TE1Qk":true,"ixk*":false},7323673028726485,"",null,6.317173072971014e-146,")~ov5ITQ$j","ua^fwt,g$",true],"level":"info","message":"R\"=","p":[false,null,[],-9.609350006326635e+44],"timestamp":"2026-02-04 17:49:27:4927"}
{"":true,"RCTbV_%h":[{"":-4.0028582969258227e-14,"#4wf":6.3066434589225466e-21,"/zg[sl>d&y":-5.495366067664044e+283,";,=\"(=]":true,"y":"tOHG>","~}'As:X'-\\":null},[{"7":false,"AhHm6H":false,"hb@%^?G":true,"}fauu":"rVxe'-e62B"},1.4463286962899493e+302,2.67e-322,"wze-A",7.839368141974873e-34,2216799568725537,-9007199254740961],{"":-4379346455607039,"0eOp)L":"I&"}],"level":"info","message":"eyv","timestamp":"2026-02-04 17:49:27:4927","tsy'jI":[1.085785810924813e+51,null,-8951865053545632,"ZR&7yLR","AJ%ATdY&",false]}
{"$Px \"u&L":{" }$KK8D":[6921380480298275,2.508092633682568e+24,false,5117886079683553,false,false,"qjU|#vE"]},"bmc]s_":{"(e2;vG<":"ak&9*0joW@","Em1Ax5ZT9":"","HAeAJT$bM":null,"dskO/A":2.947845549811017e-277},"h&Iyi$Z3A":[[false,"x7D"],{"jGgr3]W1":-3.8888498014272144e-30}],"level":"info","message":"+L<","timestamp":"2026-02-04 17:49:27:4927"}
{"!:Et#a":[2156169010757055,7127874465692857,-2.02428043310903e-143,-1.4696508003315287e+283,-5.792180619290153e+95,null,-8.200572129607742e+143,null],"#S":{"/b":true,"2u":false,"7(Oi@t=C":false,"`":null,"`Y,2v>zW!":-6844769087229368,"i(RU'B}":-6915374754159277,"j0#1t,[09":true},"(7~V^":{"":{"HmCiZ<qe?":-3672562790113835,"ak28uZ9":8.203436095709881e-53,"l_~2I":{}}},"+~$q{$%xh&":"C",".!xQ8":false,"Z#V99[YWV":true,"c+8J_":{"":8287137348860089,"2":"q<H","5}":-7712937580597646,"<-":2326306971333533,"G~":false,"W\\ur$":"","]\"N":-7241719126561168,"c":1.5356896468534495e-158,"s`R":true,"yxhU)IEu>?":"5|"},"level":"info","message":"","timestamp":"2026-02-04 17:49:27:4927","xh=~|<!6:":{"":"X","\"]V)?f?D\"":5584687281045253,"%E@":6778979806637517,"+9nzw>;2":"uSW5","+tJC":null,"H\\d":-2383750632941194,"eP`Iht|Q":"","}9":false,"~U60!([lGT":1.6990442555005632e-183},"z,/<UKn":[{"#{Eg*":"0","(F^5~":7667866009376561,"0?":"p?@Z*4]V~D","K,]":-3.6651666992735298e-68,"d/UHs?`jpI":false,"g[":true,"pGh":"9ucy;S=VS.","yZ:bf&84 1":5590845617175037,"|Oum0\\s":""}]}
{"":[{"":null,"\"2":true,"9zSH":"w","J)J!T+&":-2290290876590333,"Kwkr9QL\"":"Oh8~4\\LvL","VV`":false,"xwFgJbC?c":-7.28618095566702e+35},{"":true,"4":-2.908665128328556e-194,"?vPh;E^":-2.6286023330690467e-265,"Go#_%JT1#!":5701782885650343,"VxH|*`m":-3985029688324589,"a(":"FDFe-z,\\","s;:~KN\"eE5":false,"tr=*":-62400431388768},true],"%C.ND{(":["v(#/1BZo","U}4",null,-3.999119873673292e+226,1.1270878592994242e-266,{"6":true,"d.]n2\"":true}],"*":{"":-2104423193876728,"-":"1S0i}eMXKa","OTR^^%":5.128066108526607e+262,"VvsVCK1$ ":null,"d|M":-119347738558411},".t23,-3_g":[{"K83`ki>.(":null},2760120618741873],"11=":[false,"",null,2.22615525005151e+287,"~?Ee*S ",null],"5'(FJ-iw":[],"PuP2O!|%":[[6.607798051057312e-161,true,5172550709970265,null]],"T:":[[-1.7421899751251552e+273,null,{" <4":3.6318165545174293e+247,"\"jj":4772923670863643,"AJyMu3":"jUWHFz4g","T\\o":1.0866308609537636e+188,"Y*b(gY_N":false,"b>qyBh!~dZ":-2.379539018038269e-248}],[-1.710318111322817e+212,"Z}]kD'E",7189236734192205,1.4461066168125128e-81,"h.H",6078996614607743,null,"u;Vs9i0Lg!","$B2",true],false],"level":"info","message":"7","timestamp":"2026-02-04 17:49:27:4927","|4~cszGVZ8":{}}
{"level":"info","message":"[{HL","timestamp":"2026-02-04 17:49:27:4927"}
PASS src/__tests__/unit/routes/legal.test.ts (20.85 s)
  Legal Routes
    GET /api/v1/legal/:developerId/:type
      Successful Responses
        竏・should return template as HTML by default (904 ms)
        竏・should return template as JSON when format=json (48 ms)
        竏・should convert markdown to HTML when contentHtml is null (14 ms)
        竏・should use existing contentHtml when available (10 ms)
        竏・should handle template without effectiveDate (23 ms)
        竏・should support all valid template types (21 ms)
        竏・should set correct HTML lang attribute from template language (125 ms)
      Error Handling
        竏・should return 400 for invalid template type (14 ms)
        竏・should return 404 when template not found (132 ms)
        竏・should return 500 when service throws error (48 ms)
    GET /api/v1/legal/:developerId/urls
      Successful Responses
        竏・should return legal URLs (308 ms)
        竏・should pass correct baseUrl to service (297 ms)
      Error Handling
        竏・should return 500 when service throws error (418 ms)
    GET /api/v1/legal/admin/templates
      Authentication
        竏・should call apiKeyAuth middleware (326 ms)
        竏・should return 401 when API key is missing (523 ms)
      Successful Responses
        竏・should return all templates for developer (235 ms)
        竏・should filter by type when provided (290 ms)
      Error Handling
        竏・should return 400 for invalid template type filter (86 ms)
        竏・should return 500 when service throws error (53 ms)
    GET /api/v1/legal/admin/templates/:id
      Successful Responses
        竏・should return template by id (95 ms)
      Error Handling
        竏・should return 404 when template not found (52 ms)
        竏・should return 403 when template belongs to another developer (51 ms)
        竏・should return 500 when service throws error (170 ms)
    POST /api/v1/legal/admin/templates
      Successful Responses
        竏・should create a new template (435 ms)
        竏・should create template with optional fields (60 ms)
      Validation
        竏・should return 400 when type is missing (39 ms)
        竏・should return 400 for invalid template type (57 ms)
        竏・should return 400 when title is missing (47 ms)
        竏・should return 400 when content is missing (44 ms)
      Error Handling
        竏・should return 500 when service throws error (42 ms)
    POST /api/v1/legal/admin/templates/defaults
      Successful Responses
        竏・should create default templates (16 ms)
        竏・should return template summaries without full content (12 ms)
      Error Handling
        竏・should return 500 when service throws error (7 ms)
    PUT /api/v1/legal/admin/templates/:id
      Successful Responses
        竏・should update template (54 ms)
        竏・should pass createNewVersion flag to service (25 ms)
        竏・should handle effectiveDate update (30 ms)
      Error Handling
        竏・should return 404 when template not found (8 ms)
        竏・should return 403 when template belongs to another developer (8 ms)
        竏・should return 500 when service throws error (7 ms)
    POST /api/v1/legal/admin/templates/:id/activate
      Successful Responses
        竏・should activate template (24 ms)
        竏・should notify customers when requested (268 ms)
        竏・should not notify customers when not requested (17 ms)
      Error Handling
        竏・should return 404 when template not found (18 ms)
        竏・should return 403 when template belongs to another developer (11 ms)
        竏・should return 500 when service throws error (9 ms)
    DELETE /api/v1/legal/admin/templates/:id
      Successful Responses
        竏・should delete inactive template (45 ms)
      Error Handling
        竏・should return 404 when template not found (7 ms)
        竏・should return 403 when template belongs to another developer (10 ms)
        竏・should return 400 when trying to delete active template (63 ms)
        竏・should return 400 when delete fails (has acceptances) (71 ms)
        竏・should return 500 when service throws error (71 ms)
    GET /api/v1/legal/admin/templates/:type/history
      Successful Responses
        竏・should return version history (9 ms)
        竏・should call service with correct parameters (34 ms)
      Error Handling
        竏・should return 400 for invalid template type (10 ms)
        竏・should return 500 when service throws error (35 ms)
    Markdown to HTML Conversion
      竏・should convert h1 markdown to HTML (51 ms)
      竏・should convert h2 markdown to HTML (23 ms)
      竏・should convert h3 markdown to HTML (10 ms)
      竏・should convert bold markdown to HTML (60 ms)
      竏・should convert italic markdown to HTML (47 ms)
      竏・should convert list items to HTML (258 ms)
      竏・should preserve existing HTML tags in markdown (27 ms)
      竏・should wrap plain text in paragraph tags (10 ms)
    Route Configuration
      竏・should return 404 for unknown routes (15 ms)
      竏・should handle OPTIONS requests for CORS preflight (10 ms)
    Edge Cases
      竏・should handle template with special characters in content (10 ms)
      竏・should handle empty developer ID parameter (11 ms)
      竏・should handle concurrent requests to same endpoint (197 ms)
      竏・should handle very long content (729 ms)

{"(1%":{"':com":[[true,-2463200888546253,-3.8168009962656017e+295,null,"K.nngCK","@eb","",",}Z",-2.8316427291694755e-213],0.00003443596622081659,null,null,1.3134879099537239e-98,true,false,6895451066643557,false,7082971238317499]},"7P;cU%EK":{";?x":false,"S":"(","S<Ypl":-6.349979488390462e-167,"SK0h/":true,"U&=E:ko}l":"dq/|q7","r'BUkW":1.2247450092473103e-220},"Hj,L=IuPLD":{"":null,"#-F'z}4h":true,"&4]3v":{"":-3538535004465038,"U^Z":4.1421548269959856e+157,"\\`[":"c<P,Z","o%EG!&rs":2093755701064905},"+NW":"NO","4<4/W":"dm(>w","B]A{Y":3145130911151133,"~EAF3yE":4.183902043689917e-213},"QkB{iO":{"":-5881349188777733,"KN+.zlz":-4633979135907769,"Z(+kC]O":[],"vO.":-8.463873825574775e-110},"lOND0W":[-3.942230479487881e+268,["J$[a%2/yF|",5091903584249501],3083625834791861],"level":"info","message":"`jl^-W#K","nH.)ZW":{"30":[7352997120059709,"V&&Mu>","iSf2y\\QEC4",6.882043277259851e-168,null,true,1.7904020881301664e+238,true,257808626021297,300520963875481],"?Q8!->qQA":{";K9Zd&6":-9.480613612662803e+307,"TCY\"Z*d":"cNizSPy}","b=HS":-1.6877052931300115e+145},"t\\|Y{n`":{"=x\\":"",">":[true,null,2.373810957018925e-38,-8973921615822767,"z`iD:)1(]~"],"G(^L#SeT":null,"R5Qz6\\O":"Tj(bzn<>6","oX":[3083828331330037],"~7X0-\"":"IMKbs"}},"timestamp":"2026-02-04 17:49:28:4928","u6sI":{",ZNM[":[-1.532298439102018e-164,-3.9043731609786305e-210,true],"48\"u#<t`i":{"@":"%","B^P?w`oGJG":{},"I;K:#]A(":"C","Neoc":"8*R^IR;","OJ8ePxQ":true,"SNo[mMLkS^":-6.792158214233202e-247,"hoL5":5.15897440457279e-282,"mmF,b":false,"w:,`OH-m":"`HF4@o","|/$u":3292997909051589}}}
{"level":"info","message":"6uU,GWJtu","timestamp":"2026-02-04 17:49:28:4928"}
{"":-25,"!bindprop":{"":-421871726479360,"H":true,"JKO":-2.156377605749255e-215,"Lg41KhyG":-4917560822874895,"d;":false,"mT@rj\"K9":"Hd6fF?wI","{*?":true,"~":-1.4376017282543907e+257},"2eLtD9i":{"4vXJ":{"X":"on7Tr|ZV=","`h\\B<QrOLJ":"_Nw#1\\hK","q'=":false},"7nL":-2.032629972705944e+156,":dl+":[false,true,true,null],"AeE\\(^g`6":"[z:S"},"34>":null,"FfdWl%":{"&":["\"JP'zB",1.5897507290124006e+121,false],"LY!?5uC5+l":[-7207165567673930,null,1.404357236918052e-229,"v[;}p7|6T",-5.538068742846816e+270,-6738506696506494,-8.393475476871768e+305,-1.998882291391291e+230,"%1;"],"bjo{8s{\"g":true,"ndo":2.3837195411245296e+212},"WSo,kD9,":{"":false,"OIvuCm-}|":"VbHaZ:@q"},"bE0":{"":{"":"call","X'pPU":true},"%8":[],"d":[true,null,true,-1.537734212172213e-49,-1.7976931348623101e+308,true,"Oj-",-4.1317685180135634e+265]},"level":"info","message":"-p;+(VxA7","timestamp":"2026-02-04 17:49:28:4928","|Z":[null,{"":{"5":"w3t","C%j":false,"L":false,"M0jO%^(dz-":1.1091018531590983e-211,"YM.L9Edt":5.220053443584855e+41,"\\MBpnjl\\":3.0876144386674235e-227},"OW35q":{},"U3":"w[Q","`R(":{"":false,"3rny2M}kP":-5.141364261668419e+47,"5/VD@o1%":false,"935$5$":"BVv`",";/hQ(":true,"RB@yN":-5.1270238948803475e-276,"VPnDYyw,G":-8.763683762656976e-209,"i":"r$?1vg","q3`OC$#Y=":"-%7-ew+","q=[":"<\"d>{nhJ2"},"~":"s<y+*wk?Pv"},"N",4.4e-323]}
{"#e3I{:TlI":{},"#r(_%7+(a":[-6793890967987653,-3218346647765876,1.1587998041109065e+136,3.780816082684505e+246,2273137379224561,"ZHvkey","%*at*U\"","|","OKnq="],"5 5K#IG":[[{"&B!<CJ":-2.1737473224242223e+21,"/fz=":true,"6uNCV.":true},null,"",-5.96857506588026e+172,null,true,null,"b'+,","Irn6"],{"":false,"%3&IF=T3%s":false,"7')uvAzV!":true,"9L&A5s]*P":false,"A&r%w":6.447133717686609e-99,"DMb30":4.7186679574797753e-57,"PgT":false,"UMj(Ft":-1489625250447530,"Z":false,"oUY`1*?0X":true}],"5q":{"37<5":1543901466163255,"3>&*i:":{"":1.0382984169616324e+71,")id%z":true,",j":-8530449672106299,"4":1.0150704763837666e-96,"4Lo":4.177378433852844e-186,"7l>sx,<#r":-8970198208756490,"T7vhU":"yhlEZ$b;9+"},"PE":867145486586113,"a}jt":null,"l[ VvkII?":-1.564329780494935e-242,"wS}*":4908073171731159},"?h":"A7857Xa","fYoT] B":"iHM)Oy!:M","j\\hY":{"/.0":false,"Gc#47":-8990048556610885,"HJGt?w":4561939179294837,"Hd;1}":"d%QXg$Lzn","m O/U5[\"d":"J2^-OS","n!rcF\\,<O":[null,1.6756481634028258e-79,-3.827365210549809e+300,1079272711529499,"h1/rZ)22",7.438044803743661e-95,"UiF*K4]Ud"],"}%":2.3279528138494636e+195},"k0m &|{":{"API3Uj(N":["PKa vrf$l",8.423498732027486e-56,"OBg.kxIB",-3.15199329593801e-65,false,-5956715608434005]},"level":"info","message":"o:!U","timestamp":"2026-02-04 17:49:28:4928","|$-":[true,"",true,-631017230.6750661,false,-170153626920085,null,-8544464074063537,{"":-1.258794759091643e-44,"&fKx":true,"M\"":"rha1iF","RBu]1E{":true,"^H?0$J":-4.6227979418929474e-285,"e5":false,"kWJ!WY,#q":null,"pG":-1.3269270908647032e+113,"~VQ":true}]}
{"jL&.o:X7":false,"level":"info","message":"|","timestamp":"2026-02-04 17:49:28:4928"}
{"#Jb":[5.906281386303502e+264,620199534151697,false,-146797.52673619436,-7219575474252981,false,false,null,-6078162312000917,null],"F+\\2zks#v":true,"L-":[-7080685140815358,3.1039656734042305e-90,[-4.4501184142014824e+133,"G",7.153902998266277e+158,"5rnqZkq@(",2.4353753193959758e-170,5549312241812585,false,-1.4574736125252969e-164],false,true,[-3.1552684057680394e+34,"5Ak%",-5325354573124256,"TxE",-2.4265228916130865e+183,false],true],"SCBwv+":7.732106095720692e-97,"cL}FGHR":-3862746141396554,"level":"info","message":"OEfi.","timestamp":"2026-02-04 17:49:28:4928"}
{"":["-PEP5k",null,-3.2863145603872762e+302,-9.472378675576143e-193,false,"m^@BX",false,-4277091657271105],"e":"PM-tW","level":"info","message":"W/Pf","timestamp":"2026-02-04 17:49:28:4928"}
PASS src/__tests__/unit/routes/onboarding.test.ts (11.414 s)
  Onboarding Routes
    POST /onboarding/register
      竏・should register a new developer successfully (240 ms)
      竏・should register with testMode explicitly set to false (17 ms)
      竏・should register with testMode explicitly set to true (50 ms)
      竏・should return 400 when email is missing (9 ms)
      竏・should return 400 when email is not a string (138 ms)
      竏・should return 400 when email is null (13 ms)
      竏・should return 400 when email is empty string (13 ms)
      竏・should return 400 for invalid email format - missing @ (10 ms)
      竏・should return 400 for invalid email format - missing domain (430 ms)
      竏・should return 400 for invalid email format - missing username (309 ms)
      竏・should return 400 for invalid email format - with spaces (55 ms)
      竏・should return 409 when email is already registered (368 ms)
      竏・should return 500 for internal server errors (484 ms)
      竏・should return 500 for non-Error exceptions (137 ms)
    GET /onboarding/status
      竏・should return onboarding status successfully (630 ms)
      竏・should return fully completed onboarding status (90 ms)
      竏・should return 401 when API key is missing (227 ms)
      竏・should return 401 when API key is invalid (13 ms)
      竏・should return 404 when developer is not found (108 ms)
      竏・should return 500 for internal server errors (227 ms)
    GET /onboarding/me
      竏・should return current developer info successfully (53 ms)
      竏・should return stripeConnected false when no stripeAccountId (57 ms)
      竏・should return webhookConfigured false when no webhookSecret (40 ms)
      竏・should return 401 when API key is missing (77 ms)
    POST /onboarding/api-key/regenerate
      竏・should regenerate API key successfully (52 ms)
      竏・should return 401 when API key is missing (44 ms)
      竏・should return 500 for internal server errors (55 ms)
    POST /onboarding/mode
      竏・should switch to test mode successfully (44 ms)
      竏・should switch to live mode successfully (40 ms)
      竏・should return 400 when testMode is not provided (46 ms)
      竏・should return 400 when testMode is not a boolean - string (59 ms)
      竏・should return 400 when testMode is not a boolean - number (132 ms)
      竏・should return 400 when testMode is null (18 ms)
      竏・should return 401 when API key is missing (20 ms)
      竏・should return 404 when developer is not found (7 ms)
      竏・should return 500 for internal server errors (18 ms)
    POST /onboarding/webhook-secret
      竏・should set webhook secret successfully (13 ms)
      竏・should return 400 when webhookSecret is missing (10 ms)
      竏・should return 400 when webhookSecret is not a string (7 ms)
      竏・should return 400 when webhookSecret is null (7 ms)
      竏・should return 400 when webhookSecret is empty string (8 ms)
      竏・should return 401 when API key is missing (8 ms)
      竏・should return 404 when developer is not found (191 ms)
      竏・should return 500 for internal server errors (107 ms)
    POST /onboarding/stripe/connect
      竏・should connect Stripe account successfully (19 ms)
      竏・should return 400 when stripeAccountId is missing (10 ms)
      竏・should return 400 when stripeAccountId is not a string (8 ms)
      竏・should return 400 when stripeAccountId is null (61 ms)
      竏・should return 400 when stripeAccountId is empty string (70 ms)
      竏・should return 400 when stripeAccountId has invalid format - missing acct_ prefix (85 ms)
      竏・should return 400 when stripeAccountId has invalid format - just acct_ (37 ms)
      竏・should accept valid stripeAccountId starting with acct_ (9 ms)
      竏・should return 401 when API key is missing (10 ms)
      竏・should return 404 when developer is not found (44 ms)
      竏・should return 500 for internal server errors (9 ms)
    DELETE /onboarding/account
      竏・should delete account successfully when email matches (13 ms)
      竏・should return 400 when confirmEmail does not match (11 ms)
      竏・should return 400 when confirmEmail is missing (30 ms)
      竏・should return 400 when confirmEmail is null (14 ms)
      竏・should return 400 when confirmEmail case does not match (56 ms)
      竏・should return 401 when API key is missing (9 ms)
      竏・should return 404 when developer is not found (delete returns false) (13 ms)
      竏・should return 500 for internal server errors (185 ms)
    GET /onboarding/quick-start
      竏・should return quick-start guide successfully (252 ms)
      竏・should include proper code snippets (20 ms)
      竏・should return 401 when API key is missing (12 ms)
      竏・should return 500 for internal server errors (13 ms)
    Edge Cases
      竏・should handle concurrent registration attempts (113 ms)
      竏・should handle special characters in email (367 ms)
      竏・should handle very long webhook secret (183 ms)
    Response Format
      竏・should return correct Content-Type header for success responses (103 ms)
      竏・should return correct Content-Type header for error responses (207 ms)
      竏・should return ISO 8601 formatted dates in registration response (129 ms)
      竏・should return ISO 8601 formatted dates in /me response (57 ms)

{"":[-609140694232.5297],"#Tv,aq)":"$P8","4;QJI.WcMd":[false,"!K[R8P",2.920249274247802e-297,"VRgcxw",false,-2.4804781118186906e-129],"HHN":{"":-6.859243929552141e-155,"1.$Dic+/":4.5861986889119544e-156,"1\\}":"Es;U8^-*mA","2+5&2I":true,"9DAQ(Z":4377761442891573,"St":"j<m7>ZD","U5":true,"j,nag7":-1247347587063059,"w&b#b|dJ5":false,"yN'Ad|geU6":-2735719514056074},"VI%h":[],"Zi`":{"":null,"0O[;m":-3254600018957901,"<A{!":[true,4001579615588515,3074139880744717,"gNHX}L%",-3.3082323451416697e+193],"H8M":"9nf?#ei9W","Ik8ds":":n","ZEvyZ<*lN6":1.6823664634825782e-180,"[IFnxL5Oed":"W"},"level":"info","message":"h58","timestamp":"2026-02-04 17:49:28:4928"}
PASS src/__tests__/unit/routes/coupons.test.ts (11.361 s)
  Coupons Routes
    POST /coupons
      竏・should create a coupon successfully with minimal payload (1063 ms)
      竏・should create a coupon with all optional fields (697 ms)
      竏・should return 400 for validation errors - missing required code (567 ms)
      竏・should return 400 for validation errors - invalid discount_type (198 ms)
      竏・should return 400 for validation errors - code too short (78 ms)
      竏・should return 401 when API key is missing (80 ms)
      竏・should return 409 when coupon code already exists (209 ms)
      竏・should return 400 when invalid product ID format in applies_to_products (223 ms)
      竏・should return 400 when product ID does not exist (943 ms)
      竏・should return 500 for internal server errors (55 ms)
    GET /coupons
      竏・should list coupons successfully (17 ms)
      竏・should list coupons with pagination (32 ms)
      竏・should filter active coupons only (21 ms)
      竏・should return 401 when API key is missing (8 ms)
      竏・should return 500 for internal server errors (195 ms)
    GET /coupons/:id
      竏・should retrieve a coupon successfully (34 ms)
      竏・should return 404 when coupon is not found (18 ms)
      竏・should return 404 when coupon belongs to different developer (15 ms)
      竏・should return 400 for invalid coupon ID format (77 ms)
      竏・should return 500 for internal server errors (10 ms)
    PUT /coupons/:id
      竏・should update a coupon successfully (14 ms)
      竏・should update coupon active status (9 ms)
      竏・should return 404 when coupon is not found (8 ms)
      竏・should return 404 when coupon belongs to different developer (10 ms)
      竏・should return 400 for invalid coupon ID format (11 ms)
      竏・should return 500 for internal server errors (23 ms)
    POST /coupons/:id/deactivate
      竏・should deactivate a coupon successfully (24 ms)
      竏・should return 404 when coupon is not found (9 ms)
      竏・should return 404 when coupon belongs to different developer (8 ms)
      竏・should return 400 for invalid coupon ID format (41 ms)
      竏・should return 500 for internal server errors (16 ms)
    DELETE /coupons/:id
      竏・should delete a coupon successfully (13 ms)
      竏・should return 404 when coupon is not found (10 ms)
      竏・should return 404 when coupon belongs to different developer (54 ms)
      竏・should return 409 when coupon has existing redemptions (31 ms)
      竏・should return 400 for invalid coupon ID format (11 ms)
      竏・should return 500 for internal server errors (31 ms)
    POST /coupons/validate
      竏・should validate a coupon successfully (33 ms)
      竏・should validate coupon without product_id and amount (43 ms)
      竏・should return 400 when coupon is not found (10 ms)
      竏・should return 400 when coupon is inactive (12 ms)
      竏・should return 400 when coupon is expired (52 ms)
      竏・should return 400 when coupon has reached max redemptions (359 ms)
      竏・should return 400 when minimum purchase not met (36 ms)
      竏・should return 400 when coupon does not apply to product (11 ms)
      竏・should return 400 for validation errors - code too short (9 ms)
      竏・should return 500 for internal server errors (8 ms)
    GET /coupons/code/:code
      竏・should retrieve a coupon by code successfully (16 ms)
      竏・should return coupon without expiration date (10 ms)
      竏・should return 404 when coupon is not found (8 ms)
      竏・should return 404 when coupon is inactive (8 ms)
      竏・should return 400 when coupon is expired (28 ms)
      竏・should return 400 for code too short (10 ms)
      竏・should return 500 for internal server errors (298 ms)
    Edge Cases
      竏・should handle coupon with null metadata (304 ms)
      竏・should handle coupon codes being converted to uppercase (145 ms)
      竏・should handle fixed_amount discount type with currency (207 ms)
      竏・should return empty list when no coupons exist (53 ms)
    Response Format
      竏・should return correct Content-Type header (357 ms)
      竏・should return ISO 8601 formatted dates (64 ms)

{"\"y!ns":4.624366186839508e-129,",2=43TC":{"#2E4U\"s":1.9144607215134697e-226,"%X":true,"LF'\"(":2434576193156933,"N3VSG1#VVW":"\"!}FU<:","jCYD>:":[true,false,-2.7959365996316595e-217,-2328718340846061,true,-2.827082200280719e+47,false,9.792607249437793e+37,null,208794999785833],"w@":5902330680254889,"x":true},"@|y4&X#!!":["Nlw",[false,null,"zU/2R:2(",{"'2`_Vc]e":-1.2345521636424206e-53,"1n`n:COr|":7.336692698392048e-190,"7&l|V":-1.2294477429871818e+35,">l+":6.65844673507465e+264,"Avqb\"x0&9r":null,"\\3":true,"mz10eiC03":[-6218114941333122,false,true,-2.991541810482524e-121,"|#=_"],"o":"2","o5-!Z<":-2.4140024675410693e+159,"pct~PddM":1.7490382671683588e-12},false,"~S.1d*1",false],null,"x"],"M6cc":-38,"P#%)P":[],"level":"info","message":"n\"\"","p6_GB":{"J?aYxjcV":["",true,null,"F${P",true,"(Lx",false]},"timestamp":"2026-02-04 17:49:28:4928","uMz/<":{"":null,"6":-4224583454819107,"8RJt!km":"","?jSVh<nAq":true,"[Yb":"AF9Ww=(T","y":"Y;","|i2}RZw":"h0"},"~":{"u6'[.]&@":true}}
{"":{"":-3.096871651936971e-263,"\"7 U~":2.2877175946236435e-285,"U1.":1.611798471310791e+169,"dP.":false,"gW}":5308889315936977,"l6nG":"FBr\\I","{rvr9|5O2":-7.022758427284829e+26},"\"4cg#[4EE":"]kt39oJ","5g@YPHQ_x":null,"],@@=":-6.805835900443558e-248,"j|5-3Pm":{",":7809399293776535,".8,":-1.4500911322429537e+275,"N^IMH":-1.2688787522596907e-247,"R1Uk)h<":"?","U>^g_":4045401212950899,"p ^iItz":4.065884460135627e-149,"wpHgaouei":7296003468529681},"level":"info","message":"LV(x,\"","timestamp":"2026-02-04 17:49:28:4928","zoBagZ4":[{"#GhiLyH":false,"7":-1.7861772267284032e+166,":AW":-9.389297059300381e+268,"EL[":"zN{p0"},["*",7747082206767705,null,false,-3.063615994434205e+273]]}
{"FHS":-1.360074497769002e+111,"level":"info","message":"_rj806","timestamp":"2026-02-04 17:49:28:4928"}
{"H{s`":["+ik*9)",{"3[":-7.801305404209988e+282,"<[*L].U?r":"ve8%u#*[iF","@1O":-2.096573654663271e+199,"Bi":null,"C":"dXcY<","TUo7Y":8850648075503871,"y`f":-1.2400144787694115e-277},[true,7.9516933536991715e+295,-3.658995694002351e-166,true,true,false,-1.2355313095600591e-29,"n"],[-4707980022861877]],"T2`5KMo ":5697760634107045,"]zNKsn7M":[-1.5363949121971014e+28,true,"+`0ATq1:6~",null,-6.063369118811872e+166,40.83304194050694,null],"level":"info","message":"g4|","timestamp":"2026-02-04 17:49:28:4928"}
{"level":"info","message":"!#","timestamp":"2026-02-04 17:49:28:4928"}
{"level":"info","message":"=b-","timestamp":"2026-02-04 17:49:28:4928"}
{"LOHl":[5.509579917564498e-125,true,false,null,-2.6358947714724873e+283,true,null,"yJE8x[-",9.765667419946895e+40,""],"level":"info","message":"\\","oVcN,4":[-1692904427134030,["r",-2768797287312656],[4.09037953351616e+186,-1.7620228061553267e-245,1708236226155657,6.04288886215515e+60,true,-2906811971782682,[null]]],"timestamp":"2026-02-04 17:49:28:4928"}
{"level":"info","message":"C}\"#U|","timestamp":"2026-02-04 17:49:28:4928"}
{"":[827405636344805,-3272645333258085,null,null,2.0587659290402417e+130,"ho~]_",null,[172637.68236057344,{"v":7483384061756257},"VWHUX}Vv|"],6.948268910606375e+141],"#3k<L!":{"":"%\\^i|o ","$s\"%Ezd 2":false,";j]":7635172956048873,"KP,S":"T","NN`/r[M":"G;44<c4e","_AcLY":true,"jNN!":3.8595094559716893e-218,"wX":-8.147480048429934e+183},"&j.":{"":"D1J?"," i:":true,"!\"j3uvFz\\":-3.348204504260437e+106,"(;N,ME":1782180633254813,"BOZFjAAkM":false,"M,+> ":3150761752224997,"^dwd":"1Ol `@LL6c","jHBy*V<NqE":3104373358820341,"m5=.X=":-2177721294723399},")-]A7":{":a":[false,4.526333911164471e+231,778073132023717,4435032737964193,5.948342721213166e+40,true,false,"?a.R=xL"],"b?6":{"(|x:~\"[[":false,"YI/;,":2111258043537485}},")f(v":null,"+.w":[null,-6.8879040055783795e-99,{"Uo5n+(!":6.909435600092134e-271,"X1cp`048R":-2.1581419506685085e-278,"xOhLP{zA!":"AJ=]s#Ix"}],">A*XY'7*O":{"":"M","A,|":false,"PfU:V3X}":"L{f1O","ZL5pcE":3.892535639116916e-140,"[7%\"-(2bl$":null,"\\`\"":"A-N$W:l7S","_NXumKCaC":null,"azUEeV97":true,"l":-4538064568513937,"}`R]ne8I":""},"VI":[null,false,true,-4576323871422582,null,null,null,-7268909916697661,false],"hHKvx*D(":[false,3942335814876141,"eS[K;Oj>_",false,2.6604407402276757e+131,"CQMnh",-5999926821870395,"Am4~tNFs","2`",null],"level":"info","m'ZR":"vn","message":" ^","timestamp":"2026-02-04 17:49:28:4928"}
{"":{" =;":"g3`zcmUb<","&":"DXbsl$Kg","*>y%aTY":{"d\\xg":false},"BLC}<h\\'":null,"Q&q(":-5832326.926859781,"T]m~d":7.632195156266397e+282,"mgtN=":false,"wE`i>'UR6n":-8.331720050965761e+141},",\\m|":{"ML=#oDCM[*":"3TU","cL{BI>Q":{"":"m>S!-~q6"," LP,vE}Y/":"TzLQls","%7b":"]({n","03AV$3^N":-2783309214367431,"<%zpaEy":null,"ZA_W~;S9":false,"^3m0ru;":false,"d39fs[z":-6.848097757434392e+239,"ic":false,"x~{AH.|;0v":2932853085275499},"fT+&3":-4062812738677460,"vhiv=":true},"U":"9k$;!","Xme$J&^":-1.797693134862304e+308,"Y@ABK+[t":",R","level":"info","message":".L$","s1u.":[false,"",-1.7976931348623111e+308,null],"timestamp":"2026-02-04 17:49:28:4928"}
{"":[-4.487306033246346e-7,null,{"":true,"8\\<+4T":4.3534821085271324e+77,"8x":8775444861734989,"=^\\<'RJ":-3146255473414967,"EJH4":"MHRb!G}","IX>0":false,"PN\\84s":414500959993489,"uw(JYxl|B":2.8868317750582915e+102,"ycTF_]":"(W<RNixCp"},3426231949433607,-2.1638894789987896e-174,711142496055949,null,"","%5|CzN$b"],"\"$$}5-t&":true,"&&Mw":4843103407002233,"+iz3,":2814946494973737,"-d54\"Xa=A?":5.60956550030696e+71,".":"N ","PygQ2%bl":[1.2816313616055147e+304,true,-1.1588218960989465e-290,["Wp|OdUv",-2.0039380582760726e-33],")]pm.pgO`>"],"aGsZOv-*":-1402899639811722,"eTU?9A":[],"level":"info","message":"rBG4B`!","timestamp":"2026-02-04 17:49:28:4928"}
{"level":"info","message":"LbI._Fc","timestamp":"2026-02-04 17:49:28:4928"}
{" D&~?":{"':`Yh":{"":"(Zl@{d","-H14_].Xd8":"_R+*n","7K":false,"K|,":2516614253330757,"Q;JH":"52h7{","R$$I}18y@2":-7.793192617627945e+294,"rm_2:b":false,"}? Mw.i/8":false},".7}r%>'V*v":{"":false,"!.V]8":4589889105546005,"'&qB":"v~<","@,":true,"UM}B\"so":"c.@","nIzBK/":true,"w5LTuh>":-4.6864462822024756e-122}},"09dI":{"!;0vL6":["dRtf%n8",[3766247164916605,5609704593893261,-6.842442569230323e+46,16012269240.930721,null,"#BN`1",2.218803692948413e+82,2.0813521521403078,1.480641523860845e-245,""],"6IX\\n",3667588885352837,3877519554217901,false,"B1m%2x6wT"],"0UM":[null,-1.4982064708307034e-285,1.948494255409627e+157,-4334803194057763,true,false,-7132139097119301,false,"}aN*=W3{"],"y;,Hn1/%X":false},"1,Lq[\\_":9.897301702477178e-295,"3ClTmf`k":{"~!}WC.":7664016168199483},">M`4":[null,-3835800433472507,null,true,"|,!8",true],"@Z\"N:s<=Y":[[7237368125294989,-7511084290653701,",\" w","iz7}l(2B"],null,-6.997708262304259e+297,[null,2.3982618217851477e-65,"#iCB^1cP",true],4293533507073253],"A/S":["'^}*w #y}T",false,"'xN]]pIkg","",true,true],"WQ":null,"b":{"'":"","-RC3":3287316629674173,"S}B":8738169731086169,"mL\\:":false},"level":"info","message":"%E/KOJ","timestamp":"2026-02-04 17:49:28:4928","xyE":{"":5173792633969105,"- >":-982914286781218,"/":true,"4RFe@2":"uxl","K>yK":"Znk`","kz3":-3.603804879072598e-106,"n7G]1,":"+{1iG","|b`_":8679116049090809}}
{"":["p2!} Da","*pB3H=v|}z",false,null,-7610565028951019,false,true,1.1762957677551312e+214,2771109918117865,-961446996981759],"\"q!VJ6$7}8":false,"*":-1.010499817212729e-119,"7\\k/kqF":{"/&[c`@":"8\"'#(YH","3":-3801620761117332,"D":-7.996013037786837e+72,"DxkeC2":[null,"W4uX{tO",-1.4088422136266167e+241,false,false,"\\"],"FGKZlJ":2897805372135273,"hh7*IDP}<":4.700310399152352e-151,"l9g":"","v,":true},"[hDZpWV":["%B(3^",null,{")":true,"Aq#7":false,"C<%/[":null,"d%-TG%?":"i{<!","eyT=flT<":3232647650274249,"rClaIVS":-8109805125750926},-1.0445770990720609e-284],"f":{"au|M&5z|":{"":"+>x3K","$)ehP`Oc|":false,"&A+PE0<V|":"c&stiGRO3\"","1f9]O":5872462798135637,"D8h'":[true,-5967898206270103,2394518983162659,true,true,-5531698468954345,null,true],"hB!x&d:{uQ":1332452402243181}},"level":"info","message":"x\"udG","nyv\"":[[true,-6452054470021708,"QP1T+7i"]],"q~r0":[],"timestamp":"2026-02-04 17:49:28:4928"}
{"level":"info","message":"9KRBDX{","timestamp":"2026-02-04 17:49:28:4928"}
{"TAX\\,Zu_'1":{"":-1.1592335572181426e+61,"7!9T7kSi":"~}","IB!xz{,":-9.246360200555332e-222,"TB":2.945692755329384e-161,"W&n>hWm|":-9.999266074331598e+138,"gH4":true,"q+^/g4;":"~(lvfPk","q[#xrqWc":true,"vRXT8":2.9660066244962577e-66,"ww/YkxN1":"\\"},"level":"info","message":"6(PSlvb","timestamp":"2026-02-04 17:49:28:4928"}
{"":[{"r9":1.6103474137490427e-229}],"\"OTQo":{},"#,k#OJ'Zyo":[false,4196218496129377,"4bKc$+\"o}l",null,-8701075880019956,-9.812743552912513e-289,-1.1659898109133859e-144],"F!WQ$":{"":false,"3Eut}":-5262929886904528,"EP":"%._F]","Pmr00t^":"Q\\si;","d=Se_+Ghtp":6748196927146777,"wGzY;+W":-469.06824586585583},"H=AH`s":[7.906689933903091e+299,-8.664648481498327e+68,38408598253167,-1.2317882045905425e+172,true,"Sc",false],"Vo4WjHU6G8":["6O",3034901346352749,null,"foeXF,[",null],"_*rH~GaD<":[3357293988453115,true,5498095777129261,false,-1.5492004226548039e-260,"%MMS~DZJUK"],"cAZsB#":{"":"u\"?+p43","Fr(8F7*;&d":null,"PSgQ~":false,"dZ}=*o:Iu":"ZSN\\,)'B","m{@R:#":null,"{VQ}*W(>#":true},"level":"info","message":"key","timestamp":"2026-02-04 17:49:28:4928","~p_,{":"yX\\V-%L"}
{"":["O1*HuvA",1438833712940809,-4.514297952852208e+21,5.813249236376604e-109,null,-6.110310975410459e-142,{},"gb",{"":false,"'Ri<{wd":true,"@:sA*5|":4898901792917133,"K(KrV!&Is":false,"L=5+0w4[M":4921098041214893,"m+ea":1.0160578164052496e-79,"msNA":-2.096152157746397e+286,"nN},\\j":null}],"'{.#-2":[[2.3545350131181824e+34,[],true],1.8932187068707318e-174,false,6.389890350085537e-109,"%yTce","S%:/"],"^tms@u(86d":"F NW,","j":[{"$ S`x":[null,3.1916710764230147e+153,4.145994770524406e+206,"Rwf91w<@",-2633273266146241,"",8139970909342273,4.65510018827826e-22,-1793188687686403],"&2YD":[3.265268407284852e-166,4603688996569857,null,true,2.7991351790556006e+235],"_cBeUm ":["Xg:",false,null,true,2870125193665811,false,null]},[[2.5042363757642345e-177,-1.1305229453787342e-12,1.9461346470182956e+236,"PoPC(u",3.444932856889743e+122,-1.0279828115689911e-215,3.220590383652729e-195,"R5z?j",true],true,1.124997168320973e+193,{"^#d%wQn\"":"LLoT56?GyM","j9E":"7KB,dt{","|":6.651853936339043e-298},[]],[-9.814203789836625e+153,"Wu]wE-j",[-8.117105031489589e+33,"\"",false,"$%I\"@ 5?n~"],null,"dR`ms\"]",false,true]],"level":"info","message":"2S","n[{V":[false,true,false,null,"np",6358243432528725,5585306623466167],"timestamp":"2026-02-04 17:49:28:4928"}
{"level":"info","message":" ir","timestamp":"2026-02-04 17:49:29:4929"}
{"":{" 7":true,"894A\"":"i X,XiyPw","@sW1":{"":false,"#)B8#v&V":2.137726052227144e+165,"5]l":"IzpYFH","@~o>NHb^\"q":true,"A!;":false,"OD6ar8P":false,"SUafs":"5A`xwV5\\i","be#-4B'":true,"k;":-2325842228020821,"}nIE;":-4.54569540446662e-97},"O7aNCi$aA":-1.98982460683091e+222,"e]l":1.8990771524506784e-302},")":{"%mkey__l":[-493.1332469965451,"o7S6m",7437709292012813,-8519025994126320,6586359520019989,8483003183839435,null,true],".#OsL":-1e-322,"<8i":3.862819414091475e+215},",":{"":1.4477509436607907e-115,";1JXz+[5V~":null,"EL|":true,"XL_8%b;P]`":[-2950999556300392,4.70581090051416e+220,6.395695155455689e-196,false,false],"[":-3.9204290173203055e+280,"h":3.916833843217945e-29,"h,":"'[DQ_358","slQJmVRv:":"x*W<qcGLL","|sqB;D":2092111340133737},"2Kf6]+":{"V&K2K.!e":{"":true,"VC}W":"-[8&U%/f["},"lu)udJ":8837603604557045},"8":"\"ihV","EtuemN#/":true,"Rz":[[true,""],[-5954301335121449,null,"XyNu",1.556563852009562e-138],[[")."],-6764067681716796]],"fVA(aoD":[9.68937020795775e-308],"level":"info","message":".*_@I6zZ","timestamp":"2026-02-04 17:49:29:4929"}
{"Bs_.":2.561554194417975e-44,"IY:9Hn":"vF4^E","level":"info","m?g86w-j9L":{")7-<\\%":[{},false,true,-3043505375790526,{"":-1324208504811235,"=;w+yH7M!$":3401037796597635,"ug5":"DD~[48E6li"}],"iys>7{":3.393359422892758e-58,"x^0[;xu]tg":6266902844861777},"message":"Zw?x@8","timestamp":"2026-02-04 17:49:29:4929"}
{"+9o:]ey":{"":true,"%4g":6.135437421457909e-176,"B32G ;'6r":-2373935542818474,"IHg":true,"S!+~5^argu":"cn","f}#Protot":false,"toString":{"3+iP":"(V1m_|f2","?":-1662179845908697,"V\\7l_c":4.555040305002247e-66,"_0":"","tAIq":-2.3587554772180897e-141,"vhk_(cB(":",?Xh5e\"aG"}},"apply":[true,-6988832120823726],"level":"info","message":"K","timestamp":"2026-02-04 17:49:29:4929"}
{":^x":[],"level":"info","message":"m={'","oVWL+*>!":null,"timestamp":"2026-02-04 17:49:29:4929"}
{"P":true,"\\yR](ccdR":false,"level":"info","message":"%xz2W`)[%$","timestamp":"2026-02-04 17:49:29:4929"}
{"\"{pz}":"liC","L{+k,p":5828861944338301,"R\\,]Ah4)vj":[],"level":"info","message":"q7","timestamp":"2026-02-04 17:49:29:4929"}
{"*m":false,"X(":{"(nXb5OEx0":"Z1/Ix","?/v@nV":2.0782705590049422e+64,"V;!ln":"c*?=Y!","_1MDZsN_s":-2871330886802160,"b5wtg)Y":8464800752347057,"mU":":&SiceC","ng9}":-4.3432403110525246e+274,"}C\\z'v":true},"c~IOA%x":false,"level":"info","message":"|","timestamp":"2026-02-04 17:49:29:4929"}
{"":["\"16ES",{"":"_Qi%P(7OJ~","2cYHHH2,8'":"?r\"O;s;Ss","WV{+yP?4F":true,"m)Z":null,"oE@Ic0EuY":null},-1511358954578143,1687262431174391,"o%\"iWE%"],"%!)s>/":[],";NG":[[-2282507769469266,"Nj!:MXs&",1735378469.917754,"",null,false,true,true]],"Br;}":{"":null,"&oii<oLjI":true,"HB@F":"","P6N(0>eHW?":-8.488765791642709e+21},"Ju^SV@5Uu":[5628950238717871,false,false,{"E_j7A":{"+1b*yx|)s":[false,1.8302681766072005e+78,null,-4773459971925462,28809863530827,true,"<`vN",-321984050846847,-4.754928230304141e-267],",/$a_g>ht^":true},"H":true,"ibu":3.3281560728212745e+85,"s":"i,rce#'2<","{\\,Lmzn":"oBo|"}],"level":"info","message":"vF~","timestamp":"2026-02-04 17:49:29:4929"}
{"":true,"\"bdnd!":[{"K<I":-1.8294332031984586e+93,"~@gN<rW3#i":true},2.8081071472601655e-195],"$_&6[ty#.q":true,"1&)m5rWD;{":[{}],"H!.-#rq":[false,null,false,4575248064442499,1.1325683371843167e+88,null,6054395436770205,null,"PYl_"],"Z":[{"&[W":["",true,-3.356752854441185e+252,"nr[gO0mhH6","",null,null,-5.3608172815493415e+41,"Cy*!WdW`0",false],"0T7OHi!":[null,true,1.8599186261629404e-59,"d<|x-a",1851664199999421],"q)":2.4264217657070423e-253}],"aQr> [QO-":8543018388695409,"k<":{"+ca0,":[false,false,-2656550462439961,1.316984580544008e-108,-4660970050454572,3.886421237255539e+160,7375313351613069,true,7935145589556299],"|D?!.":7.321065446028883e+281},"level":"info","message":"! tb[H'}","rH@fK":3204137535264367,"timestamp":"2026-02-04 17:49:29:4929"}
{"7k":true,"G":["","",1.072409455320048e-227,-7107190928345171,null,"_NuU~ua?}",-1.4237317667872491e+186,-1078704434128864],"`":{"":[-7361592869441883,1.0119796202954246e-170],"2SXu 4d5>-":[true,-8.300066693926496e+298,-804699610779842,-4.339521852758082e-275,"P2-!}*",-9.284648927379968e-265],":|3\"1#1;":false,"B":false,"fP":{")kTUteR":false,"=BOY1p":false,"fAv":1450955444506669},"~e#z":"."},"level":"info","message":"q","timestamp":"2026-02-04 17:49:29:4929"}
{"level":"info","message":"e?KTf[]","timestamp":"2026-02-04 17:49:29:4929"}
{"":{"":"F;g","?":"fMA90,ZL","Es8;Dd^hb":null,"^zft2NF\"":-3225110605110304},"!<<":-938215089719267,";iCl=e274":true,"GmUI- :v$V":[[-1939047574717093,null,null,false,1638732561324401,{" 2 K-s8[P1":"Dz2tzu1","NPN-\"":null,"}":"?si2`7","~rhKT":null},1.1209482330644231e+203,false,false],true,["","j5:*=",{";yCV`":"WkEj)*"},-1.416130700922768e+157]],"`Kzf":[-8826984875534336,"Y",-6688841694919893,-2022321275458615,false,"m^>h"],"dx(":-4.4499298008713184e+232,"eN":[-2.5429192084488798e+137,[14547557409081.502,true,".Gp,BF0","b+03(8"],{")K":"jQ^6gHgn","6/i.":-4.5307468365922787e+213,">>q^<xt":-2922056994109622.5,"al=:F# ":2883760981836397,"|hh<X":true},true,"]MBs53xE<7"],"kX/8#+<@":true,"level":"info","message":"j$S","ofJ(":{".W({":"Q]","B6.2Q`'":-3.057506871869787e+268,"Q?Ny":null,"VE%VW":"","i":[null,{"@,E":";$qy( D1/0"},null],"p":false},"timestamp":"2026-02-04 17:49:29:4929"}
{"":{},"-,":-5491378113611670,"DPqrRy":[null,-1.8166691856842518e-261,1.6513896403598195e-220,"VrCPwSKey",-1.3316185098755042e+177,-2.981423488883282e-75,-2270220192442221,6122159639287565,-6894715978576219,-4.780675041299715e-251],"Yqg=A`y_":{"#l.vWF":82812599475305,")UJ^":1.014638143895385e-154,"3a]=\"T%":-1025174126380903,"~":{")bpAg#":"NP'Jw+","O-J8LTd":{},"_LrH\"A":5950469122175317,"g":null}},"g":{"$W`6":-5119802070612518,"6nv,fc8)":{"=LKb#'":8399794813353243,"mXV1}Kgs":" "},"[K.y~OLlMM":"|?D8YA","s}\\G<zzr":-2.2811111406241547e+150,"|iU9\"*":[-2734622592932734,null,-4.266409636635213e+84,-7.745649333601789e+193,5.417663602322996e+97,""]},"length":960672636968785,"level":"info","message":";i[,4z","t":{},"timestamp":"2026-02-04 17:49:29:4929","yHO_./\"'":[4981576469238783,"Dh"]}
{"":true," Sl":{"#rJCY":-6.645564488028559e-104,"4J@`I]Q(d":{"":"",",":7.624080981947165e-181,";#LakrsAq":null,"Jfh":2.088256539805114e-298,"Z@-92u$":-2.6069692970099365e+125,"aj%;h4K":"af9&B4Dt","m":-2931879753286037,"m8ed":570518517605023,"tdV":false},">{dP91-":-51,"P":false,"R&P":2517265685722403,"R*jQxd":false},"Dm&U1$<yYk":false,"level":"info","message":"3pnzt","s__":[],"timestamp":"2026-02-04 17:49:29:4929","{eEWtKX]/j":{"":{"":6.828129472914658e+218,"&)n":244160691723661,"-w]EKn+e~":-1.9819453351518615e+149,"5Ff?qtl":5.766996968165578e+79,"m":-1396467983087332,"w_T2^M7]4":false,"yyfLw-tb":7.319810926162411e-19,"z$@":".nO.3","~zj>":false},"2p\"[z>":false,"B+g^OPsm,`":"","jzF@":[false,"\\","sKbl",-3897830639165370,false,1786423283095777,1.5494164121686727e-20,8821265050864313,"y_W"],"oY-ziN8,}":"& o","wU":null},"})":{"6,@7_c\\":true,"8'":"ZRs[Ri","<(":1.1525114311424377e-9,">Bnh2RI9":3887435995696773,"M}K@rQ`Ca":-8246300048764256,"XCQStv_+Qa":"0-NtNKK\"#D","s8EBP>\"":false,"u":-6.892137566536804e+89,"xg=kS":1.5145954813715652e+66,"}n]-FoV":"."}}
{"gj7Mk`":{";":true,"gf":[-7718382877103074,-2.112445872788172e-237,"u 6LHC7",true,null,false,"CA}@!j9TC",5987192183402663,"",-4983661297595040],"o[":{"":"","em":["EyP&",-1.4682993655865284e+267,3.3450267739031035e+96,1394971727502629,false],"p!l6^.Kt]+":{"!?/XNX}@|9":-8.86397624142018e+209,"+[Fhkb[_":"3Pev#e|","1I={o_f":-4338713025712958,"7!V'VEi*a":-2.68594495054473e-109,"<NX kLnb":"52Ju","DLxJU:ys':":"","^k6uxo":false,"`-R":2.788878994268592e-58,"l2q":true}}},"level":"info","message":"4,@,p\\","t":true,"timestamp":"2026-02-04 17:49:29:4929","y|<}:}X$":[],"|`dr":{"(-":"Ay~KLaTG",",w8)sS(XYv":true,"0~F":-4.2571915968450963e+304,"K":7012508554958359,"Qjkt":false,"cz9\\2dz":-8253788224285114,"lKYmB/FW":2.848628356693523e-289,"m`I>C*_\"+":1.5473341101774798e+33}}
{"":{"(a[$m4vT":true,"=,tINH":-8.671805277154764e-109,"PfBjwiDh":"aO}a.","SU&":["",4.334130381927632e+267,[2423012857648297],"!",-4762487717152229,false],"`.>=":false,"}Nb8}":")9A#y,:"},"\"sUJ2":false,"6":-5.303529347061068e+190,"HC9Q\\IK":{"":7.624314827632721e-118,"C3U":true,"DKXiCiL":null,"p#X$P:|":-8062127790153994,"wQ\"":{"Yc!h}n!{KQ":-9.173471740219115e+235}},"Rs=^NUHebC":{"(Na":2.645886212653919e-117,",f!03SqX7*":"o/na","58AfVdOs":false,"7Om[al$":-4.307423556934081e-294,":Y,=,f0w":"B~wuCv","=?`dK$C?":true,">3":-1015125551655184,"Kq=enF":true,"tE)fa2t":-8964533673412694},"_jiu.":-8335210423859896,"level":"info","message":"G","pxuIJk":{"":2.6305794968994073e-262,"!DL=#)A`]":{"":6968923653472073,"$Y#>/eP,#0":[2325382542982567,6.675661508141053e-51,"#0E+E@ksq"],"y_":"rk>$=u"},"TiywIaw":{"1_z{r0-d^":false,"7Iv6 {dGh":4.717060178654729e+268,"Bss":1452335089346657,"H":-6499070882789744,"M\\y":"^MgvB-h","QIv.g(":"R","fU%A":"-lfw>?BOl","iY":null},"my!F9<[R`":"Ha:mp2d"},"timestamp":"2026-02-04 17:49:29:4929"}
{"level":"info","message":"yU~(f","timestamp":"2026-02-04 17:49:29:4929"}
{").F":6.738199387584e-88,"1~B|uAe`qx":{"":"","9rYkRBR":{"(Tc":false,"L\"~:-Mgn":"[Ez\\-5","X[k":"U!P=","h":-6.327615928492891e+24},"D":null,"e'&g7:":false,"ile2@]{":{"'T=@W/YZ":".Nxh!|3H","7'a#+W(":true,"dE?4":"\".n%Eq=","o":false,"}iKRXJ":-1.5895218551824454e-137},"{$O20":false},"]":{"c^^0od%fG}":{"%f,5+6":-1608351359218706,"b`d":"-#*zCmZR@`","eWN":[3.163249337230734e-12,1.4520501669209865e-215,true,null,null,true,true,null,5.520952380283651e-154]}},"g^_Up2~?":[{" gB":false,"+;1":1.2755517112444073e+306,"H9)E*OQT|":{":6 XO":4788637495119057,"W&R+V&k[X":5293301118289805,"_0<k,+":false,"loi_":null},"V,}Byycc=8":"","VLV-^":-1859344378157998,"k":true,"r":-913370079581968}],"level":"info","message":")","sNs gH(t2":-6542809854291948,"timestamp":"2026-02-04 17:49:30:4930"}
PASS src/__tests__/unit/routes/monitoring.test.ts (88.557 s)
  Monitoring Routes
    GET /api/v1/health
      Healthy Status
        竏・should return 200 with healthy status (179 ms)
        竏・should not require authentication (20 ms)
      Degraded Status
        竏・should return 200 with degraded status (13 ms)
      Unhealthy Status
        竏・should return 503 with unhealthy status (15 ms)
      Error Handling
        竏・should return 503 when health check throws error (44 ms)
        竏・should log error when health check fails (11 ms)
        竏・should include timestamp in error response (16 ms)
    GET /api/v1/health/live
      竏・should return 200 with alive status (239 ms)
      竏・should not require authentication (112 ms)
      竏・should always return alive regardless of service state (64 ms)
    GET /api/v1/health/ready
      竏・should not require authentication (37 ms)
      Ready Status
        竏・should return 200 with ready status when healthy (76 ms)
        竏・should return 200 with ready status when degraded (9 ms)
        竏・should include checks in response (88 ms)
      Not Ready Status
        竏・should return 503 when unhealthy (6 ms)
        竏・should include checks in not ready response (16 ms)
      Error Handling
        竏・should return 503 when health check throws error (53 ms)
    GET /api/v1/metrics/system
      Success Cases
        竏・should return 200 with system metrics and health (11 ms)
        竏・should require authentication (9 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (7 ms)
      Error Handling
        竏・should return 500 when getting metrics fails (7 ms)
        竏・should log error when getting metrics fails (73 ms)
    GET /api/v1/metrics/business
      Success Cases
        竏・should return 200 with business metrics (41 ms)
        竏・should default to 24h period (17 ms)
        竏・should accept 7d period (13 ms)
        竏・should accept 30d period (9 ms)
        竏・should use developer id from authenticated request (9 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (8 ms)
      Error Handling
        竏・should return 500 when getting business metrics fails (352 ms)
        竏・should log error when getting business metrics fails (144 ms)
    GET /api/v1/metrics/:name
      Success Cases
        竏・should return 200 with metric aggregations (278 ms)
        竏・should pass metric name from URL parameter (228 ms)
        竏・should pass startTime query parameter (226 ms)
        竏・should pass endTime query parameter (611 ms)
        竏・should pass interval query parameter (108 ms)
        竏・should pass developer id to service (68 ms)
        竏・should handle all query parameters together (53 ms)
        竏・should handle empty aggregations (334 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (49 ms)
      Error Handling
        竏・should return 500 when getting aggregations fails (75 ms)
        竏・should log error when getting aggregations fails (63 ms)
    POST /api/v1/metrics
      Success Cases
        竏・should return 201 when metric is recorded (630 ms)
        竏・should pass metric data to service (216 ms)
        竏・should default type to gauge when not provided (415 ms)
        竏・should pass labels to service (22 ms)
        竏・should handle zero value (10 ms)
        竏・should handle negative value (8 ms)
        竏・should handle float value (8 ms)
      Validation Errors
        竏・should return 400 when name is missing (14 ms)
        竏・should return 400 when name is not a string (10 ms)
        竏・should return 400 when name is empty string (45 ms)
        竏・should return 400 when value is missing (329 ms)
        竏・should return 400 when value is not a number (11 ms)
        竏・should return 400 when value is null (75 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (10 ms)
      Error Handling
        竏・should return 500 when recording metric fails (10 ms)
        竏・should log error when recording metric fails (8 ms)
    GET /api/v1/alerts
      Success Cases
        竏・should return 200 with active alerts (23 ms)
        竏・should pass developer id to service (11 ms)
        竏・should return empty array when no alerts (36 ms)
        竏・should map alert fields correctly (10 ms)
        竏・should include acknowledgedAt in response (11 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (43 ms)
      Error Handling
        竏・should return 500 when getting alerts fails (31 ms)
        竏・should log error when getting alerts fails (9 ms)
    POST /api/v1/alerts/:id/acknowledge
      Success Cases
        竏・should return 200 with acknowledged alert (36 ms)
        竏・should pass alert id and developer email to service (7 ms)
      Not Found
        竏・should return 404 when alert not found (13 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (8 ms)
      Error Handling
        竏・should return 500 when acknowledging alert fails (10 ms)
        竏・should log error when acknowledging alert fails (8 ms)
    POST /api/v1/alerts/:id/resolve
      Success Cases
        竏・should return 200 with resolved alert (12 ms)
        竏・should pass alert id to service (22 ms)
      Not Found
        竏・should return 404 when alert not found (11 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (9 ms)
      Error Handling
        竏・should return 500 when resolving alert fails (146 ms)
        竏・should log error when resolving alert fails (72 ms)
    POST /api/v1/alerts
      Success Cases
        竏・should return 201 with created alert (170 ms)
        竏・should pass all alert data to service (9 ms)
        竏・should default severity to warning when not provided (58 ms)
        竏・should handle optional fields being undefined (10 ms)
      Validation Errors
        竏・should return 400 when alertName is missing (40 ms)
        竏・should return 400 when message is missing (13 ms)
        竏・should return 400 when both alertName and message are missing (61 ms)
        竏・should return 400 when alertName is empty string (281 ms)
        竏・should return 400 when message is empty string (309 ms)
      Authentication Failure
        竏・should return 401 when not authenticated (93 ms)
      Error Handling
        竏・should return 500 when creating alert fails (77 ms)
        竏・should log error when creating alert fails (421 ms)
    Route Configuration
      Health Routes Accept Only GET
        竏・/health should only accept GET (163 ms)
        竏・/health/live should only accept GET (80 ms)
        竏・/health/ready should only accept GET (93 ms)
      Metrics Routes
        竏・/metrics/system should only accept GET (89 ms)
        竏・/metrics/business should only accept GET (85 ms)
      Alert Routes
        竏・/alerts should accept GET and POST (356 ms)
        竏・/alerts/:id/acknowledge should only accept POST (510 ms)
        竏・/alerts/:id/resolve should only accept POST (1036 ms)
    Response Format
      竏・should return JSON content type for all endpoints (71 ms)
      竏・should return proper error structure (85 ms)

PASS src/__tests__/unit/utils/logger.test.ts (15.59 s)
  Logger
    竏・should be defined (56 ms)
    竏・should have required log methods (16 ms)
    竏・should not throw when logging messages (17 ms)
    竏・should have http log method (1 ms)
    竏・should log with metadata (41 ms)
    竏・should handle Error objects in logging (46 ms)
  Logger Stream
    竏・should be defined (24 ms)
    竏・should write messages to http log level (6 ms)
    竏・should trim whitespace from messages (2 ms)
    竏・should handle empty messages
    竏・should handle messages without newlines (1 ms)
  Logger - Property-Based Tests
    竏・should handle arbitrary string messages without throwing (655 ms)
    竏・should handle arbitrary objects in metadata without throwing (4746 ms)
    竏・should handle stream write with arbitrary strings (161 ms)

PASS src/__tests__/unit/routes/checkout.test.ts (13.662 s)
  Checkout Routes
    POST /checkout/sessions
      竏・should create a checkout session successfully (349 ms)
      竏・should create a checkout session with optional fields (136 ms)
      竏・should default currency to usd when not specified (12 ms)
      竏・should return 400 for validation errors - invalid product_id (13 ms)
      竏・should return 400 for validation errors - invalid price_id (79 ms)
      竏・should return 400 for validation errors - missing required fields (71 ms)
      竏・should return 400 for validation errors - invalid success_url (11 ms)
      竏・should return 400 for validation errors - invalid cancel_url (45 ms)
      竏・should return 400 for validation errors - empty purchase_intent_id (93 ms)
      竏・should return 400 for validation errors - invalid currency (13 ms)
      竏・should return 400 for validation errors - invalid customer_email (20 ms)
      竏・should return 401 when API key is missing (193 ms)
      竏・should return 401 when API key is invalid (90 ms)
      竏・should return 404 when product is not found (91 ms)
      竏・should return 404 when price is not found (88 ms)
      竏・should return 400 when product is not active (438 ms)
      竏・should return 400 when price is not active (708 ms)
      竏・should return 500 for internal server errors (316 ms)
      竏・should return 500 for non-Error exceptions (134 ms)
      竏・should support all valid currencies (965 ms)
    GET /checkout/sessions/:id
      竏・should retrieve a checkout session successfully (84 ms)
      竏・should return session with null customer_id (56 ms)
      竏・should return session with different statuses (247 ms)
      竏・should return 400 for invalid session ID format (346 ms)
      竏・should return 401 when API key is missing (65 ms)
      竏・should return 401 when API key is invalid (49 ms)
      竏・should return 404 when session is not found (330 ms)
      竏・should return 500 for internal server errors (565 ms)
    Edge Cases
      竏・should handle very long purchase_intent_id (793 ms)
      竏・should reject purchase_intent_id exceeding max length (403 ms)
      竏・should handle metadata with nested objects (159 ms)
      竏・should handle empty metadata object (15 ms)
      竏・should handle URLs with query parameters (7 ms)
      竏・should handle special characters in coupon_code (50 ms)
    Response Format
      竏・should return correct Content-Type header (31 ms)
      竏・should return ISO 8601 formatted dates (193 ms)

PASS src/__tests__/unit/services/MetricsService.test.ts (6.173 s)
  MetricsService
    incrementCounter
      竏・should increment counter by default value of 1 (188 ms)
      竏・should increment counter by specified value (67 ms)
      竏・should handle counters with labels (404 ms)
      竏・should handle empty labels object (191 ms)
    setGauge
      竏・should set gauge value (90 ms)
      竏・should set gauge with labels (369 ms)
      竏・should handle zero and negative values (4 ms)
    recordMetric
      竏・should record a metric to the database (10 ms)
      竏・should record metric with developer ID (44 ms)
      竏・should record metric with labels (1 ms)
      竏・should default to gauge type (1 ms)
      竏・should handle database errors gracefully (13 ms)
    recordMetrics
      竏・should record multiple metrics in batch (1 ms)
      竏・should record metrics with developer ID (5 ms)
      竏・should record metrics with labels (1 ms)
      竏・should return early for empty metrics array (1 ms)
      竏・should handle database errors gracefully (1 ms)
    getMetricAggregations
      竏・should return metric aggregations (1 ms)
      竏・should filter by developer ID (1 ms)
      竏・should filter by time range (1 ms)
      竏・should use default time range when not specified (1 ms)
      竏・should handle null percentile values (15 ms)
      竏・should return empty array on database error (8 ms)
      竏・should handle interval option (1 ms)
    createAlert
      竏・should create an alert (2 ms)
      竏・should create alert without optional fields (1 ms)
      竏・should serialize metadata to JSON (4 ms)
      竏・should handle all severity levels (3 ms)
    resolveAlert
      竏・should resolve an alert (2 ms)
      竏・should return null for non-existent alert (1 ms)
    acknowledgeAlert
      竏・should acknowledge an alert (1 ms)
      竏・should return null for non-existent alert (1 ms)
    getActiveAlerts
      竏・should return active alerts (1 ms)
      竏・should filter by developer ID (1 ms)
      竏・should return empty array when no active alerts
    healthCheck
      竏・should return healthy status when database is available (2 ms)
      竏・should return unhealthy status when database fails (1 ms)
      竏・should include version from environment
      竏・should default to 1.0.0 when version not set (1 ms)
      竏・should calculate uptime correctly (1 ms)
    getSystemMetrics
      竏・should return system metrics (3 ms)
      竏・should return process metrics (2 ms)
      竏・should calculate memory percentage correctly
    getBusinessMetrics
      竏・should return business metrics for 24h period (2 ms)
      竏・should return business metrics for 7d period
      竏・should return business metrics for 30d period
      竏・should default to 24h period (1 ms)
      竏・should calculate checkout rate correctly
      竏・should handle zero checkouts (12 ms)
      竏・should handle empty query results (22 ms)
    cleanupOldMetrics
      竏・should cleanup old metrics with default retention (4 ms)
      竏・should cleanup old metrics with custom retention (2 ms)
      竏・should not log when no metrics deleted (2 ms)
      竏・should handle null rowCount
      竏・should return 0 and log error on database failure (27 ms)
    private getMetricKey
      竏・should create unique keys for different label combinations (2 ms)
      竏・should treat no labels and empty labels the same (2 ms)
    Alert mapping
      竏・should properly map database row to Alert object (2 ms)
      竏・should handle null date fields (2 ms)
      竏・should convert date strings to Date objects (1 ms)
    edge cases
      竏・should handle very large metric values (1 ms)
      竏・should handle very small metric values (1 ms)
      竏・should handle special characters in labels (1 ms)
      竏・should handle unicode in alert messages (1 ms)
      竏・should handle empty metadata object (50 ms)
      竏・should handle concurrent metric recording (2 ms)
    constructor
      竏・should use provided pool (1 ms)
      竏・should initialize internal state (1 ms)

PASS src/__tests__/unit/routes/admin.test.ts (92.117 s)
  Admin Routes
    POST /admin/products
      竏・should create a product successfully (553 ms)
      竏・should create a subscription product (117 ms)
      竏・should return 400 for invalid product type (28 ms)
      竏・should return 400 for missing name (12 ms)
      竏・should return 401 when API key is missing (148 ms)
      竏・should return 500 when Stripe API fails (13 ms)
    GET /admin/products
      竏・should list all products for the developer (29 ms)
      竏・should filter active products only (83 ms)
      竏・should return empty array when no products exist (618 ms)
      竏・should return 500 on database error (788 ms)
    GET /admin/products/:id
      竏・should retrieve a product with its prices (405 ms)
      竏・should return 404 when product not found (396 ms)
      竏・should return 404 when product belongs to different developer (477 ms)
      竏・should return 400 for invalid UUID format (196 ms)
      竏・should return 500 on database error (979 ms)
    PUT /admin/products/:id
      竏・should update a product successfully (10 ms)
      竏・should allow partial updates (18 ms)
      竏・should return 404 when product not found (70 ms)
      竏・should return 404 when product belongs to different developer (18 ms)
      竏・should return 500 on Stripe API error (9 ms)
    DELETE /admin/products/:id
      竏・should archive a product successfully (25 ms)
      竏・should return 404 when product not found (24 ms)
      竏・should return 404 when product belongs to different developer (68 ms)
      竏・should return 500 on Stripe API error (45 ms)
    POST /admin/prices
      竏・should create a price for a one-time product (25 ms)
      竏・should create a price for a subscription product with interval (50 ms)
      竏・should return 400 when interval is missing for subscription product (12 ms)
      竏・should return 404 when product not found (11 ms)
      竏・should return 404 when product belongs to different developer (12 ms)
      竏・should return 400 for negative amount (34 ms)
      竏・should return 500 on Stripe API error (94 ms)
    GET /admin/prices
      竏・should list all prices for the developer (36 ms)
      竏・should filter prices by product_id (22 ms)
      竏・should filter prices by product_id and currency (50 ms)
      竏・should filter active prices only (15 ms)
      竏・should return 404 when filtering by product_id that belongs to different developer (42 ms)
      竏・should return 500 on database error (11 ms)
    GET /admin/customers
      竏・should list all customers for the developer (14 ms)
      竏・should return empty array when no customers exist (8 ms)
      竏・should return 500 on database error (7 ms)
    GET /admin/customers/:id
      竏・should retrieve a customer with entitlements (8 ms)
      竏・should return customer with null expiresAt for entitlements (54 ms)
      竏・should return 404 when customer not found (9 ms)
      竏・should return 404 when customer belongs to different developer (14 ms)
      竏・should return 400 for invalid UUID format (23 ms)
      竏・should return 500 on database error (68 ms)
    POST /admin/refunds
      竏・should process a full refund successfully (50 ms)
      竏・should process a partial refund without revoking entitlement (329 ms)
      竏・should handle refund when no entitlement exists (12 ms)
      竏・should return 404 when payment intent not found (26 ms)
      竏・should return 400 for charge-related errors (15 ms)
      竏・should return 500 for other errors (50 ms)
      竏・should handle different refund reasons (622 ms)
    GET /admin/audit-logs
      竏・should list audit logs with pagination (103 ms)
      竏・should filter audit logs by action (201 ms)
      竏・should filter audit logs by resource_type (58 ms)
      竏・should filter audit logs by date range (53 ms)
      竏・should support pagination parameters (63 ms)
      竏・should return 500 on database error (84 ms)
    GET /admin/webhooks/failed
      竏・should list failed webhooks (DLQ) (288 ms)
      竏・should respect limit parameter (15 ms)
      竏・should return 500 on database error (414 ms)
    POST /admin/webhooks/:id/retry
      竏・should retry a failed webhook successfully (358 ms)
      竏・should handle successful webhook retry response (84 ms)
      竏・should return 404 when webhook not found (124 ms)
      竏・should return 400 for invalid UUID format (72 ms)
    GET /admin/webhooks/:id
      竏・should retrieve a specific webhook log (105 ms)
      竏・should return webhook with null lastAttemptAt (361 ms)
      竏・should return 404 when webhook not found (57 ms)
      竏・should return 500 on database error (578 ms)
    GET /admin/entitlements
      竏・should list all entitlements for the developer (285 ms)
      竏・should filter entitlements by status (80 ms)
      竏・should filter entitlements by customer_id (586 ms)
      竏・should filter entitlements by customer_id and status (538 ms)
      竏・should return 404 when filtering by customer_id that belongs to different developer (487 ms)
      竏・should return 500 on database error (47 ms)
    POST /admin/entitlements/:id/revoke
      竏・should revoke an entitlement successfully (30 ms)
      竏・should revoke with default reason when not provided (14 ms)
      竏・should return 404 when entitlement not found (10 ms)
      竏・should return 404 when entitlement belongs to customer of different developer (9 ms)
      竏・should return 404 when customer not found (21 ms)
      竏・should return 400 for invalid UUID format (12 ms)
      竏・should return 500 on service error (1269 ms)
    Authentication & Rate Limiting
      竏・should apply apiKeyAuth middleware to all routes (175 ms)
      竏・should apply rate limiting middleware (17 ms)
    Edge Cases
      竏・should handle products with empty metadata (20 ms)
      竏・should handle very long product names (13 ms)
      竏・should handle concurrent requests to same endpoint (96 ms)
      竏・should handle special characters in metadata (59 ms)
    Response Format
      竏・should return correct Content-Type header (9 ms)
      竏・should return ISO 8601 formatted dates (81 ms)
      竏・should return consistent error response format (28 ms)

PASS src/__tests__/integration/services.integration.test.ts (6.589 s)
  TokenService Integration
    generateUnlockToken
      竏・should generate a valid JWT token (67 ms)
      竏・should include correct claims in token (4 ms)
    verifyUnlockToken
      竏・should verify a valid token (3 ms)
      竏・should reject an already used token (3 ms)
      竏・should reject an invalid token (1 ms)
      竏・should reject a token signed with different secret (25 ms)
      竏・should mark token as used after verification (3 ms)
    verifyUnlockTokenReadOnly
      竏・should verify without consuming the token (5 ms)
    decodeToken
      竏・should decode a valid token (4 ms)
      竏・should return null for invalid token (1 ms)
  EmailService Integration
    竏・should format currency correctly (180 ms)

PASS src/__tests__/unit/services/EmailService.test.ts
  EmailService
    constructor
      竏・should initialize with default values when config is missing (10 ms)
      竏・should use config values when provided (1 ms)
      竏・should default enabled to true when not explicitly set to false (1 ms)
    send
      when email is disabled
        竏・should skip sending and return true (1 ms)
        竏・should not call any provider (1 ms)
      console provider
        竏・should send email via console provider (1 ms)
        竏・should handle single recipient (1 ms)
        竏・should handle recipient without name
        竏・should handle multiple recipients
        竏・should log text and html lengths
        竏・should handle missing text/html gracefully (1 ms)
        竏・should output to console in development environment (2 ms)
        竏・should not output to console in non-development environment (1 ms)
      default provider
        竏・should use console as default when provider is unknown (1 ms)
      SendGrid provider
        竏・should send email via SendGrid successfully (2 ms)
        竏・should handle multiple recipients via SendGrid (1 ms)
        竏・should fall back to console on SendGrid error (3 ms)
        竏・should use default empty API key when not configured (1 ms)
        竏・should use text as html fallback when html not provided (1 ms)
        竏・should handle email with no text or html (1 ms)
      AWS SES provider
        竏・should send email via AWS SES successfully (3 ms)
        竏・should handle multiple recipients via SES (2 ms)
        竏・should fall back to console on SES error (5 ms)
        竏・should use configured AWS region (45 ms)
        竏・should use default AWS region when not configured (6 ms)
        竏・should not include ReplyToAddresses when replyTo not provided (29 ms)
        竏・should use text as html fallback when html not provided (2 ms)
      SMTP provider
        竏・should send email via SMTP successfully (14 ms)
        竏・should handle multiple recipients via SMTP (4 ms)
        竏・should fall back to console on SMTP error (10 ms)
        竏・should not include auth when smtpUser is not configured (6 ms)
        竏・should use default SMTP settings when not configured (6 ms)
      error handling
        竏・should catch and log errors, returning false (7 ms)
    sendPaymentFailureNotification
      竏・should send payment failure notification successfully (104 ms)
      竏・should include correct subject (8 ms)
      竏・should handle missing customer name (151 ms)
      竏・should handle missing failure reason (4 ms)
      竏・should handle missing retry date (2 ms)
      竏・should format currency correctly (2 ms)
      竏・should generate HTML email with proper styling (1 ms)
      竏・should not log success if send fails (6 ms)
    sendChargebackNotification
      竏・should send chargeback notification successfully (14 ms)
      竏・should include urgent alert emoji in subject (5 ms)
      竏・should include formatted amount in subject (9 ms)
      竏・should handle missing chargeback reason (7 ms)
      竏・should handle missing respond by date (33 ms)
      竏・should send to developer email (18 ms)
      竏・should generate HTML email with urgent styling (1 ms)
      竏・should not log success if send fails (1 ms)
    sendSubscriptionCancelledNotification
      竏・should send subscription cancelled notification successfully (2 ms)
      竏・should include product name in subject (1 ms)
      竏・should handle missing customer name (1 ms)
      竏・should include cancellation and access end dates (50 ms)
      竏・should only send text email (no HTML) (1 ms)
      竏・should not log success if send fails (1 ms)
    sendWelcomeNotification
      竏・should send welcome notification successfully (1 ms)
      竏・should include product name in subject
      竏・should handle missing customer name
      竏・should handle missing access URL (1 ms)
      竏・should return true and log skipped when email sending is disabled (1 ms)
      竏・should not log success if send fails (1 ms)
    formatCurrency (private method via notifications)
      竏・should format USD correctly (1 ms)
      竏・should format EUR correctly (2 ms)
      竏・should format GBP correctly (2 ms)
      竏・should handle zero amount (1 ms)
      竏・should handle large amounts (2 ms)
      竏・should convert cents to major units (1 ms)
    edge cases
      竏・should handle empty subject (1 ms)
      竏・should handle very long email content
      竏・should handle special characters in email addresses
      竏・should handle unicode in names (1 ms)
      竏・should handle empty recipient array
      竏・should handle HTML-only email (1 ms)
      竏・should handle text-only email (1 ms)
    singleton export
      竏・should export emailService singleton (1 ms)
    notification email content validation
      竏・should include fromName in payment failure email body (1 ms)
      竏・should include fromName in chargeback email body (2 ms)
      竏・should include fromName in subscription cancelled email body (1 ms)
      竏・should include fromName in welcome email body
    from address configuration
      竏・should use fromEmail and fromName from config (1 ms)

PASS src/__tests__/unit/services/FraudService.test.ts (8.457 s)
  FraudService
    constructor
      竏・should initialize with default settings (359 ms)
    analyzePayment
      竏・should return low risk when no outcome is available (103 ms)
      竏・should return low risk when charge has no outcome (2 ms)
      竏・should analyze payment with normal risk level (29 ms)
      竏・should analyze payment with elevated risk level (30 ms)
      竏・should analyze payment with highest risk level (3 ms)
      竏・should block payment when outcome type is blocked (2 ms)
      竏・should include radar rule ID when present (1 ms)
      竏・should log fraud check to audit repository (2 ms)
      竏・should log warning when payment is blocked (2 ms)
      竏・should return safe default on error (82 ms)
      竏・should log error when Stripe API fails (2 ms)
      竏・should handle missing risk_level gracefully (2 ms)
      竏・should handle missing risk_score gracefully (1 ms)
      竏・should not block high risk when blockHighRisk is disabled (2 ms)
      竏・should not block when fraud prevention is disabled (1 ms)
    handleEarlyFraudWarning
      竏・should log early fraud warning to audit (2 ms)
      竏・should log warning message (1 ms)
      竏・should log info for actionable warnings (1 ms)
      竏・should not log info for non-actionable warnings (2 ms)
    handleReviewDecision
      竏・should log approved review to audit (3 ms)
      竏・should log rejected review to audit (1 ms)
      竏・should log review decision info (2 ms)
      竏・should log rejected review decision correctly (1 ms)
    handleDispute
      竏・should log dispute to audit (1 ms)
      竏・should log dispute warning (2 ms)
      竏・should recommend challenging fraudulent disputes (1 ms)
      竏・should recommend challenging disputes requiring response (2 ms)
      竏・should not challenge if evidence already submitted (1 ms)
      竏・should not challenge disputes not in challengeable status (1 ms)
      竏・should challenge warning_needs_response status (1 ms)
      竏・should not challenge won disputes (1 ms)
    getFraudStats
      竏・should return fraud statistics (1 ms)
    updateSettings
      竏・should update enabled setting (1 ms)
      竏・should update blockHighRisk setting (2 ms)
      竏・should update reviewThreshold setting (1 ms)
      竏・should update custom rules (2 ms)
      竏・should merge partial settings (2 ms)
      竏・should log settings update (2 ms)
    getSettings
      竏・should return a copy of settings (1 ms)
      竏・should not allow direct mutation of settings (1 ms)
    risk level mapping
      竏・should map "highest" to highest (1 ms)
      竏・should map "elevated" to high (1 ms)
      竏・should map "high" to high (1 ms)
      竏・should map "normal" to medium (1 ms)
      竏・should map unknown risk levels to low (1 ms)
    reasons extraction
      竏・should include seller message in reasons (1 ms)
      竏・should add elevated risk reason for elevated level (1 ms)
      竏・should add highest risk reason for highest level (1 ms)
      竏・should include rule information in reasons (1 ms)
      竏・should handle rule without id (1 ms)
      竏・should return default reason when no specific concerns (1 ms)
    blocking logic
      竏・should always block when outcome type is blocked regardless of settings (2 ms)
      竏・should block high risk only when enabled and blockHighRisk is true (1 ms)
      竏・should block highest risk when blockHighRisk is enabled (1 ms)
      竏・should not block medium/low risk even when blockHighRisk is enabled (1 ms)
    edge cases
      竏・should handle null payment_intent in dispute (1 ms)
      竏・should handle empty evidence_details in dispute (1 ms)
      竏・should handle review with null payment_intent (1 ms)
      竏・should handle early fraud warning with null payment_intent (1 ms)

PASS src/__tests__/unit/services/GDPRService.test.ts
  GDPRService
    createRequest
      竏・should create a GDPR request successfully with existing customer (85 ms)
      竏・should create a GDPR request with null customerId if customer not found (4 ms)
      竏・should create a data_deletion request (3 ms)
      竏・should throw and log error on database failure (478 ms)
    processRequest
      竏・should process a data_export request successfully (19 ms)
      竏・should process a data_deletion request successfully (2 ms)
      竏・should throw error for data_rectification request (44 ms)
      竏・should throw error if request not found (3 ms)
      竏・should update status to failed on processing error (3 ms)
    exportCustomerData
      竏・should export all customer data successfully (6 ms)
      竏・should throw error if customer not found (1 ms)
      竏・should handle customer with no entitlements, invoices, or legal acceptances (1 ms)
      竏・should correctly map entitlement type based on subscriptionId (1 ms)
    deleteCustomerData
      竏・should delete all customer data without keeping transaction records (2 ms)
      竏・should anonymize records when keepTransactionRecords is true (1 ms)
      竏・should throw error if customer not found (1 ms)
      竏・should rollback transaction on error (2 ms)
      竏・should release client even on error (1 ms)
    getRequest
      竏・should return GDPR request by ID (12 ms)
      竏・should return null if request not found
      竏・should throw and log error on database failure (2 ms)
    listRequests
      竏・should return paginated list of GDPR requests (1 ms)
      竏・should filter by status (1 ms)
      竏・should apply pagination options (2 ms)
      竏・should use default pagination values (1 ms)
      竏・should throw and log error on database failure (2 ms)
    cancelRequest
      竏・should cancel a pending request (31 ms)
      竏・should return null if request not found (1 ms)
      竏・should return null if request is not pending
      竏・should return null for completed request (1 ms)
      竏・should return null for failed request
    mapRowToRequest
      竏・should correctly map database row to GDPRRequest object (2 ms)
      竏・should handle null date fields correctly (1 ms)
    edge cases and boundary conditions
      竏・should handle empty string email gracefully in findByEmail (1 ms)
      竏・should handle concurrent requests to same customer (1 ms)
      竏・should handle very long reason strings
      竏・should handle special characters in customer email (1 ms)
      竏・should handle all GDPR request types (2 ms)
      竏・should handle all GDPR request statuses in listRequests (6 ms)

{"SP":{"":-3052899516509397,"@":-1942107508817946,"Ll$r2'r7X=":-6003945779415968,"T]{7R":"%/d`?VDC<"},"level":"info","message":"^T')","timestamp":"2026-02-04 17:49:30:4930"}
{"":true,"-6":["r.:k.'O",[null,-205417493456967,"D`E)z#",false,-1.674202276784559e+97,null,-3661844736091779,null,1.6154480227347618e-304],{"":-954366833268028,",\"\"+ElN":-2605980943645895,"0":"sf#cMD\"","88<j#hmSMo":")kNKcnc|","Cq<PK":-681070678244748,"W]2bm":-1.6989928645625512e+152,"Z,>58oY+":"","sUDSg":-8543200134305430},[{"":null,"'Y[":true,",":-1346717109569705,"G9qQ3hv{X":-6212925013674496,"Q":"ndB[)","UFM":-6387926034656477,"v[1M\\":557775856701277},"T,3X"]],".G":[5263458059759639,"fa< JF#8NB",2581543480348093,"",".\""],"2ih}@9|*5":-2.002178618817106e+85,"3\";>:5']06":-4.283981615630386e-239,"49J":{"":3194194323503209,"R":"4&4f-y12 ?","Xu4k":"eFy;f]Z"},"6<7o9}-r~":[[[-831923046978827,"ROzbFJ,u'",[true,false],-1409143537091487,-3.3067508225908143e-108],-3799739951777579,4957320788812377],false,{"\"1-7":-1.28690538635589e-105,"#":8026884802263867,"I=l%5A":"},?'","L}I|aCQ":97974699378201,"T":"+hGXZv","UW)v~4":-5071865475820221,"Xj":"U~5o","nK%\"":null},{"/":-2.9867827828603187e-235,"0ig]Gs":"3k=r+","23J6(c;986":4.242699545580684e-51,"=Q9:/MQ.\\":true,"ba/8\"s7W[":4.165257019086566e+283,"|":true}],"?t":[1.2700805395492674e+194,2314857982691055,-1.357263499344119e-141,null,null,816783721273933,null,false,9.059542232307062e-271],"VQvUe":-5.916831628733514e+254,"WPI\\!":4394511471686189,"level":"info","message":"PibOu7[","timestamp":"2026-02-04 17:49:30:4930"}
{"level":"info","message":"u?D86","timestamp":"2026-02-04 17:49:30:4930"}
{"Ie^g":{"&W@WkRdE@x":{"":[null,null,6353978268258895,-1.251040795776891e-203],"\"orMX/U":7403243329814989,"$@Q~:JO":"","C&cR00)tp":-2.9131366402147157e+155,"Fp":3969874841371641,"OU":7742737835385535,"m17O)z-9*l":"p6~p}|","p-O\\*D":true},"[t^T":["",null,1.5470161237179884e+26,null,-2647279648299090,"!"]},"[K?}8<ka4s":[{"\"2@i$n`:y":-1.8252917445799477e+297,"$~":"hG","&'}\\?gQM":-6577690617848458,"3[4%|pZ~`z":false,"?GPo8i`<b(":4.677197949721684e-12,"I[~<XmN`":"mSFR#=D\\E;","|":1942.601490794932},1.2755084834520128e-119,null],"\\<KR":[[7.764049725386735e-19],["o]z-",{},false,false,false,"1gHtx2I5",-2.7754628052063077e+174]],"level":"info","message":"xVB","timestamp":"2026-02-04 17:49:30:4930"}
{"\"X":"'","#":{"":"A8","7\\zqv":3.104681740947758e-219,"My..,Ty@":"Awa;t=9=","^ZHZ piI]@":-1382659748707300,"i{1=AVxuo":null,"x' 8OW]V?":{"":null,"75U-t|;T":7810176118076857,"9`":"\\o","C;!uE":false,"Q8eJ[":true,"]Hycl+4":-634162613576579,"g&_4Y<":-1368115447142971,"hzAg_":0.03464716934760818,"rb}Rvx":true}},"9y8qu":{"+v:}v&x":{" R/ga":-3.072625736256355e-125,"\"":1379822480539437,"21CWPK":true,"\\eb":false,"_":"M?mQT0m)","k`":"A!"},"Nu!?rV":{"PV$zQ":-1.4483362690630093e-92,"^| FDfj$":{"!!AhP@)":[2237370223576613],"2NI _8":8.829752325036288e+43,"yla":-1.7152317410001022e+269},"ve;":[-3.2976230619341467e+143,1.2202902688335273e+204,")p!J^q8DY",false]},"|<0h|Ke":["NQ",1159068450397129,false,-7.017493726960002e+117,[1.477920929420091e+286,false,true,null,122179103350331,-9.210223139274037e+69,",D&t0aJZ-h",-2.968080178143292e-153],"qVo>KtoC]"]},":!Q!":true,"DVu":[-9.794495832598569e-219,null,-1495450298403521,false,{"":"","M":"I[]89j/"},null],"K0.JU":[null,"~3","",true,[false,4.220220985235365e+34,"vHzP)2e]"],false,false],"QJbRb%pR":{"":1.2196966933097784e-58,"'~":false,"*s":-7909418384156386,"/r;":null,":":1.5422112808546473e-203,"?*PQ8E":true,"Z)m''B":1.7496019392330322e+45,"x":true},"\\":-2.0922249599321591e+127,"level":"info","message":"","timestamp":"2026-02-04 17:49:30:4930"}
{"f=~1|}g":false,"level":"info","message":"10","timestamp":"2026-02-04 17:49:30:4930"}
{"":[{" GhfaudSQ^":true,"f%T>8I q":-8721199592605069,"gp?S;W&'":false,"k,_Vq":1.774685673353097e-89,"x":true}],"\"ngth{%":-2626878195023463,"#Q":3.120302791043156e-263,"&":[-3522343579196214,false,962454013122309,true,true],"+,MH:-c":{"":2.199511069954642e-234,"!<O655-E":false,"*<X":-1.1620024228376458e-78,"2":1.056405705277288e+210,"YW\\5":true,"j_":false,"x/":1.797693134862312e+308,"xr":[]},":CD&'}H":{"#":false,"+#M<}[d":6273443431982517,"CV&z`}%M4n":false,"`f":3986648019568025,"t":5.979111700247713e-182,"vQ_q}_mF":false,"y2":7.224832480920894e-272},":j&~6":-1.7976931348623103e+308,">ca":{},"kvR":{"kVJq5g$68":{"":-36140474842616.625,"S5_k?C":true,"]":".k}P&","s6R{":{"":2995398030935077,"+:N8":null,"0":"w}gKi","D4+":0.15679195612003674,"RZ]2m":null,"Xsq_.":-9.922826163073513e+128,"hEO/D\"iI":5019628944210809}}},"level":"info","message":"1~","timestamp":"2026-02-04 17:49:30:4930"}
{"=]_5@":{"":-23710658367.685745,"+0EV/#":-4.631021460584758e+166,"-7U":-476571040352945,"1":")$g^:","TfC+u":{"<7VSf8nps":false},"a~ ":"l","vv1k<&]]":9.99024487564383e-118},"ZsHRSCy;1":[-5314523889589746,null,-151309176849830,false,false,6072744417481257,"TUty^","<"],"level":"info","message":"x","oM>E^GKnXY":{"":",n{Lp9|P","1k1=Q)tZ":false,"Etdi":false,"e":-1099577975196638,"hgvB'o(6":[-7712234604261116,-6498339018651370],"u":-5.113141072910092e-305,"w":"8p","}%5":3781505824388673},"timestamp":"2026-02-04 17:49:30:4930"}
{" ":1.7976931348623037e+308,"%\"\\":"4y","9\"h*\\Z":null,"level":"info","message":"","timestamp":"2026-02-04 17:49:30:4930","vWPfA":9007199254740986,"wG/]":-5248653105967986,"{":"#2Oun"}
{"JfuJzX[":{"9[3-":[4860840412939977,-2.568519748584465e+40,true,false,-3094291343571627,"M@Rm(9<c","f*^F","euNTS",null,false],"C>M":{"<D>E?^r?*B":[false,-8199248571581157,"oW","u1.@"],"D(HTR492Yb":1.4949594430566008e+261,"SI'Vn":-1.3562991959594182e+249,"ptsY<=\"B":{}},"CE&\"Hj":[-9.258015684773874e+178,null]},"SG5A=X":{"GNbUBp,'Z":{"":false," DHNp#%\"H":-9.937760764025843e+146,"%E":true,"8QDC%*\\":"/TXg;1&*","`xN?%po":4539782484214369,"fxl0K":false,"m!wg":-1.195809973840354e+151}},"level":"info","message":"D=3","timestamp":"2026-02-04 17:49:30:4930"}
{"2v":[[true,{".":2.2024191089123968e-129,"37/3Wd":"suvc~l-","Azd~uC.":false,"G:*":null,"K$=kS":717439962252081,"US":false,"bkGVlZ,<":false,"q|~XAsy.":8939490567509973},false],[8449796396537933,-4.848192944810716e-302,-8733058185004667,null,7928181262148229,false,false],-1582714293105225],";f(hg5Pa_":{"":"S!Wci)b*}","+Ewy":"8{scOx%;","@Nx@tDq":["",null,"f|%h",true,"^"],"ctZo":{"":-0.0043226002231402,"'l":"$U~hxl","E~":1.7377820832914062e+239,"H_f2N*@L+":"~l2WK","Si~fW]+t<":true,"iC_JK":"=|NRHK","vqapP":"9~"},"f.":1785712557681955,"k!oG":{"":-5202670617896590,"*":"Y&m{","0g:1LH} U;":-1.817144575811929e+291,"Iyf_Rv":1.959829445232492e-22,"QFYbS}2m":-5077387932221723,"Ta*N(ub":-2947499347380086,"ZemqNblX":-3.334105105020329e-251,"g@sb{i<lm@":null,"{aJ#Y3W%M":"l2"},"{/36":"Sd`"},"M5ysn":[{},-11295965612341454,{"":false,"$-":-5105084799806419,"5X4\\":"T1A^P","8":1.0457381973927045e-31,"=L$$A=GF":false,">{s(.":2589827461734814000,"GL(01":-2.7818708148242562e-257,"q33Q":-8.746722049240409e+42,"~\"6*8UKA]":"#*p_!"}],"T ,']4`j\"":{"r5w=>,":["Y-&",6.526955342339702e-124,5692843686810681,false,818048955727531,4376934659437857,-6328474679460875,false],"uP":["?",-2.066181574940318e-10,-6332070344729405,4.4373837697514465e+160,-5044787288529391,8556660936195371,4561204789427421,-5.882562670754478e+237,null,1.2278454761153035e-264],"}[4d":[-1039682896825128,["G%.ghob",4496490544752101,false,null,2489844115457673,null,"3e0>vMT","X",-7.006355102792705e+151,-1.7088181712815634e+162],true,-5212235215630299]},"level":"info","message":"N;<y","timestamp":"2026-02-04 17:49:31:4931","u\"m&}k3":{"\"iM*4gu&":-1.6975259240671959e+283,"%7572a@ ":[-8420847854390764,null,false,")VfaJI","9","oC|OP",2.74802743131129e+217,1.89192331545091e-55,-9.02336639514395e+240],"?_W\"k":"?e_H_YP0@L","pn!":",","}":-2586053890615213}}
{"":{"":[-1.0213308727359352e-217,"t4%",true,null,40834967873183,false,false,""]," #":{"!":"y\\zcL!l>Y","$pazEpC":"e\"[z/k","*k_L+#Q|b":5882353193815557,"<{1ix}B":",","OEXikK*dQ":null,"^O_{ i1Xw":"7$4jnDCt","di6foiXs":-1.1606885733487597e-302},"mu5K":true,"uh":998018175837491,"{f{/=[,":true,"|0AMN":";SS<(80J)"},"FPFNW":true,"callVca'__":{"/3b8)b":{"T":-4055093261084045,"_s$.4":false,"rRuAxK":true},"8@5":-2.874040860796913e-275,";+/":null,"UVeZm>GOR":-1.6473554968869072e+227,"VKOTa":-5.969002393911857e+88,"is^D_U":1.1667331037342329e-29,"jS0W%IfW_":null,"lp]$DuG;<D":"WEk"},"level":"info","message":"%!","timestamp":"2026-02-04 17:49:31:4931"}
{",5*YJ*hh>":1.5034999278307602e+93,"6FX":{"":{"0!H/(":"","5RaN6=m":true,"8mFJ2C":null,":?S6YmENO]":-1.709697911863761e-281,">_bB+|tg;F":null,"C|kGz4$Q|":"","M":"1:.|kqg!Z","kV":-3931352925116640,"v'EwNQVJj":-9.990689431338786e-173},"#~Yc{M6":[],"aFau":{"%D;kXx|D":{"":"Z3zZr","D3":"B#X&","m*_oNwR":-8819205132406288,"|FrXtX<":")~;I"},"sJxqBl9":3.0671402979085537e+66}},"GeA!Ki6Q":{"U?":"Af","VXL1V":["X|E;Cr8"],"cfMr\"h":"B[s","zz@9-qL":{"":{}}},"Tc6^":{"":null,",5dqA8":true,"7;Kh~5n{:":5245188764804191,"Dz4Of5o":true,"\\bj3e":{".K)x!j":"`UmD<FC",">b8Y":false,"O;r(Ot`":-5739534614814172,"b":false,"z=K~szt":"R 30/"},"dJEJMT\"":-3361079527.4358287,"gxH1gf":-4826057890428089,"i`atdrBR2p":false,"kI'IwIg":true},"TpPD":["o=@qx~y-m^",true,"TXM?CwGgw%",-7907407485626654],"]Hg+r{jD8":1.6232177298946719e+165,"level":"info","message":"?7nY&>[","timestamp":"2026-02-04 17:49:31:4931","xunB|QGpA":[{"$r($":1238964545708337,"*A":4.2811098328105025e+253,"?>ey(5~":-8763850227578241,"N2=1W**oT":"","W2r":6440109833080269,"^N]gV,:Si":";rU","hy7CIa0":"}&","isC4tA@V":2.0578465070490457e-220,"j_VU~Pts":"cY","xXWXfQ":"URTt\""},{"":2827235840996825},{"":"C&$RzjdH",".?Dp<7S<%-":"4,ddIYQ","2\\CT TQ":5828352719554857,"3w4Pc`N!h":["iklwh_}j'~"],"I":6.267575610513501e-281,"Rd}kslg#$":true,"hm.IOw4PI":"","kAX\"9l P\\M":null}],"z|":{}}
{" co":{"":7242984108388251,".a":[":<XW\\y",-3.025005827357465e+262,"'Z",-4484470900236719,"","",23716394540989,false,-3.256547043715166e-240],"CXF":true,"s hJ2":["2B",{"":1707574661213561,"$":483938499722749,"G(Xc#p#":true,"G3Vjua":"nllmeEDo","Je`+Qzxh":true,"Rs%I":true,"S;":"<o+l:~:=2","pUQ":true},6.733641280397035e-181,true,2905540058225497,"F(t "]},"*^iIP6E$":[-46,"`9^BS(9f",false," :) {^iGUY",-7758046636907929,43,"g:3'.//s",-5.452293106621236e+246,36],"ON>":-1.0146498814405604e-276,"`ZsUp":[[false,[[true,"pY/LR",false,1.37852542836508e+228,"#","<0?-V|",4.363916757220553e-234,"{O>Jt}",3015609187493517],7517285118389713,false,-1100560571111105,"'kn_rqzQww",1752755818114525,false,-2.543236309143914e+40,-8844497037118490,3217183914515025],1.1765132799298315e+262],[1.1691801631992544e+242,1.0461353886688342e-177,1.6192936595404973e+122,false,"W{h0$",false,-7309467576603776,false],{"(\":!xo&#":"OIW/T","2HJi$ZBD":"","Sf":true,"ZV":"E%.","yw3&,":589693721184757}],"hZRRxM":{"":16204895.475971814,"2WNGh]yi":["nQ/",-6.125469457967584e+217,-5188250039943474,null,"spet}|",false,-5897840563606180,"z1","lKv>pOPG"],"79XL5Sb2F":"fNIAWoFW<s","Fs":"a&2T&S\\g.O","\\w\"":true,"`![":null,"u^,M(1":1.0159196940976254e-283},"level":"info","message":".!_K\\M","sqL<m,U":3.632575212261364e+266,"timestamp":"2026-02-04 17:49:31:4931","ucHJOeR\"y":3.9312406278998854e+297,"|jnFFEN":true,"}=N{}K/)X":{"":{"":null,"$[":"r=S","C`lkR":{"":"od(!||iS",")D$QKf$":-8150709428414669,"9vD($<":false,"K]5\"?X":-1561781123194067,"VAgC":"<#F;vXu","eIphg+x":"AprM7IY%z"},"S":"v\\q-E","s,T:RS+B<":false}}}
{"":8302449972865425,"level":"info","message":"SAu$WB6|","timestamp":"2026-02-04 17:49:31:4931"}
{"":"p)I*Tt}Cr",".G{PK|":"mvH3F\"","level":"info","message":"9gvgGGX:`*","timestamp":"2026-02-04 17:49:31:4931"}
{"l]V-":{"":" ? r4UL","0w":true,"5(5Jw.]5":{"":false,"%kMy":false,"17G":-5.60393800370943e-172,">ZN":true,"NWwUW^c}":6733101870880161,"P{":null,"S/3)E":"{H9UMN","d8]$Wx\\A#u":3667907785580659},"5VA.":-7601454683884088,"Bx@b":-5707058747051800,"\\O61wp:i":null,"u,i/":false},"level":"info","message":"","timestamp":"2026-02-04 17:49:37:4937","ux":{"":null,"v":-2890551426079256}}
{"":{"":[false,-7013824600505542,false,null,"(x}F\\s7",-4377561382490710],"pn@E`tL}":{"":3.771675760437632e+235,"1bYR":-4.447962230908206e-144,"2.Oe )":993354145934733,"WPnY7bJ2r":true,"iJjv/`rS5V":[null]}}," CJ\\pV_Hy;":"f9","(":{"":554664361803489,"&":-5.324105587381722e-125,"52":5044808471211557,"6NU92":true,"d@#Am2ZhQ<":null,"luO1gW|v'":false,"o4E}ng":"} R","sM;JL":784542674103505,"|":7.861027200794249e-156},"(Pa+[/O":9.851362345957532e+206,"3[%~r2j\\N":{" g":-2.547204366195074e+113,"4/eU7+DA":9.684500073559176e+297,"Q;V":"Uc/,e'","b?<[Dv":"&C+OWkl\\","vc3Y":-6.1979900580944626e-27,"vy}":null,"xoH":false},"KS\">W'":"mLOQ=Gf","f,S&R":true,"level":"info","message":"%tSey@l","timestamp":"2026-02-04 17:49:37:4937","vh":[],"yzl0nq^ie6":{"#VH\"),h":{"":-5355748500876400,"!E~$":"","JXTm(CWo@":"","S,h":[false,3435750049334289],"WC#w]/sI%t":{")sU%cpW":"/OBAFbM9p","T#`s":"s4","XZr)":false},"Yx)":-3.2037510002887825e+59},">^B":{"6 ,c(dNE\\(":7164354662135953,"`0Vz`W/":4499782584058297},"\\.zS":{"X":539780220984017,"b.1>6wH1#":-1.3709736113196394e-226}},"{$.5T*Z3iW":{"\"5":"gYytt","*4%10":"(Pgjc?3\\8","0oQf:xdx1;":7.646653929338113e-94,"3k":2.7939036104979384e-182,"7tKRl+R":false,"E":"qXPb","Nr?VPc":-4803023070224071,"ro}":"x%"}}
{"":"s"," B|!!}9q":[null],"9YE`-Kr9 v":"_d-yHkV7$","level":"info","message":"&4>","timestamp":"2026-02-04 17:49:37:4937"}
{"":true,"&cu-o<W5":false,"8oXpn'":{"Ce":["+1Vm+",false,-1.2794315851650087e-285,-2.348886955368703e-286,null,1547285189073813,"b:NwMka",-7661703232941270,false,"\\STDw&<"],"\\[hxM=D)":["!a",null,null,"vxk4l5L",3.2789312874597375e-8,5.034130971677827e-245],"dCoz,:":{"":-1068767676653367,",yq1dyuU":-1.1416624548857814e-293,"9Q6Y":{"2I;E!\",4R8":"0Sz}Sh","4XQ5UmFc":5.225148578054373e-266,"@.Z\"PW":false,"T*Jh:j":")w[,GvK","]N00iDD7":2139720773981535,"^z>r :x":"_X68"}}},";":{"":true,")VREX4":"f[?F*;r?",")x":-2.6652880843902204e+56,"8\\r ":-5355739941839067,"G":1.1243495661210729e+46,"Gia":"","pNe|U$!N":"s>)"},"D&.":{"":true,",kX":false,"aqL5Ua8":-6051962289098124,"e_C":true,"k$*lWEu'><":null,"tD)G)Q@@u":-1.0256729754587037e-110,"x":false},"`DXA20s":[3.24714590133166e+243,1050178108145081,false,{"":2.769883878913069e+279,".=@tjzK":null,"?u":["D","`/X'z",2.067655581944925e-69,-1120329672363113," CWI,Ka",-192235253144.13052],"{*a_AE":4.660006091854388e+90,"|@cNm{'M+|":-2747301881254299},false,-1.8531699831797168e-87],"level":"info","message":"#&toLocale","oB'<g":1344879232355865,"om":["25n&mgc","",true,1868594107876833,"ba",null,false],"timestamp":"2026-02-04 17:49:37:4937"}
{")":{"!jD\"g%)|su":["=<0;#v-",-3.644016535590613e-159,5160086654870655,-3980032860355668,"G0","(w4",null,"*Dw;D",false,2.0479407189551394e-134],"0DSA{qNwb":-3117826612801597},"JL":1.7e-322,"Y8#":true,"__l":{"":1625551925684511,"!8A\\Pg9K{w":5059379611828661,"#":7770650369331449,"%V!4,Z":-8.724248391845982e-58,",fd1fx":-7.733455254010724e+24,"K~N(A'T#N":6.988128138604644e+293,"OvYn+_QmL|":[false,"r","\"5XU6CGf`C",false],"Yd":true,"{W:HZ(Iw":-3.34322388584125e+305},"ke":{"'Ct%HS|3IV":{"!":false,"*> ',":false,"2()YBv5Hc":6.960877979366713e-150,"3m%m5\\WK2":-7.883568739849504e-306,">NZF":null,"K]8>oR oa":true,"S6Z":-6.168588616986913e+153,"~Bw|B|SIc3":{"$(oYF":5123329906435361,"-":null,"6":780156800062809,"9t8->3T8$":-5776603772223911,"V2^J":"","{":true}}},"level":"info","message":"","timestamp":"2026-02-04 17:49:37:4937","wM!+":[[1.2995759067150884e-263,null,"Il",false,5.56911042658002e-44,4019109092085005,false],7266489560169233,null,-9.711716870787097e+158],"z#":{";{":true,"<G1O":true,"<i4\\>K ":false,"OZ nil#z":true,"Wrk1'":[false,8.091027182175844e-265,null,4947002687847697,"g"],"oOx*":"u,)**}"},"zar":null}
{"h73yCly":{"":"\"_","')y*]p":1.4411851171403925e+274,"9h.S%Zo(,":-2003963398600181,">66Sq":"6&!jpop6[","_@":":VaUlZ0,","h=q(":[],"i(2I,o7":false},"level":"info","message":"\"","ngq<\"Zqs^?":["ige0b?L*",5.7927440597048855e-236,"",-3.96947565470567e-105,4414286802485723,"l,:8W>z@Y"],"timestamp":"2026-02-04 17:49:37:4937","~8":{":R!<^mSOv8":[6619302595689849,"tf",-8055795084591006,null,"nT%","&z'|","_\"a:RgDo","Q>=\"dyry_",-3386480910124578,-1.230052364576965e+282],"^C67lu\"*MJ":{}}}
{"'g8Sx":-128812865721273,"2)1$\"":[],"level":"info","message":"z+c","timestamp":"2026-02-04 17:49:37:4937"}
{"!iWV":{"@2":{"X":null,"j l3 M":"~#fy0}o*"},"F%$B$S-_{i":{"s KZHFKWj":"k"},"f2i2":{"":["or",false,-1.8350757356591395e+109,"",false,"RYFK",null,-2.2416472407351122e-131,")a[h]{A;c",false],"%|]x_)":"+ir","(C'{hLuOY":"uN}t/?","-|03>]2aw":["aXL;;pK"],"7x":1517492526930833,"^":3421674047215341,"yV*@Jz":{"":-2536989689529761,"&>~.\"2xr\"":null,"D U8HD<":false,"E:Bx9*T<B":false,"L{($-|D":null,"NAMN2N":-4.1733438700370665e+299,"Y":2.467384751457995e-156,"k/RUo0F":-5744766858675965,"}.3IWK_kS":575870657846617}}},"57!g>-v(":{"":[-1.2375719794021865e-186,"{"],"//":"i5o@dw\\ oN","wJ`|qFc[;B":[5.780731711145483e-73,2.529106400808404e+28,false,["TB"],285442621471093]},"9":{},"Wq${":[1.630258121121386e-235,1.5898242025775043e-80,"=SP:hZyaL","C",false,null,9.807282374328411e-185,null],"arguments":false,"b4":[false,{"":8855751666931467,"!6~JJ":null,"@*x":1.1314515250300353e+217,"S":"zYIb","Y'E%/c":""},null,true,5.718469441744035e-193,-2.1534058688617223e+192,1.8245217456748687e+254],"e2a.A":[false,50,null,null,"hl~r1!1","`{%E",true,-1.77768661526106e+201,null],"level":"info","message":"","timestamp":"2026-02-04 17:49:37:4937"}
{"":null,"&~prot":[null,null,"NS/",-4621457739789559,2040330073913949,true,4.742042558734455e+66,"tQU"],"+GlU#!#G":{"":-7.029791864472163e-171,"3W52{I:Y":"'[!`T(2","GVRUhK\\":true,"VL5Tp`+z2":".u{{M","^":2004694728335425,"_":null,"_zLrE":3.427410928852817e+273,"msd7`^E":"@=3,sDJW","tb[A1":2874635686670963,"zL!_jd\\Z":false},"9oK":[1.5821295125722762e+297,-1626388021211817,8398893087875327,2.1120335610543567e+67,null,7.355468478748613e-281,false,"PBi~V06","4"],";zUt7!`s%":[true,"","`Rfd:",true,[false,null,false,true,"NW55(H4f","PF",-3436017926867113,"bV0"],"E"],"[(Z":{"":1.5336545693872737e+248," z":null,"&bt":"3m}-\"","/:p$tCU":"G7rn#r~~GA","0>6J@u+":true,"Hq*_F)":-2111439142578403,"h9H@tp":7196829365562735,"q":"suvy2.8AG9","uJ!":8987791359200669,"x o#p0q":1.657577518235708e-138},"j%<":3e-322,"juH!bB(=7Q":[],"level":"info","message":"?HSsz","qY-UAd8{":false,"timestamp":"2026-02-04 17:49:37:4937"}
{"At":6443647516284429,"hRT:>":null,"lb` ytIP}":{"?":[-6.893900910298111e+275,-3214614621969926,false,false,-592290857730053],"PeuBD&m":""},"level":"info","message":"uM/","o|":{"":1.3609752143622933e-13,"&6RJX1o":"xFPR_#S","7Wn1":false,"Z)G9bKPR|'":7398670934128829,"pA/8":[-4.02986914592773e+26,"-7kMy",2162619444790477,9.876779463937153e+158,true,-5.0564542274926974e+200,-7244359629768402,"K?hc+=",-1.3092242796254412e+112,1.268837789487207e-81]},"timestamp":"2026-02-04 17:49:37:4937","wfE|Z&'gM5":[3078928.945366721,3263188419327257,"t`",-4576203840489494,-3897069603466267,true,false,false],"~=4/].":"03]w^a;J"}
{"":1641758021741285,"%<3[rm7 ":7846831103599455,",\"#n\\]":[["vP",true,3.271507702007741e+259,false,657736064435537,true],[null,1.652036689303084e-114,"f_v",6665604229386207,null,"dY!dQ}a","o",true,null,3.720687900271547e+294]],"2'lE^\\2":{"KSY?k_":[{"#BQ$oSF&*[":true,"'5 HPfJZ8^":6.555590754003202e+300,")<,a":-9.382669897869061e+195,".? Z\"ZR/":true,"09fcd2eB=":3.2508624775694373e+96,"J{F/>fzsY":"gUCoj!kfHd","TUO3":"U=0~?","fD^s!Yqn":null,"j:":-2.2092418967588273e-171},[true,")kMDp5U4`",null,"J5l=6-^F",true]],"vD":"0shE[]X?D"},"3":[],"6j>uZ8=w":4.133927417788579e-100,"J2._8y.":true,"Y'69J7@":[],"level":"info","message":"G%","timestamp":"2026-02-04 17:49:37:4937"}
{"":[],"+:.qeShS":{"($oJUF@M":{"":4.083257668167883e+205,"#X`W":"p< F2v","#[Q":"O_qX1,Z","$JY8!1_<":true,"7l":2467934963128839,";":"(JRba|<_a]","F._<":6982785204193641,"rW#D9":"..E%ZjJ","u;s[+ .Q\\Y":-7764097905441516,"w:L":""},"6pbPuh,##":-2.3995600217722892e-182,"PcxTgI5J z":-8.529646704553303e-257,"X<q51b^":-681686359381955,"cA6=pj3F'":[-8062463864404352,-411557796802376,"F M1",3243085422131499],"y":"Rwi_^^"},"3PF\\":["Q-b0|Wra","QLB",-2561995183688955,{},"QBi#X3u4p","",-7670926017376249,"xiY[}h,'S",null,1.7019626041103187e-195],"=OR[_.":-4204888430514939,"@qVx:4":{"5Hu\\`":"A}&W8","OQ\\":5314745452329145,"yWH :9~#":{"":1636604212161241,"1B5iP>":null,"1|r&":null,"<,":521927910816353,"F|t)xiB":2149809469977465,"U@d!Y":"T=0?K","Z\\9#":false,"\\&){#paz":-7310519046959093}},"Bz{5":3039773701828325,"]QZ9":["",false,869841290073323,2567872266103857],"^:fPKT~Pr":{"9":20563873290577.793,"]'":"q$TC3)","~x":-4343089033675810},"d<":[{}],"j9(C5Z":{"*D":["i|)",-7.8152802027995995e+295,{"":"`x+1*fJ=f9","D/o>F*5 `":6918955675812413,"G<U$f":-2.2496770222386718e+88,"j62RN*?Z)":false,"q#=Gz9g":"T!O","vnmN3O'":1.4014708975910748e-18,"|0eNoiNu":"4D"},"oWE6_igk",-3229027325955532,-1.5501316463511521e+302,-1.5348074119059215e-75,-7023856807307144,"EyO!6",-4143660868149067],"<n2cJ1U)2O":[false,9.2102691354689e+263,4530461515151899,4340579002972117],"GD}~>":{}},"level":"info","message":"U(RU7I","timestamp":"2026-02-04 17:49:37:4937"}
{"Rqa\\":1.7502452382776431e-37,"d!":{"!B}~4":-2.9481981854771214e-159,"T":["",-907537787867613,-1.3976001292629262e-239,true,3698630762582345,false,"o;",-5899054814506240,null],"UdrQ,}V":-1.4013084489953615e+26,"a|rp:2":"W;i"},"level":"info","message":"gfMy","timestamp":"2026-02-04 17:49:37:4937","wNlVT5mw{":{"-or":"7>M","3}cg.Yh/":"6^","7(J!06K~F\"":4994379831872569,"9}^hGw,Cf`":-6.753421878113979e+165,"cP3B~u-":"rD2'dNYSr","eO":-8377453632544341},"x33m9}":{"":329550097035883,"=@P":5.055639492313533e+241,"J":false,"OP#?v8":"u","] rJEd4wP":"","e_ye\\I oas":-3096973565101533,"k":"%","m":null,"v^>y0:\"":-6047672432816259,"~KM3-#":"9N}O(m"}}
{"":{"kCcGy%CF":[-1733684631728309,[],3869632801854389]},":!nsyY@4t!":[1062896425969772200,null,-1.797693134862304e+308,"@$z",1788025946907915],"@fp":{"$,=Y#":1.2096887944113474e+227,"-a>wr@QUV":"\\= &","7":["3Q;#M",-3.585068066123593e-106],"P":"xLiEt"},"IQU":-5012757097590427,"Lk\"y|)z%}l":-8483450562431812,"U}y":null,"^":[false,true,null,null,{"&&":")Nby=",",_w]jr!/Yw":null,"/%,11$d~>U":"}QkWnU","DM":"z","^KoquBn'D":125556366550891600,"k/tI4":-2055434606706303,"r}":false},"1",null,"G@r`{>X","U!%:"],"level":"info","message":"zW","timestamp":"2026-02-04 17:49:37:4937","~)j$$*#I ":{"$6k_":"VezYYy`q?#","<`{L]$":"enF6H","ElfeIWE[":null,"We)ef}K":"O","[&:Ww M%":"2x5|P {","b46!d/\\U4b":false,"toString":30}}
{"%":["HP[$eT~]",null,"wq","RW+4]*",4017807820606579,null,-1630104731694676,"#>",false],"*}T ~":[{"'cNp\\Fi":null,"6.]Zajk":"Z!Wo",";:X,vHZ-vL":true,">~4jP`54":false,"VTTM8zN+4{":false,"_\"jw":"@!","vP":-6963757207151542,"yM:NkDy":-2283069867574934},null,-1340779298305010,[false,null]],"level":"info","message":"Hh","timestamp":"2026-02-04 17:49:37:4937","{":[[-4645331296076414,"",-2.22485331383473e+187,3179231964612521,false,813210764205865,-3147043933509481,3.5577577476992914e+243],"!_5~E~Z"]}
{"":{"!1?#>_N":{"":8.829588227043008e+75,"9>@@":1.4784999444559646e-96,"G<\\EsZ%1E":2094004422694573,"x68":"nQR","{2%;":"&N}6j`"}},"a":[{".]I} R":false,"0)":"b","G!I=K9X7#8":false,"WQD2Q1]vus":-2.033791393269912e+134,"Y]uGgs":false,"sBA":true},-5779008500935312,"1>@`91)",null," 46WIA"],"b":true,"i70tj[7":null,"level":"info","message":"__d","timestamp":"2026-02-04 17:49:37:4937"}
{"=K(0U":{"":null,";,;;`-mL":"","GA>K":1.4715210718995462e+295,"MV{[<B#":946095200498093,"f1X\\Kb1Xc":"EcGP%t<~*","qjU4":-7607675639759127,"t?-:C[)VLp":2225487117187611,"w`10[vs\\ ":"KV28,D!S","x6j":"P5:'|6$ j>","{e kNMw)(":-2.6189484415720075e-211},"?&mg\\1":{"ZUB3-":false},"?JV":{"$^T4":8.678105874364431e-156,"nw,":[2015714183309267,null,"HOOh9N{('3",false,-1834315484778435,null,[-7.180075861971407e+108],-5.175392984807854e-15,-59465624638649,"aNJ"]},"_y8x+~>O0!":false,"level":"info","message":"/OQo'","p|Uabo@u/%":"BrH9jO}?","q&":{">}s":"mxK65","BV)YG":null,"Ho=":-5925092082427368,"S{!":3.497877113897804e-233,"YjfDI!":7.576121621670811e-165,"YsvW60 d4u":"","s":"<cc3S","}?V":true,"~V[":"J"},"r}L|G_^":{"&)":-4026795743343958,"-WP#":-4.9923197207327824e-281,"Dmy":4278865663600053,"I*Yt":" (:","_":-7125215667079981,"_!q":"2.R[;9","g":-8406099444690191},"t]%? Q}LH":null,"timestamp":"2026-02-04 17:49:37:4937"}
{"\"NOV":[-3.4490691518491327e-245,-3403172801648478,"YeFg#3Mb",5196042165448407,"oC+",1944062250234587],"#":{},"/]O":{"Tx{k$":[4474774163089967,-1.565225827953927e-256,-5.6409686821309056e+246,{"6SUR;BL":null,"BfM4C;":"dhWOcP","CbSv>dWW":7715014554470489,"UkjzWL0CAS":7.372721764841924e-73,"o\"+C#&)]U":"y/n2ZTT","z?/gc[":{",|1_,oo@":-1.855831986003644e+221,"6!)":null,"KTBEh&J":961998405993821}},false,null]},"level":"info","message":"&579ZQ","timestamp":"2026-02-04 17:49:37:4937"}
{"":"cAXL?Ag","C~qBFdD}w ":["g`0E264",7601991601361165,-1.989577289874811e-290,null,{"":-6489600658793954,"!":-4197234224170490,"(R}|-":-3.1584238806781334e+278,">Mv\"0F":1.3709161582162273e-213,"CR@Xd/":"{6\\Xo<!1b","SGEcC":"34VRo4","[:Z0":"!R]","xm^Y1":"c!T.H=<S"},false,false],"aMu-.?":1.789092937539726e+240,"b<0G<n":[-8477980036741114,"f*3",-6335655000373592,null,-4712684104483313,-2.1904165748947844e-110],"level":"info","message":"#MhD$Cwg","qVieJ<0":"'2~eF|J","timestamp":"2026-02-04 17:49:37:4937"}
{"":"(*W1J","!Q3xw4":[{"4u)`w,R8":6.1926818135575e-103,"N.":-1.9334730401614625e+128,"^?V&R0%>":null,"_7":null,"wI>Q":3.65463145598627e+122,"y?}Ul;R":true}],";N7g}~#":[[209092352711117200,"w^Zn[",null,"K)c_g^G'46",745425437816069,null,true,368759697430969],[3631944741056369,true,"l",false,"D} 3"],"yx.g^dj}",false,false,true],"O=\\# u/":[null,-7453888954497518,"dSo<!I",8978550150397441,null,4900710984047451,false,"v",-8799561270729429,3.785324935449542e-89],"WQA[E5":7757496568712953,"X,%Y6D93):":5.2313151369369836e-160,"Yc6[":{"":false,"??i7#Yu+_i":".@{-","BtRL.E":".O","I)U+V":true,"I>!":4410970876048751,"ZaIs)":".#<ck"},"_(H9a6":false,"level":"info","message":"9[","timestamp":"2026-02-04 17:49:37:4937"}
{"level":"info","message":"!MBE>zz}zG","timestamp":"2026-02-04 17:49:37:4937"}
{"":null,"I:":[null,true,"-e?j.!uP",-5.345340601591207e-299,-8.303150149415456e-303,["rCL",-6.630927649729654e+189,-2.690695936750924e-206,6.116874296653281e+197,"ZP[I3",null]],"level":"info","mS9^":{"":false,"!Q?e(H":-1.5e-323,"!kdH0y":2.26844995400102e-309,"%B~ AK":2203313589994689,"3@baGO1n=%":1.0519677278221784e-54,"_{`<Ps":-3.916207592137641e+141,"yz~gz":-6e-323},"message":"%7","timestamp":"2026-02-04 17:49:37:4937","tm%d":[-35027897316366430,-1.310894251193629e-96,9.335799981879361e-38,"H!/SM",-1.2074860824893284e+174,null,null,1.5699134288763355e-221]}
{"+":{"":false,"J)i*9":[{},{"":-3.8660390110613834e+275,"+D":-1.5953626497330478e+205,"1DD8;":"u}?}|a","6X>b":-4583340012485860,"H<":"vs3h","Lg`":"!D-0%Hzr","prqGCdmv":false,"s[!5z2wU":false,"uP2xe":100617555015661920,"w~Dy>sf1 ":"3"},-833721456367664],"{v":true},"level":"info","m\"":"`=HyDwn","message":"V8*qV","timestamp":"2026-02-04 17:49:37:4937"}
{"HL)y=+oN0^":-2.5602692910999876e+78,"Iu)TN%7":{"":4.353039205183257e+228,"(TT9E@":-2158104749171581,"D:Nj\\":{"3\"XA)B":"5O5<op&","[2Twb":2.982739098547303e+248,"\\NV":2.24802704093816e-146,"\\Nj4.(":"A1%k@|Cji*","h'+H*<<":-3145017479982665,"kHiJ":-6.929098311414743e-237,"mwR0mey%]":"e@"},"WC'Z":" V(W","^i(":"\"1j","dpEbp9{8":-1.0835324781477028e-71,"s]=":1.1740329835983775e-171,"wpNsx+UgE":-8429378116259399},"\\={f1":{">.D93Gj^$":true,"@k[`-":1.4412402465393086e-47,"DN^)<Vu/":true,"G*2deQL":false,"Zz":"BpqTug}"},"c3Nk`":{"":"Nq^Kr","!/g":null,"/QRZ":1437434314357120800,"1WD":-7.031249065741048e+160,"6kwv=Vv-":8201544219677233,"R":{"x:v":-1538937053792792}},"level":"info","message":"key","oI+<":{"r)":[3460320276927149,null,"{eQ]8D3**Y",["5TH?VYQQ",null,true,-1912672700832209,"^r","J0DCj|C","&tj"],{"!?A] ":325115253294101,"7^03":false,";Js>mV@":false,"EzHYM|w.":-1830304419556857,"\\W09m>Y`":"D+^YNlx$","mB7`u:9":"0!*x1n(!X","m}sv.C?`":null,"uWcb`0wm":7.865956639223482e-157,"yE":false},true,true]},"o[-fqiB8^":false,"timestamp":"2026-02-04 17:49:37:4937"}
{"$-mU9":null,"4s&BbC$":[["0dkkr","v$`5EN-w=",null,null,[],8.51235713234613e-24],-6651997402867507,{"":{";":{"$NUd(VF":"$",";Estggz\"_":"*rk7","Fl=>Ko%1!+":8.584378848805414e+192,"O*":false,"\\.9{(M,<":null,"x&PG":-7.587916677278743e+249,"xb=c]l/G":"zO.e,"}},"@lO":[true,true,["q",false,false,true,null,"X-ef\"oI>N","4%!2j+"]],"Dy":-1.5503264367762074e-135}],"level":"info","message":"Le!","timestamp":"2026-02-04 17:49:37:4937"}
{" ;s-Zfk6.":null,"'  qR{m*?":{"?@b0Jn":null,"]G":"`!","j<<d":"*lc@.B~dx","x":"1|];A<nk'","})sQnG":-5.849284729996672e+206,"}-js^":-1.3325328977498209e+141},"-) D<Z,":[6.0925729351633494e-192,-1.2122180709014395e+211,"&|\\1RCc-E","u7jaZa'`<",false,"|P88#",true],"8Q8eh0":-8526048246787669,"\\[":[4139928711865589,["?7jY&m&{`",["~8\\g0}]$",-1202882335166703,"V@};yWX",1.2717998671416142e+47,null,null,true]],[-8967684003128994,4315426142492401,false,true,-2631967153971149,true,false]],"level":"info","message":"Hy","timestamp":"2026-02-04 17:49:37:4937","zui6[+I":[null,"@y~","%}->X#","",3.425419489353119e-245,null]}
{"-]":-2.983595535128394e+171,";x ":true,"F6b&rF4":[],"JrRIC>":[{"*":9.871553394191778e+47,"6":7.079235486863149e-224,"E3x4Z}:":1.7484685933416686e-280,"[cmRy-":5981860421593917,"^)S^>CBX3o":"MszD&;B~g.","iD":3137532201348421,"vyQN.ZT>":"pb"},{"6I|mg;pX":-1.2588409995898252e-36}],"SC":[{"2":"MK!vgh^X-f","3tj6Ew":"S!5=Qx","67im":")?MeUwD?LT","7Ton":false,"Pir":2.3793037403009636e+257,"R7":true,"\\H'R":""},false,"M: NhU8#",false,-8023414783161663],"bIX8. `":{"!3dX\\[x9s!":";|dk5xT'<z","(M7E>(]":true,",":-1.3597630742313063e+89,"-p ":5219877564107753,"Iy\\IYVS5":true,"Vit;":true,"ZlIWok":"+tjvC","nq9":"Yk1e","tF-f %,":-4880155410170888},"cQ;s#)27F":["wbvfAeW@",-2.7898027380735053e+23,false,false,true],"level":"info","message":")S[,x=-","on(":"r!Z ","pF":null,"timestamp":"2026-02-04 17:49:37:4937"}
PASS src/__tests__/unit/routes/entitlements.test.ts
  Entitlements Routes
    GET /api/v1/entitlements/verify
      validation errors
        竏・should return 400 when neither unlock_token nor purchase_intent_id is provided (90 ms)
      verify by unlock_token
        竏・should return 401 when unlock_token is invalid (13 ms)
        竏・should return 401 with default message when error is not provided (9 ms)
        竏・should return entitlement status when unlock_token is valid (73 ms)
        竏・should return null expires_at when entitlement has no expiration (12 ms)
      verify by purchase_intent_id
        竏・should return 404 when no entitlement found for purchase_intent_id (37 ms)
        竏・should return entitlement status when purchase_intent_id is valid (55 ms)
        竏・should return null expires_at when no expiration date (58 ms)
        竏・should return suspended status correctly (8 ms)
      error handling
        竏・should return 500 when verifyUnlockToken throws an error (10 ms)
        竏・should return 500 when checkEntitlementStatus throws an error (27 ms)
      authentication
        竏・should work without API key (optionalApiKeyAuth) (10 ms)
        竏・should work with valid API key (10 ms)
    GET /api/v1/entitlements/:id
      authentication
        竏・should return 401 when API key is missing (9 ms)
        竏・should return 401 when API key is invalid (23 ms)
      with valid authentication
        竏・should return 404 when entitlement is not found (17 ms)
        竏・should return entitlement when found (12 ms)
        竏・should return null for optional fields when not set (9 ms)
        竏・should return revoked entitlement with reason (85 ms)
      error handling
        竏・should return 500 when getEntitlement throws an error (9 ms)
    GET /api/v1/entitlements/customer/:customerId
      authentication
        竏・should return 401 when API key is missing (8 ms)
        竏・should return 401 when API key is invalid (8 ms)
      with valid authentication
        竏・should return all entitlements for a customer (12 ms)
        竏・should return empty array when customer has no entitlements (8 ms)
        竏・should return active entitlements only when active_only=true (11 ms)
        竏・should return all entitlements when active_only is not true (9 ms)
        竏・should return all entitlements when active_only is not provided (73 ms)
      error handling
        竏・should return 500 when getEntitlementsByCustomerId throws an error (50 ms)
        竏・should return 500 when getActiveEntitlementsByCustomerId throws an error (8 ms)
    route precedence
      竏・should match /verify before /:id (16 ms)
      竏・should match /customer/:customerId before /:id (11 ms)

PASS src/__tests__/unit/services/LegalTemplateService.test.ts
  LegalTemplateService
    createTemplate
      竏・should create a legal template successfully (4 ms)
      竏・should pass through all parameters to repository (1 ms)
      竏・should propagate repository errors (117 ms)
    createDefaultTemplates
      竏・should create all three default templates for a developer (5 ms)
      竏・should replace {{effective_date}} placeholder in content (3 ms)
      竏・should set isDefault to true for all default templates (1 ms)
      竏・should create templates with correct types (1 ms)
      竏・should propagate errors during creation (1 ms)
    getTemplate
      竏・should return template by ID (1 ms)
      竏・should return null if template not found (1 ms)
      竏・should propagate repository errors (1 ms)
    getActiveTemplate
      竏・should return active template for developer and type (1 ms)
      竏・should return null if no active template exists
      竏・should work for all template types (1 ms)
    getActiveTemplates
      竏・should return all active templates organized by type (3 ms)
      竏・should return null for types without active templates (1 ms)
      竏・should return all nulls when no templates exist (3 ms)
    getDeveloperTemplates
      竏・should return all templates for a developer (2 ms)
      竏・should filter by type when provided (1 ms)
      竏・should return empty array when no templates exist (1 ms)
    getVersionHistory
      竏・should return version history for template type (1 ms)
      竏・should return empty array when no versions exist
    updateTemplate
      竏・should update template in place when createNewVersion is false (1 ms)
      竏・should create new version when content changes and createNewVersion is true (1 ms)
      竏・should update in place when content changes but createNewVersion is false (1 ms)
      竏・should return null if template not found (2 ms)
      竏・should not create new version when content is same (1 ms)
    activateTemplate
      竏・should activate a template successfully (5 ms)
      竏・should return null if template not found (1 ms)
      竏・should log template details on activation (1 ms)
    deleteTemplate
      竏・should delete a template successfully (1 ms)
      竏・should return false when template cannot be deleted (1 ms)
      竏・should propagate deletion errors (1 ms)
    recordAcceptance
      竏・should record acceptance for all specified types (3 ms)
      竏・should skip types without active templates (2 ms)
      竏・should pass context information to recordAcceptance (1 ms)
      竏・should handle empty types array (1 ms)
      竏・should handle missing context properties (13 ms)
    getCustomerAcceptances
      竏・should return customer acceptance history (4 ms)
      竏・should return empty array when no acceptances exist (1 ms)
    hasAcceptedAllTerms
      竏・should return true when all terms are accepted (2 ms)
      竏・should return false when some terms are not accepted (1 ms)
      竏・should return false when no terms are accepted (5 ms)
      竏・should check all three template types (17 ms)
    getLegalUrls
      竏・should return URLs for all active templates (4 ms)
      竏・should return null for types without active templates (2 ms)
      竏・should return all nulls when no active templates exist (1 ms)
      竏・should handle base URL without trailing slash (1 ms)
    notifyTemplateUpdate
      竏・should notify all customers who accepted the template (20 ms)
      竏・should not notify customers who have not accepted the template (2 ms)
      竏・should skip customers without email (2 ms)
      竏・should handle email sending failures gracefully (2 ms)
      竏・should use customer name in email when available (1 ms)
      竏・should use email as fallback when name is not available (3 ms)
      竏・should return 0 when no customers exist
      竏・should send correct subject for each template type (1 ms)
      竏・should send correct subject for refund policy (20 ms)
    DEFAULT_TEMPLATES
      竏・should export default templates constant (1 ms)
      竏・should have title and content for each template type (4 ms)
      竏・should contain effective_date placeholder in all default templates (5 ms)
    edge cases and error handling
      竏・should handle concurrent acceptance requests (3 ms)
      竏・should handle very long template content (1 ms)
      竏・should handle special characters in template content
      竏・should handle unicode characters in template content
      竏・should handle repository timeout errors (1 ms)
      竏・should handle all template types in recordAcceptance
      竏・should handle empty customer list in notifyTemplateUpdate (1 ms)
      竏・should continue notifying other customers if one fails (1 ms)
    constructor dependency injection
      竏・should use default repositories when not provided (2 ms)
      竏・should use injected repositories

PASS src/__tests__/unit/services/StripeClient.test.ts
  StripeClient
    constructor
      竏・should initialize Stripe with provided API key (48 ms)
      竏・should use default API key from config when not provided (2 ms)
    createCheckoutSession
      竏・should create a checkout session successfully (2 ms)
      竏・should include customer email when provided (1 ms)
      竏・should use customer ID when provided instead of email (4 ms)
      竏・should set customer_creation to always when no customer info provided (37 ms)
      竏・should add subscription_data for subscription mode (1 ms)
      竏・should include metadata in session (1 ms)
      竏・should log session creation (1 ms)
      竏・should handle Stripe card error (196 ms)
      竏・should handle Stripe rate limit error (2 ms)
      竏・should handle Stripe invalid request error (1 ms)
      竏・should handle Stripe API error (1 ms)
      竏・should handle Stripe connection error (3 ms)
      竏・should handle Stripe authentication error (1 ms)
      竏・should handle unknown errors (2 ms)
    getCheckoutSession
      竏・should retrieve a checkout session with expanded fields (1 ms)
      竏・should handle errors when retrieving session (1 ms)
    expireCheckoutSession
      竏・should expire a checkout session (1 ms)
      竏・should log when session is expired (1 ms)
      竏・should handle errors when expiring session (1 ms)
    createProduct
      竏・should create a product successfully (1 ms)
      竏・should create product without type in metadata when not provided (1 ms)
      竏・should log product creation
      竏・should handle errors when creating product (2 ms)
    updateProduct
      竏・should update a product with all fields (2 ms)
      竏・should update product with partial fields (1 ms)
      竏・should handle empty update params (1 ms)
      竏・should log product update (1 ms)
      竏・should handle errors when updating product (2 ms)
    archiveProduct
      竏・should archive a product by setting active to false (2 ms)
      竏・should log product archive
      竏・should handle errors when archiving product
    createPrice
      竏・should create a one-time price (1 ms)
      竏・should create a recurring price (1 ms)
      竏・should create a yearly recurring price
      竏・should convert currency to lowercase (1 ms)
      竏・should create price without metadata
      竏・should log price creation
      竏・should handle errors when creating price (1 ms)
    deactivatePrice
      竏・should deactivate a price (1 ms)
      竏・should log price deactivation (4 ms)
      竏・should handle errors when deactivating price (31 ms)
    findOrCreateCustomer
      竏・should return existing customer if found (2 ms)
      竏・should create new customer if not found (24 ms)
      竏・should create customer without name and metadata (1 ms)
      竏・should log when creating new customer (24 ms)
      竏・should handle errors when finding/creating customer (22 ms)
    createRefund
      竏・should create a partial refund (46 ms)
      竏・should create a full refund without amount (2 ms)
      竏・should handle duplicate reason (1 ms)
      竏・should handle fraudulent reason
      竏・should log refund creation (1 ms)
      竏・should handle errors when creating refund (2 ms)
    cancelSubscription
      竏・should cancel subscription immediately (2 ms)
      竏・should cancel subscription at period end (default) (1 ms)
      竏・should cancel subscription at period end with explicit false (1 ms)
      竏・should log subscription cancellation
      竏・should handle errors when canceling subscription (1 ms)
    verifyWebhookSignature
      竏・should verify webhook signature and return event (1 ms)
      竏・should handle Buffer payload (1 ms)
      竏・should throw error on invalid signature (14 ms)
    createBillingPortalSession
      竏・should create a billing portal session (1 ms)
      竏・should log portal session creation (1 ms)
      竏・should handle errors when creating portal session (2 ms)
    getSubscription
      竏・should retrieve a subscription (1 ms)
      竏・should handle errors when retrieving subscription (1 ms)
    getPaymentIntent
      竏・should retrieve a payment intent (1 ms)
      竏・should handle errors when retrieving payment intent (2 ms)
    createCoupon
      竏・should create a percentage off coupon (1 ms)
      竏・should create an amount off coupon (1 ms)
      竏・should create a coupon with custom ID (16 ms)
      竏・should create a coupon with max redemptions
      竏・should create a coupon with redeem by date (1 ms)
      竏・should log coupon creation (1 ms)
      竏・should handle errors when creating coupon (1 ms)
    updateCoupon
      竏・should update a coupon name (1 ms)
      竏・should update coupon metadata (1 ms)
      竏・should handle empty update params
      竏・should log coupon update (1 ms)
      竏・should handle errors when updating coupon (1 ms)
    deleteCoupon
      竏・should delete a coupon (1 ms)
      竏・should log coupon deletion (1 ms)
      竏・should handle errors when deleting coupon (1 ms)
    getCoupon
      竏・should retrieve a coupon (1 ms)
      竏・should handle errors when retrieving coupon (2 ms)
    error handling edge cases
      竏・should handle non-Error thrown values (2 ms)
      竏・should preserve Error instance for unknown error types (1 ms)
    singleton export
      竏・should export a stripeClient singleton (33 ms)

PASS src/__tests__/unit/routes/currency.test.ts
  Currency Routes
    GET /currencies
      竏・should return all supported currencies (72 ms)
      竏・should return currencies with all expected fields (112 ms)
      竏・should return empty array when no currencies configured (385 ms)
      竏・should return 500 when service throws error (82 ms)
    GET /currencies/rates
      竏・should return all exchange rates (57 ms)
      竏・should return rates with expected fields (97 ms)
      竏・should return correct rate values (8 ms)
      竏・should return empty rates array when no rates available (7 ms)
      竏・should return 500 when service throws error (75 ms)
    POST /currencies/convert
      竏・should convert amount between currencies successfully (21 ms)
      竏・should include formatted amounts in response (7 ms)
      竏・should return 400 for invalid amount (string) (7 ms)
      竏・should return 400 for negative amount (9 ms)
      竏・should return 400 for null amount (10 ms)
      竏・should return 400 for unsupported fromCurrency (17 ms)
      竏・should return 400 for unsupported toCurrency (9 ms)
      竏・should handle zero amount (48 ms)
      竏・should handle same currency conversion (7 ms)
      竏・should return 500 when service throws error (7 ms)
      竏・should handle null exchange rate display (31 ms)
    POST /currencies/convert-all
      竏・should convert USD amount to all currencies (52 ms)
      竏・should return prices for all currencies (43 ms)
      竏・should include amount and formatted for each currency (8 ms)
      竏・should return 400 for invalid amount (48 ms)
      竏・should return 400 for negative amount (10 ms)
      竏・should return 400 for missing amount (8 ms)
      竏・should handle zero amount (10 ms)
      竏・should handle large amounts (10 ms)
      竏・should return 500 when service throws error (8 ms)
    GET /currencies/:code
      竏・should return currency details for valid currency code (15 ms)
      竏・should return minimum charge info (8 ms)
      竏・should return exchange rate info (9 ms)
      竏・should handle uppercase currency code (6 ms)
      竏・should handle mixed case currency code (22 ms)
      竏・should return 404 for unsupported currency (8 ms)
      竏・should handle null exchange rate (12 ms)
      竏・should return CNY currency details (18 ms)
      竏・should return JPY currency details with 0 decimal places (8 ms)
      竏・should return 500 when service throws error (7 ms)
    POST /currencies/format
      竏・should format amount successfully (22 ms)
      竏・should use default locale when not provided (6 ms)
      竏・should use provided locale (9 ms)
      竏・should format CNY amounts correctly (7 ms)
      竏・should format JPY amounts without decimals (7 ms)
      竏・should return 400 for invalid amount (9 ms)
      竏・should return 400 for null amount (8 ms)
      竏・should return 400 for unsupported currency (33 ms)
      竏・should handle negative amounts (51 ms)
      竏・should handle zero amount (10 ms)
      竏・should handle uppercase currency code (24 ms)
      竏・should return 500 when service throws error (15 ms)
    POST /currencies/validate-minimum
      竏・should validate valid amount meets minimum (11 ms)
      竏・should validate invalid amount below minimum (32 ms)
      竏・should validate exactly minimum amount (56 ms)
      竏・should validate CNY minimum charge (8 ms)
      竏・should validate JPY minimum charge (8 ms)
      竏・should return 400 for invalid amount (38 ms)
      竏・should return 400 for null amount (8 ms)
      竏・should return 400 for missing amount (36 ms)
      竏・should return 400 for unsupported currency (7 ms)
      竏・should handle uppercase currency code (6 ms)
      竏・should handle zero amount (100 ms)
      竏・should return 500 when service throws error (12 ms)
    Content-Type and Headers
      竏・should return JSON content type for GET endpoints (7 ms)
      竏・should return JSON content type for POST endpoints (11 ms)
    Edge Cases
      竏・should handle very large numbers in convert (16 ms)
      竏・should handle decimal amounts in convert (10 ms)
      竏・should handle empty request body for POST (9 ms)
      竏・should handle missing request body for POST (131 ms)

PASS src/__tests__/unit/repositories/CheckoutSessionRepository.test.ts
  CheckoutSessionRepository
    create
      竏・should create a new checkout session with all fields (8 ms)
      竏・should create a checkout session without optional customerId (2 ms)
      竏・should use default status of open when not provided (2 ms)
      竏・should throw error on database failure (218 ms)
      竏・should use provided client for transactions (7 ms)
    findById
      竏・should find a checkout session by ID (2 ms)
      竏・should return null if checkout session not found (1 ms)
      竏・should throw error on database failure (50 ms)
      竏・should use provided client for transactions (1 ms)
    findByStripeSessionId
      竏・should find a checkout session by Stripe session ID (10 ms)
      竏・should return null if checkout session not found (2 ms)
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (1 ms)
    findByPurchaseIntentId
      竏・should find a checkout session by purchase intent ID (1 ms)
      竏・should return null if checkout session not found (1 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    findByDeveloperId
      竏・should find all checkout sessions for a developer (2 ms)
      竏・should filter by status when provided (1 ms)
      竏・should respect custom limit (2 ms)
      竏・should respect custom limit with status filter (1 ms)
      竏・should return sessions ordered by created_at descending (1 ms)
      竏・should return empty array if no sessions found (25 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    update
      竏・should update checkout session status (3 ms)
      竏・should update checkout session customerId (1 ms)
      竏・should update multiple fields at once (1 ms)
      竏・should return null if checkout session not found (1 ms)
      竏・should return existing session if no updates provided (5 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (2 ms)
    markComplete
      竏・should mark checkout session as complete without customerId (1 ms)
      竏・should mark checkout session as complete with customerId (1 ms)
      竏・should return null if checkout session not found (1 ms)
      竏・should use provided client for transactions (1 ms)
    markExpired
      竏・should mark checkout session as expired (1 ms)
      竏・should return null if checkout session not found (1 ms)
      竏・should use provided client for transactions (1 ms)
    findExpiredSessions
      竏・should find all expired checkout sessions (2 ms)
      竏・should return empty array if no expired sessions found (1 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    delete
      竏・should delete a checkout session (1 ms)
      竏・should return false if checkout session not found (1 ms)
      竏・should handle null rowCount (2 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (3 ms)
    edge cases
      竏・should handle checkout session with null customerId (35 ms)
      竏・should handle different checkout session statuses (16 ms)
      竏・should handle URLs with query parameters (2 ms)
      竏・should handle very long Stripe session ID (1 ms)
      竏・should properly map dates from database rows (14 ms)
      竏・should handle multiple sessions for same product (110 ms)
      竏・should handle session expiration in the past (4 ms)
      竏・should handle session expiration far in the future (6 ms)
    error logging
      竏・should log error when create fails (87 ms)
      竏・should log error when findById fails (1 ms)
      竏・should log error when findByStripeSessionId fails (4 ms)
      竏・should log error when findByPurchaseIntentId fails (2 ms)
      竏・should log error when findByDeveloperId fails (3 ms)
      竏・should log error when findExpiredSessions fails (2 ms)
      竏・should log error when update fails (3 ms)
      竏・should log error when delete fails (75 ms)
      竏・should log success when checkout session is created (1 ms)
      竏・should log success when checkout session is updated (1 ms)
      竏・should log success when checkout session is deleted (4 ms)
      竏・should not log delete when session not found (1 ms)

PASS src/__tests__/unit/routes/gdpr.test.ts (6.708 s)
  GDPR Routes
    POST /api/v1/gdpr/requests
      Input Validation
        竏・should return 400 when customerEmail is missing (230 ms)
        竏・should return 400 when customerEmail is not a string (70 ms)
        竏・should return 400 when customerEmail is empty string (56 ms)
        竏・should return 400 when requestType is missing (45 ms)
        竏・should return 400 when requestType is invalid (9 ms)
      Successful Request Creation
        竏・should create a GDPR request with data_export type (10 ms)
        竏・should create a GDPR request with data_deletion type (17 ms)
        竏・should create a GDPR request with data_rectification type (10 ms)
        竏・should pass correct parameters to gdprService.createRequest (40 ms)
        竏・should handle optional fields (392 ms)
      Error Handling
        竏・should return 500 when service throws an error (82 ms)
        竏・should log error when service throws (58 ms)
      Authentication
        竏・should apply apiKeyAuth middleware (11 ms)
        竏・should return 401 when authentication fails (34 ms)
    GET /api/v1/gdpr/requests
      Successful Listing
        竏・should list GDPR requests with default pagination (13 ms)
        竏・should pass custom pagination parameters (50 ms)
        竏・should pass status filter parameter (39 ms)
        竏・should return mapped request objects (65 ms)
        竏・should handle invalid pagination values gracefully (110 ms)
      Error Handling
        竏・should return 500 when service throws an error (7 ms)
        竏・should log error when service throws (6 ms)
    GET /api/v1/gdpr/requests/:id
      Successful Request Retrieval
        竏・should return GDPR request by ID (9 ms)
        竏・should pass correct ID to service (9 ms)
      Not Found
        竏・should return 404 when request not found (8 ms)
      Access Control
        竏・should return 403 when request belongs to different developer (6 ms)
        竏・should allow access when developer IDs match (12 ms)
      Error Handling
        竏・should return 500 when service throws an error (25 ms)
        竏・should log error when service throws (30 ms)
    POST /api/v1/gdpr/requests/:id/process
      Successful Processing
        竏・should process a pending GDPR request (10 ms)
        竏・should call processRequest with correct ID (8 ms)
      Validation
        竏・should return 404 when request not found (10 ms)
        竏・should return 403 when request belongs to different developer (31 ms)
        竏・should return 400 when request is not pending (9 ms)
        竏・should return 400 for requests with processing status (9 ms)
        竏・should return 400 for failed requests (7 ms)
      Error Handling
        竏・should return 500 when service throws an error (50 ms)
        竏・should log error when service throws (9 ms)
    POST /api/v1/gdpr/requests/:id/cancel
      Successful Cancellation
        竏・should cancel a pending GDPR request (38 ms)
        竏・should call cancelRequest with correct ID (14 ms)
      Validation
        竏・should return 404 when request not found (61 ms)
        竏・should return 403 when request belongs to different developer (12 ms)
        竏・should return 400 when request cannot be cancelled (11 ms)
      Error Handling
        竏・should return 500 when service throws an error (12 ms)
        竏・should log error when service throws (17 ms)
    POST /api/v1/gdpr/export
      Input Validation
        竏・should return 400 when customerEmail is missing (11 ms)
        竏・should return 400 when customerEmail is not a string (15 ms)
        竏・should return 400 when customerEmail is empty string (32 ms)
      Successful Export
        竏・should export customer data (14 ms)
        竏・should pass correct parameters to exportCustomerData (9 ms)
      Customer Not Found
        竏・should return 404 when customer not found (26 ms)
      Error Handling
        竏・should return 500 for other errors (21 ms)
        竏・should log error for non-customer-not-found errors (67 ms)
        竏・should not log error for customer not found (38 ms)
    DELETE /api/v1/gdpr/customer
      Input Validation
        竏・should return 400 when customerEmail is missing (10 ms)
        竏・should return 400 when customerEmail is not a string (11 ms)
        竏・should return 400 when customerEmail is empty string (8 ms)
      Successful Deletion
        竏・should delete customer data (10 ms)
        竏・should pass keepTransactionRecords=true by default (8 ms)
        竏・should pass keepTransactionRecords=true when explicitly set (12 ms)
        竏・should pass keepTransactionRecords=false when explicitly set to false (8 ms)
        竏・should handle undefined keepTransactionRecords as true (7 ms)
      Customer Not Found
        竏・should return 404 when customer not found (7 ms)
      Error Handling
        竏・should return 500 for other errors (12 ms)
        竏・should log error for non-customer-not-found errors (10 ms)
        竏・should not log error for customer not found (54 ms)
    Route Configuration
      竏・should reject non-POST methods on /requests (135 ms)
      竏・should reject non-POST methods on /requests/:id/process (286 ms)
      竏・should reject non-POST methods on /requests/:id/cancel (33 ms)
      竏・should reject non-DELETE methods on /customer (31 ms)
      竏・should reject non-POST methods on /export (85 ms)
    Response Format
      竏・should return JSON content type (9 ms)
      竏・should return properly formatted dates in ISO format (10 ms)
    Edge Cases
      竏・should handle special characters in customerEmail (9 ms)
      竏・should handle unicode in reason field (41 ms)
      竏・should handle large dataCategories array (14 ms)
      竏・should handle concurrent requests (27 ms)
      竏・should handle request with all valid request types (46 ms)

PASS src/__tests__/unit/services/DeveloperService.test.ts
  DeveloperService
    register
      竏・should register a new developer successfully (53 ms)
      竏・should throw error if email already registered (164 ms)
      竏・should register in live mode when specified (1 ms)
      竏・should continue if legal template creation fails (41 ms)
      竏・should continue if email sending fails (1 ms)
    regenerateApiKey
      竏・should regenerate API key successfully (1 ms)
      竏・should throw error if developer not found
      竏・should generate live mode key for live developer (1 ms)
    validateApiKey
      竏・should return developer for valid API key (1 ms)
      竏・should return null for invalid API key
    getDeveloper
      竏・should return developer by ID (1 ms)
      竏・should return null if not found (3 ms)
    getDeveloperByEmail
      竏・should return developer by email (1 ms)
    updateSettings
      竏・should update developer settings (1 ms)
    connectStripeAccount
      竏・should connect Stripe account (1 ms)
    getOnboardingStatus
      竏・should return onboarding status with incomplete steps (2 ms)
      竏・should return null if developer not found
      竏・should show correct next step when Stripe is connected (1 ms)
    switchMode
      竏・should switch to live mode (1 ms)
      竏・should switch to test mode
    deleteAccount
      竏・should delete developer account
      竏・should return false if deletion fails
    API key format
      竏・should generate valid test mode API key format (1 ms)
      竏・should generate valid live mode API key format (1 ms)

PASS src/__tests__/unit/services/MagicLinkService.test.ts
  MagicLinkService
    sendMagicLink
      竏・should send magic link successfully when customer exists (74 ms)
      竏・should return success but not send email when customer does not exist (2 ms)
      竏・should use email as name fallback when customer has no name
      竏・should throw error when database query fails (113 ms)
      竏・should throw error when Redis fails (37 ms)
      竏・should throw error when email sending fails (1 ms)
      竏・should generate JWT token with correct payload (1 ms)
    verifyMagicLink
      竏・should verify magic link and create session successfully (3 ms)
      竏・should return error when magic link is expired or already used (1 ms)
      竏・should return error when customer ID does not match (1 ms)
      竏・should return error when JWT token is expired
      竏・should return error when JWT token is invalid
      竏・should throw error for unexpected errors (2 ms)
      竏・should delete magic link token after successful verification
    verifySession
      竏・should return valid session (1 ms)
      竏・should return null when session does not exist (5 ms)
      竏・should return null and destroy expired session (2 ms)
      竏・should return null on Redis error (1 ms)
      竏・should convert date strings to Date objects (43 ms)
    destroySession
      竏・should destroy session successfully (2 ms)
      竏・should not throw error when session does not exist (1 ms)
    refreshSession
      竏・should refresh session and extend expiration (3 ms)
      竏・should return null when session does not exist (1 ms)
      竏・should return null for expired session (16 ms)
      竏・should update expiresAt to new future date (2 ms)
    constructor
      竏・should use default dependencies when none provided
      竏・should accept custom dependencies (1 ms)
    email content generation
      竏・should include magic link URL in email HTML content (1 ms)
      竏・should include magic link URL in email text content
      竏・should personalize email with customer name (1 ms)
      竏・should use email as fallback when customer has no name (1 ms)
    TTL constants
      竏・should use correct magic link TTL (15 minutes) (1 ms)
      竏・should use correct session TTL (24 hours) (1 ms)
    security features
      竏・should use single-use tokens (delete after verification) (2 ms)
      竏・should not reveal if customer exists or not (1 ms)
      竏・should validate stored customer ID matches token payload (1 ms)

PASS src/__tests__/unit/services/CouponService.test.ts
  CouponService
    createCoupon
      竏・should create a percentage coupon successfully (4 ms)
      竏・should throw error for invalid percentage discount over 100 (428 ms)
      竏・should throw error for percentage discount of 0 (2 ms)
      竏・should throw error for fixed amount without currency (1 ms)
      竏・should create fixed amount coupon with currency (7 ms)
      竏・should throw error if coupon code already exists
      竏・should validate product IDs if appliesToProducts is provided
      竏・should continue without Stripe if Stripe fails (1 ms)
    validateCoupon
      竏・should return valid for active coupon (1 ms)
      竏・should return invalid if coupon not found
      竏・should return invalid if coupon is inactive
      竏・should return invalid if coupon has expired (1 ms)
      竏・should return invalid if max redemptions reached (1 ms)
      竏・should return invalid if below minimum purchase amount
      竏・should return invalid if product not in allowed list (1 ms)
      竏・should return invalid for currency mismatch with fixed amount
      竏・should return invalid if customer already redeemed (1 ms)
    calculateDiscount
      竏・should calculate percentage discount correctly (1 ms)
      竏・should calculate fixed amount discount correctly (1 ms)
      竏・should cap fixed discount at original amount
      竏・should floor percentage discount for rounding (1 ms)
    applyCoupon
      竏・should apply coupon and record redemption (1 ms)
      竏・should throw error if validation fails (6 ms)
      竏・should throw error if no customerId provided (2 ms)
    getCoupon
      竏・should return coupon by ID (1 ms)
      竏・should return null if not found (1 ms)
    getCouponByCode
      竏・should return coupon by code (1 ms)
    listCoupons
      竏・should return coupons for developer
    updateCoupon
      竏・should update coupon successfully (1 ms)
      竏・should return null if coupon not found (1 ms)
      竏・should update Stripe coupon if synced
    deactivateCoupon
      竏・should deactivate coupon successfully (10 ms)
      竏・should delete Stripe coupon if synced (1 ms)
    deleteCoupon
      竏・should delete coupon successfully (1 ms)
      竏・should return false if coupon not found
    getCouponStats
      竏・should return coupon statistics (1 ms)
      竏・should return null if coupon not found (1 ms)
      竏・should handle zero redemptions
    getCustomerRedemptions
      竏・should return customer redemptions (1 ms)

PASS src/__tests__/unit/services/EntitlementService.test.ts
  EntitlementService
    grantEntitlement
      竏・should grant new entitlement successfully (3 ms)
      竏・should return existing entitlement if already exists (1 ms)
      竏・should grant subscription entitlement with expiry (25 ms)
      竏・should rollback on error (61 ms)
    checkEntitlementStatus
      竏・should return active status for valid entitlement (26 ms)
      竏・should return no access for non-existent entitlement (2 ms)
      竏・should return expired status for expired entitlement (22 ms)
      竏・should return suspended status for suspended entitlement (1 ms)
      竏・should return active for entitlement with future expiry (1 ms)
    getEntitlement
      竏・should return entitlement by ID (1 ms)
      竏・should return null if not found (1 ms)
    getEntitlementByPurchaseIntentId
      竏・should return entitlement by purchase intent ID (1 ms)
    verifyUnlockToken
      竏・should verify valid unlock token (1 ms)
      竏・should return invalid for expired token (1 ms)
      竏・should return invalid for invalid token (1 ms)
    suspendEntitlement
      竏・should suspend entitlement successfully (2 ms)
      竏・should return null if entitlement not found (3 ms)
    reactivateEntitlement
      竏・should reactivate suspended entitlement (22 ms)
    revokeEntitlement
      竏・should revoke entitlement successfully (1 ms)
    renewEntitlement
      竏・should renew subscription entitlement (2 ms)
      竏・should return null if entitlement not found
      竏・should rollback and throw error on database failure (21 ms)
    suspendEntitlement error handling
      竏・should rollback and throw error on database failure (1 ms)
    revokeEntitlement error handling
      竏・should return null if entitlement not found (1 ms)
      竏・should rollback and throw error on database failure (6 ms)
    reactivateEntitlement error handling
      竏・should return null if entitlement not found (1 ms)
      竏・should rollback and throw error on database failure (2 ms)
    getEntitlementBySubscriptionId
      竏・should return entitlement by subscription ID (1 ms)
      竏・should return null if not found (1 ms)
    getEntitlementsByCustomerId
      竏・should return all entitlements for customer (1 ms)
      竏・should return empty array if no entitlements found
    getActiveEntitlementsByCustomerId
      竏・should return only active entitlements for customer
      竏・should return empty array if no active entitlements
    constructor dependency injection
      竏・should use injected dependencies (3 ms)

PASS src/__tests__/unit/routes/invoices.test.ts
  Invoices Routes
    GET /invoices
      竏・should list invoices for authenticated developer (73 ms)
      竏・should use custom limit and offset (12 ms)
      竏・should filter by status (10 ms)
      竏・should handle invoices with null paidAt (10 ms)
      竏・should return empty array when no invoices exist (82 ms)
      竏・should return 401 when API key is missing (10 ms)
      竏・should return 500 on service error (45 ms)
      竏・should default to limit 50 and offset 0 for invalid query params (8 ms)
    GET /invoices/:id
      竏・should retrieve an invoice by ID (11 ms)
      竏・should return 404 when invoice is not found (7 ms)
      竏・should return 403 when invoice belongs to different developer (29 ms)
      竏・should return 401 when API key is missing (10 ms)
      竏・should return 500 on service error (51 ms)
    GET /invoices/:id/pdf
      竏・should generate and return PDF invoice (25 ms)
      竏・should return 404 when invoice is not found (43 ms)
      竏・should return 403 when invoice belongs to different developer (12 ms)
      竏・should return 500 when PDF generation fails (12 ms)
      竏・should return 500 on service error (11 ms)
      竏・should return 401 when API key is missing (25 ms)
    GET /invoices/:id/html
      竏・should generate and return HTML invoice (8 ms)
      竏・should return 404 when invoice is not found (8 ms)
      竏・should return 403 when invoice belongs to different developer (11 ms)
      竏・should return 500 when HTML generation fails (8 ms)
      竏・should return 500 on service error (9 ms)
      竏・should return 401 when API key is missing (23 ms)
    POST /invoices/:id/send
      竏・should send invoice email successfully (28 ms)
      竏・should return 404 when invoice is not found (9 ms)
      竏・should return 403 when invoice belongs to different developer (20 ms)
      竏・should return 500 when email sending fails (8 ms)
      竏・should return 500 on service error (27 ms)
      竏・should return 401 when API key is missing (50 ms)
    POST /invoices/:id/void
      竏・should void an invoice successfully (8 ms)
      竏・should return 404 when invoice is not found (11 ms)
      竏・should return 403 when invoice belongs to different developer (11 ms)
      竏・should return 400 when invoice cannot be voided (9 ms)
      竏・should return 400 with specific message when void throws "Cannot void" error (8 ms)
      竏・should return 500 on other service errors (10 ms)
      竏・should return 401 when API key is missing (8 ms)
    GET /invoices/customer/:customerId
      竏・should get invoices for a specific customer (9 ms)
      竏・should use custom limit and offset (12 ms)
      竏・should filter out invoices belonging to other developers (7 ms)
      竏・should return empty array when no invoices belong to developer (10 ms)
      竏・should handle invoices with null paidAt (8 ms)
      竏・should return 500 on service error (10 ms)
      竏・should return 401 when API key is missing (7 ms)
    Edge Cases
      竏・should handle multiple invoices in list response (81 ms)
      竏・should handle invoice with all optional fields as null (58 ms)
      竏・should handle large PDF buffer (211 ms)
      竏・should handle special characters in invoice ID (10 ms)
      竏・should handle HTML with special characters (8 ms)
      竏・should handle different invoice statuses correctly (38 ms)
      竏・should handle different currencies correctly (36 ms)
    Response Format
      竏・should return correct Content-Type header for JSON responses (10 ms)
      竏・should return correct Content-Type header for PDF responses (10 ms)
      竏・should return correct Content-Type header for HTML responses (6 ms)
      竏・should format dates as ISO 8601 strings in list response (7 ms)

PASS src/__tests__/unit/routes/portal.test.ts (6.33 s)
  Portal Routes
    Portal Auth Middleware
      竏・should return 401 when no session is provided (214 ms)
      竏・should return 401 when session is invalid or expired (98 ms)
      竏・should authenticate with x-portal-session header (58 ms)
      竏・should authenticate with portal_session cookie (90 ms)
      竏・should return 500 when verifySession throws an error (21 ms)
    POST /portal/auth/magic-link
      竏・should send magic link successfully (78 ms)
      竏・should return 400 when email is missing (88 ms)
      竏・should return 400 when email is not a string (10 ms)
      竏・should return 400 when email is null (132 ms)
      竏・should return 500 when sendMagicLink fails (134 ms)
    GET /portal/auth/verify
      竏・should verify magic link and create session successfully (38 ms)
      竏・should return 400 when token is missing (10 ms)
      竏・should return 400 when token is not a string (39 ms)
      竏・should return 401 when magic link verification fails (28 ms)
      竏・should return 401 with default error when no specific error provided (22 ms)
      竏・should return 500 when verifyMagicLink throws an error (9 ms)
    POST /portal/auth/logout
      竏・should logout successfully (44 ms)
      竏・should return 401 when not authenticated (8 ms)
      竏・should return 500 when destroySession fails (10 ms)
    GET /portal/me
      竏・should return current customer info successfully (8 ms)
      竏・should return 401 when not authenticated (9 ms)
      竏・should return 404 when customer not found (8 ms)
      竏・should return 500 when findById fails (35 ms)
    GET /portal/subscriptions
      竏・should return subscriptions successfully (13 ms)
      竏・should filter out non-subscription entitlements (32 ms)
      竏・should return empty subscriptions when no subscription entitlements exist (17 ms)
      竏・should handle Stripe API error gracefully for individual subscription (10 ms)
      竏・should handle canceled subscription with canceledAt date (55 ms)
      竏・should return 401 when not authenticated (85 ms)
      竏・should return 500 when getEntitlementsByCustomerId fails (6 ms)
    GET /portal/entitlements
      竏・should return all entitlements successfully (47 ms)
      竏・should return empty entitlements when none exist (27 ms)
      竏・should return 401 when not authenticated (13 ms)
      竏・should return 500 when getEntitlementsByCustomerId fails (29 ms)
    POST /portal/subscriptions/:id/cancel
      竏・should cancel subscription at period end successfully (37 ms)
      竏・should cancel subscription immediately when requested (10 ms)
      竏・should return 404 when subscription not found (95 ms)
      竏・should return 403 when customer does not own the subscription (7 ms)
      竏・should return 400 when entitlement is not a subscription (33 ms)
      竏・should return 401 when not authenticated (25 ms)
      竏・should return 500 when Stripe cancelSubscription fails (44 ms)
    GET /portal/billing
      竏・should return billing portal URL successfully (110 ms)
      竏・should use custom return_url when provided (8 ms)
      竏・should return 404 when customer not found (8 ms)
      竏・should return 404 when customer has no stripeCustomerId (77 ms)
      竏・should return 401 when not authenticated (7 ms)
      竏・should return 500 when createBillingPortalSession fails (43 ms)
    GET /portal/invoices
      竏・should return invoices message when customer has stripeCustomerId (8 ms)
      竏・should return empty invoices when customer not found (10 ms)
      竏・should return empty invoices when customer has no stripeCustomerId (9 ms)
      竏・should return 401 when not authenticated (9 ms)
      竏・should return 500 when findById fails (12 ms)
    Edge Cases
      竏・should handle entitlement with null expiresAt (13 ms)
      竏・should handle customer with null name (8 ms)
      竏・should handle multiple entitlements with different statuses (33 ms)
      竏・should handle subscriptions with all statuses correctly (68 ms)
    Response Format
      竏・should return correct Content-Type header (69 ms)
      竏・should return ISO 8601 formatted dates for entitlements (62 ms)
      竏・should return proper dates for subscription period dates (7 ms)
    portalAuth export
      竏・should export portalAuth middleware (2 ms)

PASS src/__tests__/unit/routes/webhooks.test.ts
  Webhooks Routes
    POST /api/v1/webhooks/stripe
      Rate Limiting
        竏・should apply webhookRateLimiter middleware (56 ms)
        竏・should return 429 when rate limit is exceeded (103 ms)
      Signature Validation
        竏・should return 401 when stripe-signature header is missing (38 ms)
        竏・should log warning when signature is missing (13 ms)
        竏・should return 401 when signature is empty string (8 ms)
        竏・should return 401 when signature is invalid (17 ms)
        竏・should not call processWebhook when signature header is missing (8 ms)
      Successful Webhook Processing
        竏・should return 200 with success response when webhook is processed (7 ms)
        竏・should return 200 with processed=false when event was already processed (50 ms)
        竏・should pass payload and signature to webhookProcessor (9 ms)
        竏・should handle various webhook event types (240 ms)
      Failed Webhook Processing
        竏・should return 200 with error when processing fails with non-signature error (34 ms)
        竏・should return 200 even when processor throws exception (13 ms)
        竏・should log error when processing throws exception (12 ms)
        竏・should return 200 to prevent Stripe retries on processing errors (8 ms)
      Request Body Handling
        竏・should handle raw body payload (14 ms)
        竏・should handle empty body (14 ms)
        竏・should handle malformed JSON body gracefully (10 ms)
      Edge Cases
        竏・should handle very long signature header (8 ms)
        竏・should handle special characters in signature (8 ms)
        竏・should handle concurrent webhook requests (147 ms)
        竏・should handle large payload (27 ms)
      Response Format
        竏・should return JSON content type (14 ms)
        竏・should include received=true in success response (23 ms)
        竏・should include received=true even in error response (13 ms)
        竏・should use snake_case for response fields (7 ms)
      Error Response Format
        竏・should return proper error structure for missing signature (14 ms)
        竏・should return proper error structure for invalid signature (7 ms)
    Route Configuration
      竏・should only accept POST requests (63 ms)
      竏・should respond to POST requests (33 ms)
    Integration with webhookProcessor
      竏・should correctly differentiate between signature error and other errors (48 ms)

PASS src/__tests__/unit/services/CheckoutService.test.ts
  CheckoutService
    createSession
      竏・should create a checkout session successfully (6 ms)
      竏・should throw error when product is not found (289 ms)
      竏・should throw error when product is not active (22 ms)
      竏・should throw error when price is not found (37 ms)
      竏・should throw error when price is not active (2 ms)
      竏・should throw error when price does not belong to product (1 ms)
      竏・should return existing open session for same purchase intent (1 ms)
      竏・should create new session if existing session is not open (1 ms)
      竏・should use subscription mode for subscription products (1 ms)
      竏・should use payment mode for one_time products
      竏・should find alternative price when currency does not match (4 ms)
      竏・should use original price if no alternative currency price found (1 ms)
      竏・should default currency to usd if not provided
      竏・should pass metadata to Stripe checkout session (4 ms)
      竏・should rollback transaction and rethrow on Stripe error (5 ms)
      竏・should rollback transaction and rethrow on database error (2 ms)
      竏・should pass customerEmail to Stripe checkout session (2 ms)
      竏・should pass success and cancel URLs to Stripe checkout session (1 ms)
    getSession
      竏・should return session by ID (1 ms)
      竏・should return null if session not found (1 ms)
    getSessionByStripeId
      竏・should return session by Stripe session ID (2 ms)
      竏・should return null if session not found
    getSessionByPurchaseIntentId
      竏・should return session by purchase intent ID (1 ms)
      竏・should return null if session not found
    markSessionComplete
      竏・should mark session as complete (2 ms)
      竏・should mark session as complete with customer ID
      竏・should return null if session not found (1 ms)
    markSessionExpired
      竏・should mark session as expired (1 ms)
      竏・should return null if session not found
    expireSession
      竏・should expire session in both Stripe and database (1 ms)
      竏・should return null if session not found (1 ms)
      竏・should continue to mark expired even if Stripe expire fails (1 ms)
    processExpiredSessions
      竏・should process and mark all expired sessions (4 ms)
      竏・should return 0 when no expired sessions found (1 ms)
      竏・should continue processing other sessions if one fails (4 ms)
    getSessionsByDeveloper
      竏・should return sessions for developer (1 ms)
      竏・should filter by status (22 ms)
      竏・should respect custom limit
      竏・should return empty array when no sessions found (1 ms)
      竏・should filter by complete status
      竏・should filter by expired status (1 ms)
    constructor dependency injection
      竏・should use injected repositories (1 ms)
      竏・should use default repositories when not injected (1 ms)

PASS src/__tests__/unit/services/InvoiceService.test.ts
  InvoiceService
    generateFromPayment
      竏・should generate invoice from payment successfully (4 ms)
      竏・should use item description if product not found (2 ms)
      竏・should use product name as fallback when no description (1 ms)
      竏・should use "Product" as fallback when no description and product not found (2 ms)
      竏・should calculate correct totals (1 ms)
      竏・should default taxAmount to 0 if not provided (38 ms)
    getInvoice
      竏・should return invoice by ID (1 ms)
      竏・should return null if invoice not found (1 ms)
    getInvoiceByNumber
      竏・should return invoice by invoice number (1 ms)
      竏・should return null if invoice not found (1 ms)
    getCustomerInvoices
      竏・should return invoices for customer (2 ms)
      竏・should pass options to repository (1 ms)
      竏・should return empty array if no invoices (1 ms)
    getDeveloperInvoices
      竏・should return invoices for developer (2 ms)
      竏・should pass options to repository (1 ms)
      竏・should return empty invoices if none found
    markAsPaid
      竏・should mark invoice as paid (1 ms)
      竏・should return null if invoice not found
    voidInvoice
      竏・should void an issued invoice (1 ms)
      竏・should return null if invoice not found (1 ms)
      竏・should throw error when trying to void a paid invoice (304 ms)
      竏・should void a draft invoice (2 ms)
    generatePdfData
      竏・should generate PDF data successfully (3 ms)
      竏・should return null if invoice not found (1 ms)
      竏・should return null if customer not found (1 ms)
      竏・should use customer email as name if name not available
      竏・should format billing address correctly (1 ms)
      竏・should handle invoice without billing address (1 ms)
      竏・should use current date if issuedAt is not set (1 ms)
      竏・should handle null dueDate (1 ms)
      竏・should include notes if available (1 ms)
      竏・should handle invoice without notes (1 ms)
    generateHtmlInvoice
      竏・should generate HTML invoice successfully (21 ms)
      竏・should return null if invoice not found
      竏・should return null if customer not found (1 ms)
      竏・should include all line items in HTML (1 ms)
    generatePdfInvoice
      竏・should generate PDF invoice buffer successfully (4 ms)
      竏・should return null if invoice not found (1 ms)
      竏・should return null if customer not found (1 ms)
    generateAndSavePdfInvoice
      竏・should generate and return PDF with filename (3 ms)
      竏・should return null if PDF generation fails (1 ms)
      竏・should return null if invoice not found after PDF generation (1 ms)
    sendInvoiceEmail
      竏・should send invoice email successfully (2 ms)
      竏・should return false if invoice not found (1 ms)
      竏・should return false if customer not found (50 ms)
      竏・should return false if HTML generation fails (3 ms)
      竏・should return false if email sending fails (1 ms)
      竏・should use customer email as name if name not available (1 ms)
    formatAddress (private method via generatePdfData)
      竏・should format full address correctly (3 ms)
      竏・should handle partial address (2 ms)
      竏・should handle address with only country (4 ms)
    constructor dependency injection
      竏・should allow custom repositories to be injected (1 ms)
    edge cases
      竏・should handle invoice with empty line items
      竏・should handle different invoice statuses in PDF data (1 ms)
      竏・should handle multiple items with calculateTotals (1 ms)
      竏・should handle currency formatting for different currencies (1 ms)

PASS src/__tests__/unit/middleware/validation.test.ts
  Validation Middleware
    validate
      successful validation
        竏・should call next on successful body validation (82 ms)
        竏・should call next on successful query validation (3 ms)
        竏・should call next on successful params validation (33 ms)
        竏・should default to body when no target specified (39 ms)
        竏・should replace body with parsed data by default (1 ms)
        竏・should replace query with parsed data by default (1 ms)
        竏・should replace params with parsed data by default
      validation options
        竏・should replace data when stripUnknown is true (1 ms)
        竏・should not replace data when stripUnknown is false (2 ms)
        竏・should handle empty options object (1 ms)
      validation failure with Zod error
        竏・should return 400 with formatted error on validation failure (26 ms)
        竏・should log warning with validation errors (1 ms)
        竏・should handle multiple validation errors (7 ms)
        竏・should handle nested path in validation error (14 ms)
        竏・should handle array index in validation error path (3 ms)
        竏・should handle empty path in validation error (1 ms)
        竏・should handle validation error with empty errors array (1 ms)
        竏・should log target as query when validating query (1 ms)
        竏・should log target as params when validating params
      non-Zod errors
        竏・should pass unexpected errors to next (1 ms)
        竏・should pass TypeError to next (1 ms)
        竏・should pass string errors to next (1 ms)
        竏・should pass null errors to next (1 ms)
        竏・should handle object without errors property (1 ms)
        竏・should handle object with non-array errors property (3 ms)
      edge cases
        竏・should handle undefined body (8 ms)
        竏・should handle null body (1 ms)
        竏・should handle empty object body (1 ms)
        竏・should handle deeply nested validation (1 ms)
        竏・should handle array body (14 ms)
        竏・should handle request path in error logging (3 ms)
    validateAll
      successful validation
        竏・should validate body only (2 ms)
        竏・should validate query only (1 ms)
        竏・should validate params only (1 ms)
        竏・should validate all targets together (21 ms)
        竏・should replace request data with parsed values (1 ms)
        竏・should handle body and query without params
        竏・should handle empty schemas object
      validation failure with Zod error
        竏・should return 400 on body validation failure (2 ms)
        竏・should return 400 on query validation failure (3 ms)
        竏・should return 400 on params validation failure (7 ms)
        竏・should log warning without target field (1 ms)
        竏・should stop validation on first error (1 ms)
      non-Zod errors
        竏・should pass unexpected errors to next (2 ms)
        竏・should pass query schema error to next if not Zod error (2 ms)
        竏・should pass params schema error to next if not Zod error (2 ms)
      edge cases
        竏・should handle undefined request properties (1 ms)
        竏・should handle empty query object (1 ms)
        竏・should handle empty params object
        竏・should maintain validation order: body, query, params (1 ms)
    isZodError detection
      竏・should detect object with errors array as Zod error (1 ms)
      竏・should not detect null as Zod error
      竏・should not detect undefined as Zod error (1 ms)
      竏・should not detect primitive as Zod error (1 ms)
      竏・should not detect object without errors property as Zod error (1 ms)
      竏・should not detect object with non-array errors as Zod error (1 ms)
      竏・should not detect object with errors as null as Zod error (2 ms)
    formatZodError
      竏・should format error with single path segment (1 ms)
      竏・should format error with multiple path segments joined by dots (2 ms)
      竏・should handle error with undefined message (38 ms)
      竏・should use first error message from multiple errors (2 ms)
      竏・should include all errors in details array (1 ms)
    ValidationTarget type
      竏・should accept body as valid target (1 ms)
      竏・should accept query as valid target (1 ms)
      竏・should accept params as valid target (2 ms)

PASS src/__tests__/unit/middleware/rateLimit.test.ts
  Rate Limit Middleware
    createStore
      when Redis is ready
        竏・should create RedisStore with correct prefix (142 ms)
        竏・should configure RedisStore with prefix parameter (4 ms)
        竏・should pass sendCommand function to RedisStore (10 ms)
      when Redis is not ready
        竏・should create MemoryStore as fallback (61 ms)
        竏・should use MemoryStore when Redis is not ready (9 ms)
    apiRateLimiter
      configuration
        竏・should use config.rateLimit.windowMs for window (7 ms)
        竏・should use config.rateLimit.maxRequests for max (2 ms)
        竏・should enable standard headers (8 ms)
        竏・should disable legacy headers (10 ms)
      keyGenerator
        竏・should use API key when provided (2 ms)
        竏・should truncate API key to 20 characters (8 ms)
        竏・should use IP when API key is not provided (4 ms)
        竏・should handle IPv6 addresses (6 ms)
        竏・should prefer API key over IP (11 ms)
      handler
        竏・should return 429 status code (4 ms)
        竏・should return rate_limit_exceeded error (8 ms)
        竏・should include retryAfter calculated from windowMs (8 ms)
        竏・should return correct error structure (3 ms)
      skip
        竏・should skip rate limiting for /health endpoint (3 ms)
        竏・should not skip rate limiting for other endpoints (32 ms)
        竏・should not skip for paths containing health (4 ms)
    webhookRateLimiter
      configuration
        竏・should use 60000ms (1 minute) window (12 ms)
        竏・should allow 1000 requests per window (9 ms)
        竏・should enable standard headers (25 ms)
        竏・should disable legacy headers (25 ms)
      keyGenerator
        竏・should use IP address for key (8 ms)
        竏・should ignore API key header (4 ms)
      handler
        竏・should return 429 status code (3 ms)
        竏・should return webhook-specific error message (3 ms)
        竏・should include fixed 60 second retryAfter (7 ms)
    adminRateLimiter
      configuration
        竏・should use 60000ms (1 minute) window (12 ms)
        竏・should allow only 30 requests per window (3 ms)
        竏・should enable standard headers (3 ms)
        竏・should disable legacy headers (3 ms)
      keyGenerator
        竏・should use API key when provided (4 ms)
        竏・should use IP when API key is not provided (3 ms)
      handler
        竏・should return 429 status code (4 ms)
        竏・should return admin-specific error message (3 ms)
        竏・should include fixed 60 second retryAfter (3 ms)
    createRateLimiter
      basic configuration
        竏・should create rate limiter with custom windowMs (2 ms)
        竏・should create rate limiter with custom max requests (3 ms)
        竏・should enable standard headers (4 ms)
        竏・should disable legacy headers (43 ms)
      store creation with prefix
        竏・should create store with prefixed key when Redis is ready (8 ms)
      keyGenerator
        竏・should use API key when provided (30 ms)
        竏・should use IP when API key is not provided (3 ms)
        竏・should truncate long API keys (3 ms)
      handler
        竏・should return 429 status code (44 ms)
        竏・should use default error message when not provided (25 ms)
        竏・should use custom error message when provided (4 ms)
        竏・should calculate retryAfter from windowMs (130 ms)
        竏・should round up retryAfter for non-round windowMs (15 ms)
    error response format
      竏・should always include code field (39 ms)
      竏・should always include type field (13 ms)
      竏・should always include retryAfter field (12 ms)
    edge cases
      undefined IP address
        竏・should handle undefined IP in apiRateLimiter (2 ms)
      empty API key
        竏・should use IP when API key is empty string (3 ms)
      special characters in API key
        竏・should handle API keys with special characters (4 ms)
      short API keys
        竏・should handle API keys shorter than 20 characters (4 ms)
      exactly 20 character API keys
        竏・should handle API keys exactly 20 characters (3 ms)
    integration between rate limiters
      竏・should create separate instances for each rate limiter type (6 ms)
      竏・should use different configurations for different limiters (7 ms)

PASS src/__tests__/unit/repositories/ProductRepository.test.ts
  ProductRepository
    create
      竏・should create a new product with all fields (19 ms)
      竏・should create a product with minimal fields (2 ms)
      竏・should use provided client for transactions (4 ms)
      竏・should throw error on database failure (113 ms)
    findById
      竏・should find a product by ID (3 ms)
      竏・should return null if product not found (4 ms)
    findByStripeProductId
      竏・should find a product by Stripe product ID (2 ms)
      竏・should return null if product not found (1 ms)
    findByDeveloperId
      竏・should find all products for a developer (152 ms)
      竏・should find only active products when activeOnly is true (4 ms)
      竏・should return empty array if no products found (22 ms)
    findActiveByDeveloperId
      竏・should find only active products (9 ms)
    update
      竏・should update product name (9 ms)
      竏・should update multiple fields (13 ms)
      竏・should return null if product not found (3 ms)
      竏・should handle empty update params (2 ms)
    archive
      竏・should archive a product (2 ms)
      竏・should return null if product not found (1 ms)
    delete
      竏・should delete a product (1 ms)
      竏・should return false if product not found (1 ms)
    countByDeveloperId
      竏・should count all products for a developer (1 ms)
      竏・should count only active products when activeOnly is true (1 ms)
      竏・should return 0 if no products found (1 ms)
    error handling
      竏・should throw error on findById failure (11 ms)
      竏・should throw error on findByStripeProductId failure (1 ms)
      竏・should throw error on findByDeveloperId failure (2 ms)
      竏・should throw error on update failure (1 ms)
      竏・should throw error on archive failure (1 ms)
      竏・should throw error on delete failure (1 ms)
      竏・should throw error on countByDeveloperId failure (8 ms)
      竏・should handle null rowCount on delete (2 ms)
    transaction support
      竏・should use provided client for findById (1 ms)
      竏・should use provided client for findByStripeProductId (1 ms)
      竏・should use provided client for findByDeveloperId (1 ms)
      竏・should use provided client for findActiveByDeveloperId (1 ms)
      竏・should use provided client for update (1 ms)
      竏・should use provided client for archive (2 ms)
      竏・should use provided client for delete (1 ms)
      竏・should use provided client for countByDeveloperId (4 ms)

PASS src/__tests__/unit/repositories/DeveloperRepository.test.ts
  DeveloperRepository
    create
      竏・should create a new developer with all fields (102 ms)
      竏・should create a developer without optional fields (2 ms)
      竏・should default testMode to true when not provided (1 ms)
      竏・should throw error on database failure (165 ms)
      竏・should use provided client for transactions (9 ms)
    findById
      竏・should find a developer by ID (3 ms)
      竏・should return null if developer not found
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (3 ms)
    findByEmail
      竏・should find a developer by email (2 ms)
      竏・should return null if developer not found (1 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (19 ms)
    findByStripeAccountId
      竏・should find a developer by Stripe account ID (2 ms)
      竏・should return null if developer not found
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    findByApiKeyHash
      竏・should find a developer by API key hash (2 ms)
      竏・should return null if developer not found (1 ms)
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (1 ms)
    update
      竏・should update developer email (4 ms)
      竏・should update developer stripeAccountId (1 ms)
      竏・should update developer webhookSecret (1 ms)
      竏・should update developer testMode (7 ms)
      竏・should update developer apiKeyHash (1 ms)
      竏・should update multiple fields at once (2 ms)
      竏・should return null if developer not found (5 ms)
      竏・should return existing developer if no updates provided (3 ms)
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (2 ms)
    delete
      竏・should delete a developer (2 ms)
      竏・should return false if developer not found (30 ms)
      竏・should handle null rowCount (1 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (3 ms)
    list
      竏・should list developers with default pagination (7 ms)
      竏・should list developers with custom limit and offset (3 ms)
      竏・should filter developers by testMode true (1 ms)
      竏・should filter developers by testMode false (2 ms)
      竏・should return empty array if no developers found (2 ms)
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (41 ms)
      竏・should combine testMode filter with pagination (26 ms)
    edge cases
      竏・should handle special characters in email (1 ms)
      竏・should handle very long API key hash (3 ms)
      竏・should handle very long Stripe account ID (2 ms)
      竏・should properly map dates from database rows (1 ms)
      竏・should handle null stripeAccountId (3 ms)
      竏・should handle null webhookSecret (1 ms)
      竏・should correctly set testMode to false (115 ms)
      竏・should handle webhook secret with special characters (85 ms)
      竏・should handle update with empty string stripeAccountId (1 ms)
    error logging
      竏・should log error when create fails (2 ms)
      竏・should log error when findById fails (2 ms)
      竏・should log error when findByEmail fails (4 ms)
      竏・should log error when findByStripeAccountId fails (15 ms)
      竏・should log error when findByApiKeyHash fails (32 ms)
      竏・should log error when update fails (22 ms)
      竏・should log error when delete fails (2 ms)
      竏・should log error when list fails (2 ms)
      竏・should log success when developer is created (1 ms)
      竏・should log success when developer is deleted (1 ms)
      竏・should not log when delete does not find developer (1 ms)

PASS src/__tests__/unit/repositories/AuditLogRepository.test.ts
  AuditLogRepository
    create
      竏・should create a new audit log with all fields (6 ms)
      竏・should create an audit log without optional fields (9 ms)
      竏・should throw error on database failure (182 ms)
      竏・should use provided client for transactions (1 ms)
      竏・should stringify changes object to JSON (3 ms)
    findById
      竏・should find an audit log by ID (3 ms)
      竏・should return null if audit log not found (1 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (2 ms)
    find
      竏・should find audit logs without filters (3 ms)
      竏・should find audit logs with developerId filter (31 ms)
      竏・should find audit logs with userId filter (1 ms)
      竏・should find audit logs with action filter (1 ms)
      竏・should find audit logs with resourceType filter (1 ms)
      竏・should find audit logs with resourceId filter (1 ms)
      竏・should find audit logs with startDate filter (7 ms)
      竏・should find audit logs with endDate filter (2 ms)
      竏・should find audit logs with multiple filters (3 ms)
      竏・should find audit logs with all filters combined (3 ms)
      竏・should respect custom limit and offset (4 ms)
      竏・should order results by created_at descending (2 ms)
      竏・should return empty array if no audit logs found (1 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    count
      竏・should count audit logs without filters (46 ms)
      竏・should count audit logs with developerId filter (1 ms)
      竏・should count audit logs with userId filter (1 ms)
      竏・should count audit logs with action filter (2 ms)
      竏・should count audit logs with resourceType filter (1 ms)
      竏・should count audit logs with resourceId filter (1 ms)
      竏・should count audit logs with date range filters (2 ms)
      竏・should count audit logs with multiple filters (2 ms)
      竏・should return 0 when no matching audit logs
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (4 ms)
    findByDeveloperId
      竏・should find audit logs by developer ID (10 ms)
      竏・should use default limit of 100 (7 ms)
      竏・should respect custom limit (7 ms)
      竏・should return empty array if no audit logs found (26 ms)
      竏・should use provided client for transactions (9 ms)
    findByResource
      竏・should find audit logs by resource type and ID (6 ms)
      竏・should use default limit of 100 (8 ms)
      竏・should respect custom limit (8 ms)
      竏・should return empty array if no audit logs found (8 ms)
      竏・should use provided client for transactions (5 ms)
    findByAction
      竏・should find audit logs by action (17 ms)
      竏・should use default limit of 100 (93 ms)
      竏・should respect custom limit (6 ms)
      竏・should return empty array if no audit logs found (1 ms)
      竏・should use provided client for transactions (76 ms)
    findByDateRange
      竏・should find audit logs within date range (5 ms)
      竏・should use default limit of 100 (1 ms)
      竏・should respect custom limit (4 ms)
      竏・should return empty array if no audit logs found (4 ms)
      竏・should use provided client for transactions (2 ms)
    edge cases
      竏・should handle audit log with null changes (2 ms)
      竏・should handle audit log with complex changes object (2 ms)
      竏・should handle audit log with empty changes object (2 ms)
      竏・should handle audit log with array in changes
      竏・should handle special characters in action (2 ms)
      竏・should handle IPv6 addresses (1 ms)
      竏・should handle long user agent strings (1 ms)
      竏・should handle unicode characters in resourceId (1 ms)
      竏・should properly convert date strings from database (1 ms)
      竏・should handle pagination with large offset (4 ms)
      竏・should handle zero limit gracefully (1 ms)
    error logging
      竏・should log error when create fails (6 ms)
      竏・should log error when findById fails (41 ms)
      竏・should log error when find fails (3 ms)
      竏・should log error when count fails (31 ms)
      竏・should log debug when audit log is created (3 ms)
    query building
      竏・should build correct query with no WHERE clause when no filters (35 ms)
      竏・should build correct query with single WHERE condition (2 ms)
      竏・should build correct query with multiple WHERE conditions joined by AND (12 ms)
      竏・should use correct parameter indices in count query (1 ms)

PASS src/__tests__/unit/repositories/PriceRepository.test.ts
  PriceRepository
    create
      竏・should create a new price with all fields (51 ms)
      竏・should create a one-time price without interval (2 ms)
      竏・should normalize currency to lowercase (1 ms)
    findById
      竏・should find a price by ID (3 ms)
      竏・should return null if price not found (1 ms)
    findByStripePriceId
      竏・should find a price by Stripe price ID (15 ms)
    findByProductId
      竏・should find all prices for a product (2 ms)
      竏・should filter by active status when activeOnly is true (2 ms)
    findByProductIdAndCurrency
      竏・should find prices by product and currency (3 ms)
      竏・should normalize currency to lowercase (13 ms)
    findByCurrency
      竏・should find all prices for a currency (1 ms)
    update
      竏・should update price active status (1 ms)
      竏・should return null if price not found (3 ms)
      竏・should return existing price if no updates provided (1 ms)
    deactivate
      竏・should deactivate a price (3 ms)
    delete
      竏・should delete a price (3 ms)
      竏・should return false if price not found (1 ms)
    countByProductId
      竏・should count all prices for a product (1 ms)
      竏・should count only active prices when activeOnly is true (2 ms)
    edge cases
      竏・should handle zero amount prices (2 ms)
      竏・should handle large amounts (1 ms)
      竏・should handle year interval for subscriptions (1 ms)
    error handling
      竏・should throw error on create failure (523 ms)
      竏・should throw error on findById failure (9 ms)
      竏・should throw error on findByStripePriceId failure (9 ms)
      竏・should return null for findByStripePriceId if not found (1 ms)
      竏・should throw error on findByProductId failure (2 ms)
      竏・should throw error on findByProductIdAndCurrency failure (4 ms)
      竏・should filter by active in findByProductIdAndCurrency when activeOnly is true (1 ms)
      竏・should throw error on findByCurrency failure (2 ms)
      竏・should filter by active in findByCurrency when activeOnly is true (1 ms)
      竏・should throw error on update failure (3 ms)
      竏・should throw error on deactivate failure (3 ms)
      竏・should return null on deactivate if price not found (2 ms)
      竏・should throw error on delete failure (8 ms)
      竏・should handle null rowCount on delete (2 ms)
      竏・should throw error on countByProductId failure (5 ms)
    findActiveByProductId
      竏・should call findByProductId with activeOnly true (2 ms)
    findActiveByProductIdAndCurrency
      竏・should call findByProductIdAndCurrency with activeOnly true (2 ms)
    transaction support
      竏・should use provided client for create (8 ms)
      竏・should use provided client for findById (2 ms)
      竏・should use provided client for findByStripePriceId (3 ms)
      竏・should use provided client for findByProductId (2 ms)
      竏・should use provided client for findByProductIdAndCurrency (1 ms)
      竏・should use provided client for findByCurrency (5 ms)
      竏・should use provided client for update (9 ms)
      竏・should use provided client for deactivate (10 ms)
      竏・should use provided client for delete (2 ms)
      竏・should use provided client for countByProductId (3 ms)

PASS src/__tests__/unit/middleware/auth.test.ts
  Auth Middleware
    apiKeyAuth
      when API key is missing
        竏・should return 401 with missing API key error (3 ms)
        竏・should not call next when API key is missing (1 ms)
      when API key is invalid
        竏・should return 401 with invalid API key error (23 ms)
        竏・should log warning with key prefix and IP (2 ms)
        竏・should query database with hashed API key (31 ms)
      when API key is valid
        竏・should attach developer to request (2 ms)
        竏・should call next on successful authentication (1 ms)
        竏・should log debug message with developer info (1 ms)
        竏・should handle developer with null stripeAccountId (1 ms)
        竏・should handle developer with null webhookSecret (11 ms)
        竏・should handle live mode developer (6 ms)
      when database error occurs
        竏・should return 500 with internal error (1 ms)
        竏・should log error with error details (1 ms)
        竏・should handle timeout errors
      API key hashing
        竏・should use SHA-256 hash for API key lookup (2 ms)
        竏・should produce different hashes for different API keys (2 ms)
    simpleApiKeyAuth
      when API key is missing
        竏・should return 401 with missing API key error (3 ms)
      when API key is invalid
        竏・should return 401 with invalid API key error (31 ms)
        竏・should reject key not in valid list (1 ms)
      when API key is valid
        竏・should call next for valid API key (3 ms)
        竏・should accept any key from the valid list (1 ms)
      edge cases
        竏・should work with empty valid keys array (1 ms)
        竏・should be case-sensitive for API keys (1 ms)
        竏・should not trim whitespace from API keys
        竏・should work with single valid key
    optionalApiKeyAuth
      when API key is not provided
        竏・should call next without authentication (1 ms)
        竏・should not attach developer to request
      when API key is provided and valid
        竏・should authenticate and call next
        竏・should attach developer info to request (1 ms)
      when API key is provided but invalid
        竏・should return 401 error (1 ms)
      when database error occurs
        竏・should return 500 error (2 ms)
    AuthenticatedRequest interface
      竏・should allow optional developer property (1 ms)
    SQL Query
      竏・should query developers table with correct columns (1 ms)

PASS src/__tests__/unit/config/index.test.ts
  Configuration
    竏・should load configuration (3 ms)
    竏・should have valid app configuration (2 ms)
    竏・should have valid stripe configuration (3 ms)
    竏・should have valid database configuration (1 ms)
    竏・should have valid redis configuration (27 ms)
    竏・should have valid jwt configuration (2 ms)
    竏・should have valid logging configuration (1 ms)
    竏・should have valid rate limit configuration (1 ms)

PASS src/__tests__/unit/services/CurrencyService.test.ts
  CurrencyService
    getSupportedCurrencies
      竏・should return all supported currencies (2 ms)
      竏・should include all required properties for each currency (5 ms)
    getCurrencyConfig
      竏・should return USD config (1 ms)
      竏・should return JPY config with 0 decimal places (1 ms)
      竏・should return CNY config (7 ms)
      竏・should return EUR config (1 ms)
    isSupportedCurrency
      竏・should return true for supported currencies (1 ms)
      竏・should handle uppercase currency codes (1 ms)
      竏・should return false for unsupported currencies (2 ms)
    getExchangeRate
      竏・should return exchange rate for USD (1 ms)
      竏・should return exchange rate for CNY (2 ms)
      竏・should return exchange rate for JPY (1 ms)
    getAllExchangeRates
      竏・should return all exchange rates (3 ms)
    convertAmount
      竏・should return same amount for same currency (1 ms)
      竏・should convert USD to CNY (1 ms)
      竏・should convert USD to JPY (1 ms)
      竏・should convert USD to EUR
      竏・should convert CNY to USD (1 ms)
      竏・should convert between non-USD currencies (1 ms)
    convertToAllCurrencies
      竏・should convert USD amount to all currencies (1 ms)
      竏・should handle zero amount
    formatAmount
      竏・should format USD with symbol (1 ms)
      竏・should format large USD amount with thousands separator
      竏・should format JPY without decimal places (1 ms)
      竏・should format EUR with symbol (9 ms)
      竏・should format without symbol when showSymbol is false (15 ms)
      竏・should format with currency code when showCode is true (1 ms)
      竏・should format with both options (1 ms)
    formatAmountLocalized
      竏・should format USD for en-US locale (1 ms)
      竏・should format JPY for ja-JP locale (1 ms)
    parseAmount
      竏・should parse USD formatted string (1 ms)
      竏・should parse string with thousands separator
      竏・should parse JPY formatted string (1 ms)
      竏・should parse EUR formatted string with comma decimal (1 ms)
      竏・should return 0 for invalid string
      竏・should parse string with currency code (21 ms)
    validateMinimumCharge
      竏・should validate USD amount above minimum (2 ms)
      竏・should invalidate USD amount below minimum (2 ms)
      竏・should validate exact minimum amount (1 ms)
      竏・should validate JPY minimum charge
      竏・should invalidate JPY below minimum
      竏・should validate CNY minimum charge
      竏・should invalidate CNY below minimum
    updateExchangeRates
      竏・should not update if rates are fresh (1 ms)
    setExchangeRate
      竏・should set custom exchange rate (1 ms)
      竏・should update conversion results with custom rate
    getExchangeRateDisplay
      竏・should return display info for USD to CNY (1 ms)
      竏・should return display info for same currency (1 ms)
    edge cases
      竏・should handle very large amounts (1 ms)
      竏・should handle zero amount (1 ms)
      竏・should handle negative amounts

PASS src/__tests__/unit/repositories/CustomerRepository.test.ts
  CustomerRepository
    create
      竏・should create a new customer with all fields (61 ms)
      竏・should create a customer without optional fields (2 ms)
      竏・should throw error on database failure (336 ms)
      竏・should use provided client for transactions (3 ms)
    findById
      竏・should find a customer by ID (2 ms)
      竏・should return null if customer not found (1 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (10 ms)
    findByStripeCustomerId
      竏・should find a customer by Stripe customer ID (13 ms)
      竏・should return null if customer not found
      竏・should throw error on database failure (23 ms)
    findByDeveloperIdAndEmail
      竏・should find a customer by developer ID and email (3 ms)
      竏・should return null if customer not found (1 ms)
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (1 ms)
    findByEmail
      竏・should find a customer by email (1 ms)
      竏・should return the most recently created customer when multiple exist (14 ms)
      竏・should return null if customer not found (23 ms)
      竏・should throw error on database failure (3 ms)
    findByDeveloperId
      竏・should find all customers for a developer (1 ms)
      竏・should return customers ordered by created_at descending (1 ms)
      竏・should return empty array if no customers found (2 ms)
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (2 ms)
    findOrCreate
      竏・should return existing customer if found (4 ms)
      竏・should create new customer if not found (3 ms)
      竏・should use provided client for transactions (1 ms)
    update
      竏・should update customer email (23 ms)
      竏・should update customer name (3 ms)
      竏・should update customer metadata (2 ms)
      竏・should update multiple fields at once (1 ms)
      竏・should return null if customer not found
      竏・should return existing customer if no updates provided
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    delete
      竏・should delete a customer (1 ms)
      竏・should return false if customer not found
      竏・should handle null rowCount (1 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (4 ms)
    edge cases
      竏・should handle customer with empty name string (2 ms)
      竏・should handle customer with empty metadata object (2 ms)
      竏・should handle customer with complex metadata (1 ms)
      竏・should handle special characters in email (1 ms)
      竏・should handle unicode characters in name
      竏・should handle very long Stripe customer ID (1 ms)
      竏・should properly map dates from database rows (13 ms)
      竏・should handle multiple customers with same email across developers (1 ms)
    error logging
      竏・should log error when create fails (3 ms)
      竏・should log error when findById fails (2 ms)
      竏・should log success when customer is created (1 ms)
      竏・should log success when customer is updated (1 ms)
      竏・should log success when customer is deleted (1 ms)

PASS src/__tests__/unit/repositories/InvoiceRepository.test.ts
  InvoiceRepository
    create
      竏・should create a new invoice with all fields (296 ms)
      竏・should create an invoice without optional fields (4 ms)
      竏・should throw error on database failure (694 ms)
      竏・should throw error if invoice number generation fails (2 ms)
      竏・should use provided client for transactions (1 ms)
      竏・should generate correct invoice number format (1 ms)
    findById
      竏・should find an invoice by ID (3 ms)
      竏・should return null if invoice not found (2 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (28 ms)
    findByInvoiceNumber
      竏・should find an invoice by invoice number (2 ms)
      竏・should return null if invoice not found (2 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
    findByCustomerId
      竏・should find all invoices for a customer (6 ms)
      竏・should apply pagination options (1 ms)
      竏・should filter by status when provided (2 ms)
      竏・should return empty array if no invoices found (2 ms)
      竏・should throw error on database failure (2 ms)
      竏・should use provided client for transactions (1 ms)
      竏・should return invoices ordered by created_at descending (2 ms)
    findByDeveloperId
      竏・should find all invoices for a developer with total count (35 ms)
      竏・should apply pagination options (2 ms)
      竏・should filter by status when provided (1 ms)
      竏・should return empty invoices array and zero total if none found (4 ms)
      竏・should throw error on database failure (3 ms)
      竏・should use provided client for transactions (2 ms)
      竏・should return invoices ordered by created_at descending (4 ms)
    updateStatus
      竏・should update invoice status to draft (1 ms)
      竏・should update invoice status to issued and set issued_at (2 ms)
      竏・should update invoice status to paid and set paid_at (10 ms)
      竏・should update invoice status to void (1 ms)
      竏・should update invoice status to refunded
      竏・should return null if invoice not found (12 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions (1 ms)
      竏・should always update updated_at field (1 ms)
    updatePdfUrl
      竏・should update PDF URL and set pdf_generated_at (1 ms)
      竏・should return null if invoice not found (1 ms)
      竏・should throw error on database failure (1 ms)
      竏・should use provided client for transactions
      竏・should always update updated_at field (1 ms)
    edge cases
      竏・should handle invoice with empty line items array (1 ms)
      竏・should handle invoice with multiple line items (1 ms)
      竏・should handle very long PDF URL (1 ms)
      竏・should handle different currency codes (3 ms)
      竏・should handle all invoice statuses (3 ms)
      竏・should handle complex billing address (1 ms)
      竏・should handle complex tax details (1 ms)
      竏・should handle zero subtotal and total (1 ms)
      竏・should handle very large amounts (1 ms)
      竏・should handle line items with optional productId and priceId (1 ms)
      竏・should handle unicode characters in notes
      竏・should properly map dates with timezone information (1 ms)
      竏・should handle null date fields (1 ms)
    error logging
      竏・should log error when create fails (2 ms)
      竏・should log error when findById fails (3 ms)
      竏・should log error when findByInvoiceNumber fails (1 ms)
      竏・should log error when findByCustomerId fails (6 ms)
      竏・should log error when findByDeveloperId fails (2 ms)
      竏・should log error when updateStatus fails (2 ms)
      竏・should log error when updatePdfUrl fails (1 ms)
      竏・should log success when invoice is created (1 ms)
    pagination edge cases
      竏・should use default limit and offset when not provided for findByCustomerId (1 ms)
      竏・should use default limit and offset when not provided for findByDeveloperId
      竏・should handle large offset values (1 ms)
      竏・should handle small limit values (4 ms)

PASS src/__tests__/unit/services/WebhookProcessor.test.ts
  WebhookProcessor
    processWebhook
      signature verification
        竏・should return error when signature verification fails (4 ms)
      idempotency
        竏・should return early if event already processed (2 ms)
      event processing
        竏・should create new webhook log for new event (37 ms)
        竏・should reuse existing webhook log for retry (2 ms)
      error handling and retry logic
        竏・should mark as failed when processing fails with retries remaining (4 ms)
        竏・should move to DLQ after max retries exceeded (2 ms)
    handleCheckoutSessionCompleted
      竏・should process checkout completion successfully (1 ms)
      竏・should handle subscription checkout with expiry date (1 ms)
      竏・should throw error when purchase_intent_id is missing (1 ms)
      竏・should throw error when checkout session not found (1 ms)
      竏・should throw error when customer email is missing
      竏・should use metadata purchase_intent_id when client_reference_id is null (1 ms)
    handleInvoicePaid
      竏・should renew subscription entitlement on invoice paid (1 ms)
      竏・should skip first invoice (subscription_create) (1 ms)
      竏・should skip invoice without subscription (1 ms)
      竏・should handle missing entitlement gracefully (1 ms)
    handleInvoicePaymentFailed
      竏・should suspend entitlement when subscription is past_due (43 ms)
      竏・should send notification but not suspend when subscription is active (1 ms)
      竏・should skip invoice without subscription (1 ms)
    handleSubscriptionUpdated
      竏・should suspend entitlement when subscription becomes past_due (1 ms)
      竏・should reactivate entitlement when subscription becomes active from suspended (1 ms)
      竏・should log when subscription is scheduled for cancellation
      竏・should handle missing entitlement gracefully (1 ms)
    handleSubscriptionDeleted
      竏・should revoke entitlement when subscription is deleted (3 ms)
      竏・should handle missing entitlement gracefully (1 ms)
    handleChargeRefunded
      竏・should revoke entitlement on full refund (2 ms)
      竏・should not revoke entitlement on partial refund (1 ms)
      竏・should skip when payment_intent is missing (1 ms)
      竏・should handle missing entitlement gracefully (1 ms)
    handleDisputeCreated
      竏・should revoke entitlement and send notification on dispute (2 ms)
      竏・should skip when payment_intent is missing (1 ms)
      竏・should handle missing entitlement gracefully (1 ms)
    handleDisputeClosed
      竏・should restore entitlement when dispute is won (2 ms)
      竏・should not restore entitlement when dispute is lost (1 ms)
      竏・should skip when payment_intent is missing (1 ms)
      竏・should handle missing entitlement gracefully (1 ms)
    unhandled event types
      竏・should log debug message for unhandled event types (1 ms)
    retryFailedWebhook
      竏・should return error when webhook log not found (1 ms)
      竏・should return already processed when webhook is already processed
      竏・should successfully retry a failed webhook (2 ms)
      竏・should mark as failed on retry error with retries remaining (1 ms)
      竏・should move to DLQ on retry error after max attempts (1 ms)
    getRetryInterval
      竏・should return 1 minute for first retry
      竏・should return 5 minutes for second retry (1 ms)
      竏・should return 15 minutes for third retry
      竏・should return 1 hour for fourth retry (1 ms)
      竏・should return 6 hours for fifth retry
      竏・should return max interval for attempts beyond array
    canRetry
      竏・should return true for attempts less than max (1 ms)
      竏・should return false when max attempts reached (1 ms)
    edge cases
      竏・should handle customer as object in checkout session (4 ms)
      竏・should handle subscription as object in checkout session (2 ms)
      竏・should handle payment_intent as object in charge (1 ms)
      竏・should handle subscription as object in invoice (1 ms)
      竏・should throw error when customer is missing in checkout session (1 ms)

PASS src/__tests__/unit/services/TokenService.test.ts
  TokenService
    constructor
      竏・should create instance with custom secret and expiration (33 ms)
      竏・should use default values from config when not provided (1 ms)
    generateUnlockToken
      竏・should generate a JWT token with correct payload (2 ms)
      竏・should include iat and exp timestamps in payload (1 ms)
      竏・should log token generation (23 ms)
      竏・should generate unique jti for each token (39 ms)
    verifyUnlockToken
      竏・should verify and return valid token payload (2 ms)
      竏・should verify JWT with correct algorithm (1 ms)
      竏・should return error when token has already been used (1 ms)
      竏・should mark token as used after successful verification
      竏・should log successful verification (1 ms)
      竏・should return error when token is expired (1 ms)
      竏・should return error when token signature is invalid (1 ms)
      竏・should return error for unexpected verification errors (1 ms)
      竏・should fail open when Redis is unavailable for checking token usage (15 ms)
      竏・should succeed verification even when marking token as used fails (1 ms)
    verifyUnlockTokenReadOnly
      竏・should verify token without marking it as used
      竏・should return error when token has been used in read-only mode (16 ms)
      竏・should return error when token is expired in read-only mode (1 ms)
      竏・should return error when token is invalid in read-only mode (23 ms)
      竏・should return generic error for unexpected errors in read-only mode
      竏・should check token usage in read-only verification (1 ms)
    decodeToken
      竏・should decode token without verification (1 ms)
      竏・should return null when decode throws an error (2 ms)
      竏・should return null when token is null (1 ms)
      竏・should decode expired tokens without error (1 ms)
    token expiration
      竏・should use custom expiration time (1 ms)
      竏・should use default 5 minute expiration (1 ms)
    Redis key management
      竏・should use correct key format for token usage tracking (1 ms)
      竏・should set token expiration in Redis matching token lifetime (1 ms)
    single-use token enforcement
      竏・should prevent token reuse after verification (1 ms)
      竏・should allow read-only verification without consuming token
    edge cases
      竏・should handle empty string token (1 ms)
      竏・should handle token with special characters (1 ms)
      竏・should handle concurrent verification attempts (1 ms)
      竏・should handle very long entitlement and purchase intent IDs (1 ms)
    logging behavior
      竏・should log debug message when token is marked as used (2 ms)
      竏・should log warning for already used tokens
      竏・should not log verification info for already used tokens (1 ms)

PASS src/__tests__/unit/services/TaxService.test.ts
  TaxService
    calculateTax
      竏・should calculate tax using Stripe Tax API (5 ms)
      竏・should include shipping cost in tax calculation (1 ms)
      竏・should convert currency to lowercase (9 ms)
      竏・should use default tax code if not provided (2 ms)
      竏・should generate reference for line items without reference (1 ms)
      竏・should handle null tax_breakdown from Stripe (1 ms)
      竏・should handle missing tax_rate_details properties (1 ms)
      竏・should handle null tax_rate_details (1 ms)
      Reverse Charge
        竏・should return zero tax with reverse charge for valid EU B2B (2 ms)
        竏・should calculate tax normally if VAT number invalid (2 ms)
        竏・should not apply reverse charge if no VAT number provided (1 ms)
        竏・should not apply reverse charge for non-EU countries
        竏・should calculate total correctly for multiple line items with reverse charge (1 ms)
      Fallback Manual Calculation
        竏・should fallback to manual calculation when Stripe fails (2 ms)
        竏・should calculate UK VAT correctly (1 ms)
        竏・should calculate Australian GST correctly (2 ms)
        竏・should calculate New Zealand GST correctly (1 ms)
        竏・should calculate Canadian GST correctly (1 ms)
        竏・should calculate Japan Consumption Tax correctly (1 ms)
        竏・should return zero tax for US (1 ms)
        竏・should handle lowercase country codes
        竏・should calculate tax for all EU countries (15 ms)
        竏・should round tax amount correctly (1 ms)
        竏・should sum multiple line items (1 ms)
    validateVATNumber
      竏・should validate correct VAT number via VIES (3 ms)
      竏・should return invalid for incorrect VAT number (1 ms)
      竏・should handle VAT number with spaces (12 ms)
      竏・should handle lowercase VAT number (1 ms)
      竏・should return error for VAT number too short
      竏・should return error for invalid country code (1 ms)
      竏・should return error for non-EU country code
      竏・should handle VIES API error gracefully (1 ms)
      VIES API Fallback Format Validation
        竏・should fallback to format validation for German VAT (1 ms)
        竏・should reject invalid German VAT format
        竏・should validate Austrian VAT format (1 ms)
        竏・should validate Belgian VAT format
        竏・should validate French VAT format (1 ms)
        竏・should validate Dutch VAT format (1 ms)
        竏・should validate Spanish VAT format (1 ms)
        竏・should validate Italian VAT format (1 ms)
        竏・should validate Polish VAT format
        竏・should validate Swedish VAT format (1 ms)
        竏・should validate Czech VAT format
        竏・should validate Hungarian VAT format (1 ms)
        竏・should validate Irish VAT format (1 ms)
        竏・should validate GB VAT format (9 digits)
    getTaxRate
      竏・should return correct rate for EU countries (2 ms)
      竏・should return correct rate for UK
      竏・should return correct rate for Australia (1 ms)
      竏・should return correct rate for New Zealand
      竏・should return correct rate for Japan (1 ms)
      竏・should return correct rate for Canada
      竏・should return 0 for unsupported countries (1 ms)
      竏・should handle lowercase country codes (1 ms)
      竏・should handle mixed case country codes (1 ms)
    isEUCountry
      竏・should return true for EU countries (1 ms)
      竏・should return false for non-EU countries (2 ms)
      竏・should handle lowercase country codes (9 ms)
      竏・should return false for invalid country codes (1 ms)
    getSupportedJurisdictions
      竏・should return array of supported jurisdictions (2 ms)
      竏・should include all EU countries (1 ms)
      竏・should include UK (1 ms)
      竏・should include other major jurisdictions (1 ms)
      竏・should return correct total count
    Edge Cases
      竏・should handle empty line items array
      竏・should handle zero amount line items (11 ms)
      竏・should handle very large amounts (2 ms)
      竏・should handle customer address with only country (1 ms)
      竏・should handle undefined optional address fields (1 ms)
    Constructor
      竏・should create instance with default API key from config
      竏・should create instance with custom API key (2 ms)
    VIES API Response Parsing
      竏・should handle response with missing name field (1 ms)
      竏・should handle response with missing address field (2 ms)
      竏・should handle response with empty values (1 ms)
      竏・should handle malformed XML gracefully (2 ms)
      竏・should handle <valid>TRUE</valid> (case insensitive) (3 ms)
      竏・should handle <valid>True</valid> (mixed case) (1 ms)
    Singleton Export
      竏・should export taxService singleton

-------------------------------|---------|----------|---------|---------|---------------------
File                           | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s   
-------------------------------|---------|----------|---------|---------|---------------------
All files                      |   93.99 |    94.05 |   86.31 |   93.98 |                     
 src                           |       0 |        0 |       0 |       0 |                     
  app.ts                       |       0 |        0 |       0 |       0 | 1-102               
  index.ts                     |       0 |      100 |       0 |       0 | 1-67                
 src/config                    |   23.07 |       45 |    7.14 |   23.37 |                     
  database.ts                  |    40.9 |      100 |       0 |    40.9 | 19,24-33,39-44      
  index.ts                     |   47.36 |       45 |      25 |      50 | 66,140-160,166      
  redis.ts                     |       0 |      100 |       0 |       0 | 1-65                
  swagger.ts                   |       0 |      100 |     100 |       0 | 9-306               
 src/middleware                |   89.43 |      100 |   70.58 |   89.43 |                     
  auth.ts                      |     100 |      100 |     100 |     100 |                     
  index.ts                     |       0 |      100 |       0 |       0 | 5-21                
  rateLimit.ts                 |   97.29 |      100 |   91.66 |   97.29 | 23                  
  validation.ts                |     100 |      100 |     100 |     100 |                     
 src/repositories              |   97.36 |      100 |    88.1 |   97.31 |                     
  AuditLogRepository.ts        |     100 |      100 |     100 |     100 |                     
  CheckoutSessionRepository.ts |     100 |      100 |     100 |     100 |                     
  CouponRepository.ts          |     100 |      100 |     100 |     100 |                     
  CustomerRepository.ts        |     100 |      100 |     100 |     100 |                     
  DeveloperRepository.ts       |     100 |      100 |     100 |     100 |                     
  EntitlementRepository.ts     |     100 |      100 |     100 |     100 |                     
  InvoiceRepository.ts         |     100 |      100 |     100 |     100 |                     
  LegalTemplateRepository.ts   |     100 |      100 |     100 |     100 |                     
  PriceRepository.ts           |     100 |      100 |     100 |     100 |                     
  ProductRepository.ts         |     100 |      100 |     100 |     100 |                     
  WebhookLogRepository.ts      |     100 |      100 |     100 |     100 |                     
  index.ts                     |       0 |      100 |       0 |       0 | 8-93                
 src/routes                    |   97.47 |    97.61 |     100 |   97.46 |                     
  admin.ts                     |    98.8 |     92.3 |     100 |   98.78 | 788,901-907         
  checkout.ts                  |     100 |    85.71 |     100 |     100 | 109                 
  coupons.ts                   |     100 |    96.96 |     100 |     100 | 245                 
  currency.ts                  |     100 |      100 |     100 |     100 |                     
  entitlements.ts              |     100 |      100 |     100 |     100 |                     
  gdpr.ts                      |     100 |      100 |     100 |     100 |                     
  index.ts                     |       0 |      100 |     100 |       0 | 1-31                
  invoices.ts                  |     100 |      100 |     100 |     100 |                     
  legal.ts                     |     100 |      100 |     100 |     100 |                     
  monitoring.ts                |     100 |      100 |     100 |     100 |                     
  onboarding.ts                |   98.13 |      100 |     100 |   98.13 | 100-101             
  portal.ts                    |     100 |      100 |     100 |     100 |                     
  webhooks.ts                  |     100 |      100 |     100 |     100 |                     
 src/schemas                   |   97.33 |    71.42 |     100 |   97.29 |                     
  index.ts                     |   97.33 |    71.42 |     100 |   97.29 | 426,430             
 src/services                  |   95.74 |    93.08 |   88.27 |   95.67 |                     
  CheckoutService.ts           |     100 |      100 |     100 |     100 |                     
  CouponService.ts             |   94.54 |    92.53 |     100 |   94.44 | 316,335,343,367-370 
  CurrencyService.ts           |   95.18 |       80 |     100 |   95.18 | 197-198,381,415     
  DeveloperService.ts          |   94.87 |       84 |     100 |   94.87 | 231-234             
  EmailService.ts              |     100 |    97.59 |     100 |     100 | 545-546             
  EntitlementService.ts        |     100 |      100 |     100 |     100 |                     
  FraudService.ts              |     100 |      100 |     100 |     100 |                     
  GDPRService.ts               |   99.28 |    88.23 |     100 |   99.28 | 190                 
  InvoiceService.ts            |   97.64 |    87.09 |     100 |   97.54 | 432,501-502,518     
  LegalTemplateService.ts      |   98.75 |    96.55 |     100 |   98.73 | 457                 
  MagicLinkService.ts          |     100 |      100 |     100 |     100 |                     
  MetricsService.ts            |   99.07 |    98.73 |     100 |   99.03 | 380                 
  StripeClient.ts              |     100 |      100 |     100 |     100 |                     
  TaxService.ts                |   96.49 |    92.64 |     100 |   96.29 | 346,386-390,504     
  TokenService.ts              |     100 |      100 |     100 |     100 |                     
  WebhookProcessor.ts          |   98.95 |    87.12 |     100 |   98.95 | 369-370             
  index.ts                     |       0 |      100 |       0 |       0 | 8-136               
 src/utils                     |   91.66 |       50 |      50 |   91.66 |                     
  logger.ts                    |   91.66 |       50 |      50 |   91.66 | 35                  
-------------------------------|---------|----------|---------|---------|---------------------
Test Suites: 3 skipped, 45 passed, 45 of 48 total
Tests:       18 skipped, 2553 passed, 2571 total
Snapshots:   0 total
Time:        128.846 s, estimated 226 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
