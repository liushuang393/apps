# 統合テストガイド - 音質向上プロジェクト

**文書番号**: TEST-2025-001  
**作成日**: 2025-10-26  
**最終更新**: 2025-10-26  
**バージョン**: 1.0  
**前提文書**: [03_タスク管理表.md](./03_タスク管理表.md), [05_新機能統合ガイド.md](./05_新機能統合ガイド.md)

---

## 📋 目次

1. [概要](#概要)
2. [テスト環境](#テスト環境)
3. [エンドツーエンドテスト](#エンドツーエンドテスト)
4. [パフォーマンステスト](#パフォーマンステスト)
5. [品質評価テスト](#品質評価テスト)
6. [テスト実行手順](#テスト実行手順)

---

## 概要

### 目的

音質向上プロジェクトの全機能を統合的にテストし、以下を確認する：

1. **機能正常性**: 全機能が正しく動作すること
2. **パフォーマンス**: KPI目標を達成すること
3. **品質**: 翻訳品質が向上していること

### テスト対象

| モジュール | テスト内容 |
|-----------|-----------|
| AdaptiveVADBuffer | VAD適応調整の動作確認 |
| ConversationContext | 会話履歴管理の動作確認 |
| TerminologyManager | 術語管理の動作確認 |
| AudioValidator | 音声検証の動作確認 |
| StreamingAudioSender | ストリーミング送信の動作確認 |
| NoiseSuppression | ノイズ除去の動作確認 |
| WebSocketManager | WebSocket接続・Keep-Aliveの動作確認 |

### KPI目標

| 指標 | 現状 | 目標 | 測定方法 |
|------|------|------|----------|
| 文漏れ率 | 5% | < 2% | 手動評価 |
| CER/WER | 20% | < 15% | 自動計算 |
| 遅延 p50 | 2.5s | < 1.2s | 自動計測 |
| 遅延 p95 | 5.0s | < 2.5s | 自動計測 |
| 雑音混入 | 10% | < 5% | SNR測定 |

---

## テスト環境

### ハードウェア要件

- CPU: Intel Core i5 以上
- RAM: 8GB 以上
- マイク: 48kHz サンプリングレート対応

### ソフトウェア要件

- Node.js: 18.x 以上
- npm: 9.x 以上
- ブラウザ: Chrome 120+ / Edge 120+
- Electron: 28.x 以上

### 環境変数

```bash
# .env.test
OPENAI_API_KEY=sk-...
TEST_AUDIO_DIR=./test/audio
TEST_OUTPUT_DIR=./test/output
DEBUG_MODE=true
```

---

## エンドツーエンドテスト

### IT-001: 日本語→英語翻訳

**目的**: 日本語から英語への翻訳が正しく動作することを確認

**前提条件**:
- OpenAI API Key設定済み
- テスト音声ファイル準備済み（`test/audio/ja_sample.wav`）

**テスト手順**:

1. アプリケーション起動
```typescript
const app = new VoiceTranslateApp();
await app.initialize(apiKey, 'ja', 'en');
await app.startTranslation();
```

2. テスト音声を入力
```typescript
const audioData = loadTestAudio('test/audio/ja_sample.wav');
app.processAudioData(audioData);
```

3. 翻訳結果を確認
```typescript
// 期待される結果
// 入力: "こんにちは、今日はいい天気ですね"
// 出力: "Hello, it's nice weather today"
```

**合格基準**:
- ✅ 翻訳結果が正しいこと
- ✅ 遅延が2秒以内であること
- ✅ 文漏れがないこと

---

### IT-002: 中国語→日本語翻訳

**目的**: 中国語から日本語への翻訳が正しく動作することを確認

**前提条件**:
- OpenAI API Key設定済み
- テスト音声ファイル準備済み（`test/audio/zh_sample.wav`）

**テスト手順**:

1. アプリケーション起動
```typescript
const app = new VoiceTranslateApp();
await app.initialize(apiKey, 'zh', 'ja');
await app.startTranslation();
```

2. テスト音声を入力
```typescript
const audioData = loadTestAudio('test/audio/zh_sample.wav');
app.processAudioData(audioData);
```

3. 翻訳結果を確認
```typescript
// 期待される結果
// 入力: "你好，今天天气很好"
// 出力: "こんにちは、今日はいい天気ですね"
```

**合格基準**:
- ✅ 翻訳結果が正しいこと
- ✅ 遅延が2秒以内であること
- ✅ 文漏れがないこと

---

### IT-003: ベトナム語→中国語翻訳

**目的**: ベトナム語から中国語への翻訳が正しく動作することを確認

**前提条件**:
- OpenAI API Key設定済み
- テスト音声ファイル準備済み（`test/audio/vi_sample.wav`）

**テスト手順**:

1. アプリケーション起動
```typescript
const app = new VoiceTranslateApp();
await app.initialize(apiKey, 'vi', 'zh');
await app.startTranslation();
```

2. テスト音声を入力
```typescript
const audioData = loadTestAudio('test/audio/vi_sample.wav');
app.processAudioData(audioData);
```

3. 翻訳結果を確認
```typescript
// 期待される結果
// 入力: "Xin chào, hôm nay thời tiết đẹp"
// 出力: "你好，今天天气很好"
```

**合格基準**:
- ✅ 翻訳結果が正しいこと
- ✅ 遅延が2秒以内であること
- ✅ 文漏れがないこと

---

### IT-004: 言語切替テスト

**目的**: 言語切替が正しく動作することを確認

**テスト手順**:

1. 日本語→英語で翻訳開始
```typescript
const app = new VoiceTranslateApp();
await app.initialize(apiKey, 'ja', 'en');
await app.startTranslation();
```

2. 翻訳実行
```typescript
const audioData1 = loadTestAudio('test/audio/ja_sample.wav');
app.processAudioData(audioData1);
```

3. 言語切替
```typescript
await app.stopTranslation();
await app.initialize(apiKey, 'zh', 'ja');
await app.startTranslation();
```

4. 翻訳実行
```typescript
const audioData2 = loadTestAudio('test/audio/zh_sample.wav');
app.processAudioData(audioData2);
```

**合格基準**:
- ✅ 言語切替が正しく動作すること
- ✅ 切替後の翻訳が正しいこと
- ✅ メモリリークがないこと

---

## パフォーマンステスト

### PT-001: 遅延測定

**目的**: 翻訳遅延がKPI目標を達成することを確認

**測定方法**:

```typescript
const latencies: number[] = [];

for (let i = 0; i < 100; i++) {
    const startTime = Date.now();
    
    // 音声入力
    app.processAudioData(audioData);
    
    // 翻訳結果待機
    await waitForTranslation();
    
    const endTime = Date.now();
    const latency = endTime - startTime;
    latencies.push(latency);
}

// パーセンタイル計算
const p50 = calculatePercentile(latencies, 50);
const p95 = calculatePercentile(latencies, 95);

console.log(`p50: ${p50}ms, p95: ${p95}ms`);
```

**合格基準**:
- ✅ p50 < 1200ms
- ✅ p95 < 2500ms

---

### PT-002: スループット測定

**目的**: システムのスループットを測定

**測定方法**:

```typescript
const duration = 60000; // 60秒
const startTime = Date.now();
let requestCount = 0;

while (Date.now() - startTime < duration) {
    app.processAudioData(audioData);
    requestCount++;
    await sleep(100); // 100ms間隔
}

const throughput = requestCount / (duration / 1000);
console.log(`Throughput: ${throughput} requests/sec`);
```

**合格基準**:
- ✅ スループット > 5 requests/sec

---

### PT-003: メモリプロファイリング

**目的**: メモリリークがないことを確認

**測定方法**:

```typescript
const initialMemory = process.memoryUsage().heapUsed;

for (let i = 0; i < 1000; i++) {
    app.processAudioData(audioData);
    
    if (i % 100 === 0) {
        const currentMemory = process.memoryUsage().heapUsed;
        const memoryIncrease = currentMemory - initialMemory;
        console.log(`Memory increase: ${memoryIncrease / 1024 / 1024}MB`);
    }
}

// ガベージコレクション実行
global.gc();

const finalMemory = process.memoryUsage().heapUsed;
const memoryLeak = finalMemory - initialMemory;

console.log(`Memory leak: ${memoryLeak / 1024 / 1024}MB`);
```

**合格基準**:
- ✅ メモリリーク < 10MB

---

## 品質評価テスト

### QT-001: CER/WER評価

**目的**: 翻訳品質がKPI目標を達成することを確認

**測定方法**:

```typescript
const testCases = loadTestCases('test/data/gold_corpus.json');
const results: { cer: number; wer: number }[] = [];

for (const testCase of testCases) {
    const translation = await app.translate(testCase.input);
    const cer = calculateCER(translation, testCase.expected);
    const wer = calculateWER(translation, testCase.expected);
    results.push({ cer, wer });
}

const avgCER = average(results.map(r => r.cer));
const avgWER = average(results.map(r => r.wer));

console.log(`Average CER: ${avgCER}%, Average WER: ${avgWER}%`);
```

**合格基準**:
- ✅ CER < 15%
- ✅ WER < 15%

---

### QT-002: SNR測定

**目的**: ノイズ除去効果を測定

**測定方法**:

```typescript
const noisyAudio = loadTestAudio('test/audio/noisy_sample.wav');
const cleanAudio = app.applyNoiseSuppression(noisyAudio);

const snrBefore = calculateSNR(noisyAudio);
const snrAfter = calculateSNR(cleanAudio);

console.log(`SNR before: ${snrBefore}dB, SNR after: ${snrAfter}dB`);
console.log(`SNR improvement: ${snrAfter - snrBefore}dB`);
```

**合格基準**:
- ✅ SNR改善 > 10dB
- ✅ 雑音混入 < 5%

---

## テスト実行手順

### 1. 環境準備

```bash
# 依存関係インストール
npm install

# テスト環境変数設定
cp .env.example .env.test
# .env.testを編集してOPENAI_API_KEYを設定

# テストデータ準備
npm run test:prepare-data
```

### 2. ユニットテスト実行

```bash
npm test
```

### 3. 統合テスト実行

```bash
npm run test:integration
```

### 4. パフォーマンステスト実行

```bash
npm run test:performance
```

### 5. 品質評価テスト実行

```bash
npm run test:quality
```

### 6. レポート生成

```bash
npm run test:report
```

---

## テスト結果記録

### テスト実行記録テンプレート

```markdown
## テスト実行記録

**実行日**: YYYY-MM-DD  
**実行者**: 氏名  
**環境**: 本番/ステージング/開発

### エンドツーエンドテスト

| テストID | 結果 | 遅延 | 備考 |
|---------|------|------|------|
| IT-001 | ✅/❌ | XXXms | |
| IT-002 | ✅/❌ | XXXms | |
| IT-003 | ✅/❌ | XXXms | |
| IT-004 | ✅/❌ | XXXms | |

### パフォーマンステスト

| テストID | 結果 | 測定値 | 目標値 | 備考 |
|---------|------|--------|--------|------|
| PT-001 | ✅/❌ | p50=XXXms, p95=XXXms | p50<1200ms, p95<2500ms | |
| PT-002 | ✅/❌ | XX req/s | >5 req/s | |
| PT-003 | ✅/❌ | XXMBリーク | <10MB | |

### 品質評価テスト

| テストID | 結果 | 測定値 | 目標値 | 備考 |
|---------|------|--------|--------|------|
| QT-001 | ✅/❌ | CER=XX%, WER=XX% | <15% | |
| QT-002 | ✅/❌ | SNR改善=XXdB | >10dB | |
```

---

## まとめ

本ガイドに従って統合テストを実施することで、音質向上プロジェクトの全機能が正しく動作し、KPI目標を達成することを確認できます。

テスト結果は必ず記録し、問題が発見された場合は速やかに修正してください。

