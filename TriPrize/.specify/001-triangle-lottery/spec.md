# 機能仕様書: 三角形抽選販売アプリケーション

**フィーチャーブランチ**: `001-triangle-lottery`
**作成日**: 2025-11-11
**ステータス**: Draft
**入力**: 日本市場向け三角形抽選販売APP（iOS + Android）の要件定義

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー1 - 三角形抽選キャンペーンの作成と管理 (優先度: P1)

管理者として、新しい三角形抽選キャンペーンを作成し、底辺の長さ、各層の価格設定、および賞品を設定したい。これにより、販売イベントを開始できる。

**優先度理由**: システムの中核機能。キャンペーンが作成できなければ、ユーザーは購入できず、ビジネスが成立しない。

**独立テスト**: 管理者がログインし、キャンペーンパラメータを入力し、保存することで、キャンペーンが作成され、利益計算が表示されることを確認できる。

**受入シナリオ**:

1. **Given** 管理者がシステムにログインしている、**When** 新規キャンペーン作成画面で底辺長さ10を入力する、**Then** システムは55個のポジション（1+2+3+...+10）を計算して表示する
2. **Given** 三角形の構造が設定されている、**When** 各層（Layer 1からLayer 10）に価格を設定する（Layer 1: 10,000円、Layer 2: 8,000円、...、Layer 10: 500円）、**Then** システムは総売上と設定可能な賞品予算を計算する
3. **Given** 価格設定が完了している、**When** 賞品情報（名称、画像、推定価値、配置層）を登録する、**Then** システムは利益率を計算し、利益率が15%未満の場合に警告メッセージを表示する
4. **Given** すべての設定が完了している、**When** キャンペーンを「公開」ステータスに変更する、**Then** キャンペーンがユーザー向けアプリに表示され、購入可能になる

---

### ユーザーストーリー2 - 抽選ポジションの購入 (優先度: P1)

ユーザーとして、公開中の三角形キャンペーンを閲覧し、希望する層を選択して購入したい。購入後、自分がどのポジションを獲得したかを確認できる。

**優先度理由**: ユーザーの主要行動。購入機能がなければ、キャンペーンは意味をなさない。MVP の中核。

**独立テスト**: ユーザーがアプリを開き、キャンペーンを選択し、層を選んで支払いを完了し、購入確認画面でポジション番号を確認できることを検証。

**受入シナリオ**:

1. **Given** ユーザーがアプリにログインしている、**When** アクティブなキャンペーン一覧を表示する、**Then** 各キャンペーンの進捗状況（残りポジション数/総ポジション数）が表示される
2. **Given** キャンペーン詳細画面を開いている、**When** Layer 5（価格3,000円）を選択する、**Then** 選択した層の価格、残りポジション数、賞品情報が表示される
3. **Given** 層を選択し購入ボタンを押した、**When** 支払い方法（クレジットカード/デビットカード/コンビニ決済）を選択して決済を完了する、**Then** システムはその層内のランダムな未販売ポジションを割り当て、購入確認画面にポジション番号と三角形上の位置を表示する
4. **Given** 支払い処理中にエラーが発生した、**When** 同じユーザーが再試行する、**Then** システムは冪等性を保証し、重複購入を防止する

---

### ユーザーストーリー3 - 購入進捗の確認と開奖結果の閲覧 (優先度: P2)

ユーザーとして、参加中のキャンペーンの販売進捗をリアルタイムで確認し、全ポジションが売り切れた際に自動開奖された結果を閲覧したい。

**優先度理由**: ユーザーエンゲージメントを高める重要機能。透明性と期待感を提供するが、購入機能に依存するため P2。

**独立テスト**: 既存の購入データを使って、進捗表示と開奖結果表示が正しく動作することを確認。

**受入シナリオ**:

1. **Given** ユーザーが参加中のキャンペーンを持っている、**When** 「マイキャンペーン」画面を開く、**Then** 各キャンペーンの現在の販売進捗（パーセンテージとビジュアル表現）が表示される
2. **Given** キャンペーンの全ポジションが販売完了した、**When** システムが自動開奖処理を実行する、**Then** 各賞品の当選ポジションが決定され、該当ユーザーにプッシュ通知が送信される
3. **Given** 開奖が完了している、**When** ユーザーが結果画面を開く、**Then** 三角形全体が表示され、賞品の配置と自分の購入ポジションが強調表示され、当選/落選ステータスが明確に示される
4. **Given** ユーザーが賞品に当選した、**When** 結果画面で当選詳細を確認する、**Then** 賞品の受取方法、配送先情報入力フォーム、受取期限が表示される

---

### ユーザーストーリー4 - 複数ユーザーの同時購入制御 (優先度: P1)

システムとして、複数のユーザーが同時に同じ層のポジションを購入しようとした際に、データの整合性を保証し、販売可能数を超える購入を防止したい。

**優先度理由**: システムの信頼性とデータ整合性の根幹。競合状態やオーバーセリングを防ぐ必須機能。

**独立テスト**: 負荷テストツールで同時購入リクエストを送信し、データベースの制約とトランザクション管理が正しく機能することを確認。

**受入シナリオ**:

1. **Given** Layer 3に残り1ポジションのみ、**When** 2人のユーザーが同時に購入ボタンを押す、**Then** 1人のみが購入成功し、もう1人には「このポジションは既に購入されました」エラーメッセージが表示される
2. **Given** トランザクション処理中、**When** データベース接続エラーが発生する、**Then** システムはロールバックし、ユーザーには再試行を促すエラーメッセージを表示し、決済は実行されない
3. **Given** 支払い処理が完了した、**When** システム内部エラーによりポジション割当が失敗する、**Then** システムは自動的に返金処理を開始し、ユーザーに通知する

---

### ユーザーストーリー5 - 日本の決済手段対応 (優先度: P1)

ユーザーとして、クレジットカード、デビットカード、日本の主要コンビニ決済（ローソン、ファミリーマート、セブンイレブン等）を利用して安全に支払いを完了したい。

**優先度理由**: 日本市場での必須要件。多様な決済手段がなければ、ユーザー層が限定される。

**独立テスト**: Stripeのテストモードで各決済手段をシミュレートし、成功/失敗シナリオを検証。

**受入シナリオ**:

1. **Given** 購入確定画面で決済方法選択中、**When** クレジットカードを選択する、**Then** Stripe の PCI DSS準拠の決済フォームが表示され、カード情報を安全に入力できる
2. **Given** コンビニ決済を選択した、**When** 決済を確定する、**Then** システムはコンビニ決済用の番号（払込票番号）を生成し、支払い期限（4日間）と共に表示する
3. **Given** コンビニ決済番号が発行された、**When** ユーザーが期限内にコンビニで支払いを完了する、**Then** Stripe からの Webhook 通知を受信し、システムはポジションを正式に割り当て、ユーザーに確認通知を送信する
4. **Given** コンビニ決済番号が発行された、**When** 期限内に支払いが完了しない、**Then** システムは予約を自動キャンセルし、ポジションを再販売可能にする

---

### エッジケース

- **キャンペーン公開後の変更**: 公開済みキャンペーンのパラメータ（価格、賞品）を変更しようとした場合、システムはどう対応するか？→ 販売開始後は価格と賞品の変更を禁止し、警告メッセージを表示する。管理者は新しいキャンペーンを作成する必要がある。
- **同時開奖処理**: 最後の2つのポジションがほぼ同時に購入され、両方が「全売却完了」をトリガーした場合、開奖処理が二重実行されないか？→ 開奖処理は冪等性を持たせ、ステータスフラグで制御する。
- **返金処理の失敗**: 自動返金が Stripe 側のエラーで失敗した場合、どう処理するか？→ 返金失敗をログに記録し、管理者ダッシュボードに手動対応が必要な項目として表示する。
- **不完全な配送情報**: ユーザーが当選したが、配送先住所が未登録または不完全な場合は？→ 賞品受取期限内に配送情報の入力を促すプッシュ通知とメールを送信する。期限切れの場合、賞品は無効となる。
- **アプリクラッシュ時の決済状態**: ユーザーアプリが決済処理中にクラッシュした場合、ユーザーはどこから再開するか？→ サーバー側で決済状態を管理し、再起動後に「処理中の購入」セクションで状態を確認できるようにする。
- **購入数制限**: 1ユーザーが1つのキャンペーンで購入できるポジション数はデフォルトで8ポジションまでとする。管理者がキャンペーン作成時に購入上限を変更でき、制限なしにする場合は空欄または"-"を設定する。

## 要件 *(必須)*

### 機能要件

#### キャンペーン管理機能

- **FR-001**: システムは管理者が三角形キャンペーンを作成する際、底辺の長さ（3〜50の整数）を入力できなければならない
- **FR-002**: システムは底辺長さ N に基づき、総ポジション数 N(N+1)/2 を自動計算しなければならない
- **FR-003**: システムは管理者が各層（Layer 1 から Layer N）に個別の価格を設定できなければならない（日本円、100円〜1,000,000円の範囲）
- **FR-004**: システムは管理者が複数の賞品を登録し、各賞品に名称、説明、画像、推定価値、配置層を設定できなければならない
- **FR-005**: システムは賞品配置層と価格設定に基づき、自動的に期待利益率を計算し、管理者に表示しなければならない
- **FR-006**: システムは利益率が15%未満の場合、管理者に警告メッセージを表示しなければならない
- **FR-007**: システムはキャンペーンのステータスを「下書き」「公開」「進行中」「完了」で管理しなければならない
- **FR-008**: システムは公開済みキャンペーンの価格と賞品設定の変更を禁止しなければならない
- **FR-009**: システムは管理者がキャンペーン作成時に1ユーザーあたりの購入上限数を設定できなければならない（デフォルト: 8ポジション、空欄または"-"で制限なし）

#### ユーザー購入機能

- **FR-010**: システムはユーザーに公開中のキャンペーン一覧を表示し、各キャンペーンの進捗状況（残りポジション数/総ポジション数）を表示しなければならない
- **FR-011**: システムはユーザーがキャンペーン詳細画面で三角形の層を選択し、その層の価格と残りポジション数を確認できなければならない
- **FR-012**: システムはユーザーが購入時に、そのキャンペーンで設定された購入上限数に達しているかを確認しなければならない
- **FR-013**: システムはユーザーが購入上限に達している場合、購入を拒否し、明確なエラーメッセージを表示しなければならない
- **FR-014**: システムはユーザーが層を選択して購入する際、その層内のランダムな未販売ポジションを割り当てなければならない
- **FR-015**: システムはポジション割当時にデータベーストランザクションを使用し、複数ユーザーの同時購入による競合を防止しなければならない
- **FR-016**: システムは同一購入リクエストに対して冪等性を保証し、重複購入を防止しなければならない（リクエストID による制御）
- **FR-017**: システムは購入確定後、ユーザーに購入確認画面でポジション番号と三角形上の座標（行、列）を表示しなければならない

#### 決済機能

- **FR-018**: システムは Stripe を利用して、クレジットカード決済（Visa、Mastercard、JCB、American Express）に対応しなければならない
- **FR-019**: システムは Stripe を利用して、デビットカード決済に対応しなければならない
- **FR-020**: システムは Stripe を利用して、日本のコンビニ決済（ローソン、ファミリーマート、セブンイレブン、ミニストップ等）に対応しなければならない
- **FR-021**: システムはコンビニ決済選択時、払込票番号と支払い期限（4日間）を生成し、ユーザーに表示しなければならない
- **FR-022**: システムは Stripe からの Webhook 通知を受信し、決済完了/失敗/キャンセルのステータスを正確に処理しなければならない
- **FR-023**: システムは決済完了後にポジション割当が失敗した場合、自動的に返金処理を Stripe 経由で実行しなければならない
- **FR-024**: システムはコンビニ決済の支払い期限（4日間）超過時、予約を自動キャンセルし、ポジションを再販売可能にしなければならない
- **FR-025**: システムは PCI DSS 準拠を維持するため、カード情報を直接保存せず、Stripe のトークン化機能を使用しなければならない

#### 進捗管理と開奖機能

- **FR-026**: システムはユーザーに「マイキャンペーン」画面で参加中のキャンペーン一覧と各キャンペーンの販売進捗をリアルタイムで表示しなければならない
- **FR-027**: システムはキャンペーンの全ポジションが販売完了した際、自動的に開奖処理を実行しなければならない
- **FR-028**: システムは開奖処理で各賞品を配置された層のランダムなポジションに割り当てなければならない
- **FR-029**: システムは開奖処理の冪等性を保証し、重複実行を防止しなければならない（ステータスフラグによる制御）
- **FR-030**: システムは開奖完了後、当選ユーザーにプッシュ通知を送信しなければならない
- **FR-031**: システムはユーザーに開奖結果画面で三角形全体を表示し、賞品配置と自分の購入ポジションを視覚的に示さなければならない
- **FR-032**: システムは当選ユーザーに賞品受取方法、配送先情報入力フォーム、受取期限を表示しなければならない

#### ユーザー管理機能

- **FR-033**: システムはユーザーがメールアドレスとパスワードでアカウントを作成できなければならない
- **FR-034**: システムはユーザーがソーシャルログイン（Google、Apple）でアカウントを作成できなければならない
- **FR-035**: システムはユーザーのプロフィール情報（氏名、電話番号、配送先住所）を管理しなければならない
- **FR-036**: システムはユーザーの購入履歴と当選履歴を記録し、閲覧可能にしなければならない

#### 通知機能

- **FR-037**: システムは重要イベント（購入確認、開奖完了、当選通知）をプッシュ通知で送信しなければならない
- **FR-038**: システムはプッシュ通知と同じ内容をメールでも送信しなければならない
- **FR-039**: システムはユーザーが通知設定（プッシュ通知の ON/OFF、メール通知の ON/OFF）をカスタマイズできなければならない

#### セキュリティとコンプライアンス

- **FR-040**: システムは API リクエストに対してレート制限を実装し、不正な大量リクエストを防止しなければならない
- **FR-041**: システムはすべての決済トランザクションを暗号化された通信（HTTPS/TLS 1.2以上）で処理しなければならない
- **FR-042**: システムはユーザーの個人情報を暗号化して保存し、日本の個人情報保護法に準拠しなければならない
- **FR-043**: システムはすべての重要操作（購入、開奖、返金）を監査ログに記録しなければならない
- **FR-044**: システムは管理者の操作履歴を記録し、不正アクセスを検出できなければならない

### 主要エンティティ

- **キャンペーン**: 抽選イベントを表す。属性: キャンペーン ID、名称、説明、底辺長さ、ステータス（下書き/公開/進行中/完了）、開始日時、終了日時、作成者（管理者）、開奖日時、購入上限数（デフォルト8、制限なしの場合はnull）
- **層（Layer）**: 三角形の各段を表す。属性: 層番号（1〜N）、価格、ポジション数、残りポジション数、キャンペーン ID
- **ポジション**: 三角形内の個別の販売単位。属性: ポジション ID、キャンペーン ID、層番号、行番号、列番号、ステータス（未販売/予約中/販売済）、購入ユーザー ID、購入日時
- **賞品**: キャンペーンで提供される景品。属性: 賞品 ID、名称、説明、画像 URL、推定価値、配置層番号、当選ポジション ID（開奖後）、キャンペーン ID
- **購入**: ユーザーの購入記録。属性: 購入 ID、ユーザー ID、キャンペーン ID、ポジション ID、購入価格、決済方法、決済ステータス（処理中/成功/失敗/返金済）、リクエスト ID（冪等性制御用）、作成日時
- **決済トランザクション**: Stripe との決済情報。属性: トランザクション ID、購入 ID、Stripe 決済 ID、決済方法、金額、ステータス、Webhook 受信日時、返金トランザクション ID（返金時）
- **ユーザー**: アプリ利用者。属性: ユーザー ID、メールアドレス、氏名、電話番号、配送先住所、認証方法（メール/Google/Apple）、登録日時
- **通知**: ユーザーへの通知記録。属性: 通知 ID、ユーザー ID、通知タイプ（購入確認/開奖通知/当選通知）、メッセージ内容、送信日時、既読フラグ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーがキャンペーン閲覧から購入完了まで、3分以内に完了できる
- **SC-002**: システムは同時に500人のユーザーが購入操作を行っても、応答時間が3秒以内である
- **SC-003**: 決済成功率が95%以上である（Stripe のダウンタイムを除く）
- **SC-004**: 複数ユーザーの同時購入において、オーバーセリング（販売可能数超過）が0件である
- **SC-005**: 開奖処理が全ポジション販売完了後、5分以内に自動実行される
- **SC-006**: ユーザーの90%が開奖結果画面で自分のポジションと賞品配置を即座に理解できる
- **SC-007**: プッシュ通知が重要イベント発生後、1分以内にユーザーデバイスに配信される
- **SC-008**: システムの稼働率が99.5%以上である（月次計測）
- **SC-009**: 管理者がキャンペーンを作成し、公開するまでの操作時間が10分以内である
- **SC-010**: ユーザーからの問い合わせのうち、決済トラブルに関するものが全問い合わせの5%以下である

## 前提条件と依存関係 *(必須)*

### 前提条件

- iOS アプリは App Store、Android アプリは Google Play Store で配信される
- ユーザーは iOS 14.0以上または Android 8.0以上のデバイスを使用している
- ユーザーはインターネット接続環境（Wi-Fi または 4G/5G）を持っている
- 管理者は Web ブラウザ（Chrome、Safari、Edge の最新版）からアクセスする
- Stripe アカウントが日本で利用可能であり、必要な決済手段がアクティブ化されている
- 賞品の物理的な在庫管理と配送は外部システムまたは手動プロセスで行われる

### 依存関係

- **Stripe 決済 API**: すべての決済処理と返金処理に依存
- **Stripe Webhook**: 決済ステータスの非同期更新に依存
- **プッシュ通知サービス**: Firebase Cloud Messaging（FCM）または Apple Push Notification Service（APNs）に依存
- **メール送信サービス**: SendGrid または AWS SES などのメール配信サービスに依存
- **画像ストレージ**: 賞品画像とキャンペーン画像の保存に AWS S3 または類似のクラウドストレージに依存

### 技術的前提

- Flutter フレームワークを使用して iOS/Android のクロスプラットフォーム開発を行う
- バックエンドは Node.js で実装される
- データベースは PostgreSQL を使用する
- すべての通信は HTTPS/TLS 1.2以上で暗号化される
- PCI DSS 準拠のために、カード情報は Stripe のトークン化機能を使用し、自社サーバーには保存しない

## 想定事項 *(オプション)*

- キャンペーンの平均底辺長さは10〜20の範囲であり、ポジション数は55〜210個と想定される
- 1つのキャンペーンの販売期間は1週間〜1ヶ月程度と想定される
- ユーザーの大多数は日本国内在住であり、日本語のみのサポートで十分である
- 賞品の配送は日本国内のみ対応する
- 管理者は少数（1〜5名）であり、管理画面のパフォーマンスはユーザー向けアプリほど重要ではない
- コンビニ決済の支払い期限は4日間とする
- 1ユーザーあたりの購入上限はデフォルトで8ポジションとし、管理者が各キャンペーンで変更可能とする
- 開奖時の賞品割当はシステムがランダムに実行し、管理者の手動介入は不要と想定される
- 当選ユーザーへの賞品配送手配は管理者が手動で行い、配送追跡機能は MVP では不要と想定される

## スコープ外 *(オプション)*

以下の機能は本フィーチャーの範囲外とする:

- **多言語対応**: 日本語以外の言語サポート（英語、中国語等）
- **海外決済**: 日本国外のクレジットカードや決済手段のサポート
- **リアルタイムチャット**: ユーザー間またはユーザー・管理者間のチャット機能
- **ソーシャル共有機能**: SNS（Twitter、Instagram、Facebook等）への購入状況や当選結果の共有
- **二次流通市場**: ユーザー間でのポジション転売や譲渡機能
- **サブスクリプション**: 定期購入や VIP メンバーシップ制度
- **アフィリエイト/紹介プログラム**: ユーザーが他ユーザーを紹介して報酬を得る機能
- **高度な分析ダッシュボード**: 管理者向けの詳細な売上分析、ユーザー行動分析、A/B テスト機能
- **カスタム三角形形状**: 等腰三角形以外の形状（正三角形、不等辺三角形、四角形等）
- **動的価格設定**: 残りポジション数に応じた自動価格変動
- **ライブ抽選イベント**: リアルタイムで視聴可能な抽選配信機能

## リスクと軽減策 *(オプション)*

| リスク | 影響度 | 発生確率 | 軽減策 |
| ------ | ------ | -------- | ------ |
| Stripe の API ダウンタイムによる決済不可 | 高 | 低 | Stripe のステータスページを監視し、ダウンタイム時にはユーザーに明確なメッセージを表示。復旧後の自動リトライ機能を実装 |
| 同時購入による競合状態とデータ不整合 | 高 | 中 | PostgreSQL のトランザクション分離レベルを SERIALIZABLE に設定。楽観的ロックまたは悲観的ロックを適切に実装 |
| プッシュ通知が届かない（ユーザーの設定や OS の制限） | 中 | 中 | プッシュ通知とメール通知の両方を送信。アプリ内通知センターも提供 |
| コンビニ決済の支払い確認遅延 | 中 | 中 | Webhook のリトライ機能を実装。支払い確認が遅延している購入を定期的にチェックし、Stripe API で手動確認 |
| 大量の不正購入やボット攻撃 | 高 | 中 | API レート制限を厳格に設定。reCAPTCHA または類似の Bot 対策を購入フローに導入。異常パターンの検出と自動ブロック |
| 賞品の在庫切れや配送トラブル | 中 | 低 | キャンペーン公開前に賞品の在庫を確認するチェックリストを管理者向けに提供。配送状況を追跡する外部システムと連携（将来的な拡張） |
| ユーザーの返金要求増加 | 中 | 中 | 購入前に利用規約と返金ポリシーを明示。正当な理由（システムエラー、二重請求等）のみ返金対応 |
| iOS/Android の OS アップデートによる互換性問題 | 中 | 低 | Flutter の最新安定版を定期的に適用。主要 OS バージョンでの回帰テストを自動化 |

---

**注記**: 本仕様書は要件定義段階のドキュメントであり、技術実装の詳細は含まれていません。すべての明確化が完了しましたので、次のフェーズとして `/speckit.plan` コマンドで実装計画を策定してください。
