# 包括的単体テストレポート

## テスト概要

このレポートは、TriPrize API の包括的単体テストの実行結果をまとめたものです。

## テスト対象機能

### 1. 認証フロー（登録・ログイン）

#### テストファイル
- `tests/unit/controllers/auth-flow-comprehensive.test.ts`

#### テストケース
- ✅ 顧客として新規登録が成功する
- ✅ 既存のメールアドレスで登録しようとすると409エラーを返す
- ✅ 管理者として新規登録が成功する
- ✅ INITIAL_ADMIN_EMAILで管理者として登録される
- ✅ 顧客としてログインが成功する
- ✅ 存在しないユーザーでログインしようとすると404エラーを返す
- ✅ 管理者としてログインが成功する
- ✅ モック認証で顧客として登録できる
- ✅ モック認証で管理者として登録できる
- ✅ モック認証でログインできる

### 2. 購入フロー

#### テストファイル
- `tests/unit/controllers/purchase-flow-comprehensive.test.ts`

#### テストケース
- ✅ 顧客がポジションを購入できる
- ✅ 冪等性キーが提供された場合、それを使用する
- ✅ 未認証ユーザーは購入できない
- ✅ 顧客が自分の購入履歴を取得できる
- ✅ 顧客が自分の購入詳細を取得できる
- ✅ 他のユーザーの購入詳細は取得できない

### 3. 抽選フロー

#### テストファイル
- `tests/unit/controllers/lottery-flow-comprehensive.test.ts`

#### テストケース
- ✅ 管理者が抽選を実行できる
- ✅ 顧客は抽選を実行できない
- ✅ 誰でもキャンペーンの抽選結果を取得できる
- ✅ 顧客が自分の当選結果を取得できる
- ✅ 顧客が特定キャンペーンで当選した場合、当選情報を取得できる
- ✅ 顧客が特定キャンペーンで当選していない場合、nullを返す

### 4. 管理者管理画面

#### テストファイル
- `tests/unit/controllers/admin-management-comprehensive.test.ts`

#### テストケース
- ✅ 管理者がユーザー一覧を取得できる
- ✅ ページネーションが正しく動作する
- ✅ 管理者がユーザーのロールを更新できる
- ✅ 無効なロールを指定すると400エラーを返す
- ✅ 管理者がキャンペーンの統計情報を取得できる
- ✅ 管理者がキャンペーンの抽選結果一覧を取得できる
- ✅ 管理者が存在する場合、trueを返す
- ✅ 管理者が存在しない場合、falseを返す

## テスト実行方法

```bash
cd api
npm test
```

カバレッジレポート付きで実行:

```bash
cd api
npm test -- --coverage
```

包括的テストのみ実行:

```bash
cd api
npx jest --coverage --no-watchman --testPathPattern="comprehensive"
```

## カバレッジレポート

カバレッジレポートは以下のコマンドで生成されます:

```bash
cd api
npm test -- --coverage
```

レポートは `coverage/lcov-report/index.html` に生成されます。

## テスト結果の確認

各テストファイルは以下の機能をカバーしています:

1. **認証フロー**: 顧客・管理者の登録・ログイン機能
2. **購入フロー**: ポジション購入、購入履歴取得、冪等性制御
3. **抽選フロー**: 管理者による抽選実行、当選結果確認
4. **管理者管理**: ユーザー管理、統計情報取得、抽選結果確認

## 注意事項

- すべてのテストはモックを使用しており、実際のデータベース接続は不要です
- Firebase Admin SDK はモック化されています
- テスト実行前に `npm install` を実行してください
