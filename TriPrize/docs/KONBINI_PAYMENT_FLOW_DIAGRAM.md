# Konbini æ”¯ä»˜æµç¨‹å¯¹æ¯”å›¾

## ğŸ”´ å½“å‰å®ç°ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ PaymentProcessingPage                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ 1. createPurchase()
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              POST /api/purchases                             â”‚
â”‚  è¯·æ±‚: { campaign_id, position_ids, payment_method: 'konbini' }â”‚
â”‚  å“åº”: Purchase { purchase_id, status: 'pending', ... }      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ âœ… Purchase åˆ›å»ºæˆåŠŸ
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ä»£ç : payment_processing_page.dart:378-390              â”‚
â”‚                                                              â”‚
â”‚  if (widget.paymentMethod == 'konbini') {                   â”‚
â”‚    // âŒ ä½¿ç”¨ç¡¬ç¼–ç çš„æ¨¡æ‹Ÿæ•°æ®                                â”‚
â”‚    _paymentIntent = PaymentIntentModel(                      â”‚
â”‚      paymentIntentId: 'pi_konbini_${timestamp}',            â”‚
â”‚      konbiniReference: '123456789012',  // âŒ å‡çš„ï¼         â”‚
â”‚      konbiniExpiresAt: DateTime.now() + 4 days,             â”‚
â”‚    );                                                        â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ âŒ æ²¡æœ‰è°ƒç”¨åç«¯ API
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜¾ç¤ºæ”¯ä»˜ç¼–å·: "123456789012"  (å‡çš„ï¼Œç”¨æˆ·æ— æ³•æ”¯ä»˜ï¼)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… æ­£ç¡®å®ç°ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ PaymentProcessingPage                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ 1. createPurchase()
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              POST /api/purchases                             â”‚
â”‚  è¯·æ±‚: { campaign_id, position_ids, payment_method: 'konbini' }â”‚
â”‚  å“åº”: Purchase { purchase_id, status: 'pending', ... }      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ âœ… Purchase åˆ›å»ºæˆåŠŸ
                          â”‚
                          â”‚ 2. createPaymentIntent()
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         POST /api/payments/create-intent                     â”‚
â”‚  è¯·æ±‚: { purchase_id, payment_method: 'konbini' }           â”‚
â”‚  å“åº”: {                                                    â”‚
â”‚    payment_intent_id: "pi_xxx",                            â”‚
â”‚    transaction_id: "xxx",                                  â”‚
â”‚    amount: 1000,                                           â”‚
â”‚    status: "requires_payment_method"                       â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ âœ… PaymentIntent åˆ›å»ºæˆåŠŸ
                          â”‚
                          â”‚ 3. getKonbiniDetails()
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      GET /api/payments/konbini/:paymentIntentId             â”‚
â”‚  å“åº”: {                                                    â”‚
â”‚    store_type: "lawson",                                   â”‚
â”‚    confirmation_number: "123456789012",  // âœ… çœŸå®æ•°æ®ï¼   â”‚
â”‚    payment_code: "123456789012",                           â”‚
â”‚    expires_at: "2025-12-05T12:00:00Z",                     â”‚
â”‚    instructions_url: "https://..."                          â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ âœ… è·å–åˆ°çœŸå®æ•°æ®
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜¾ç¤ºæ”¯ä»˜ç¼–å·: "123456789012"  (çœŸå®ï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¾¿åˆ©åº—æ”¯ä»˜ï¼) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®æµå¯¹æ¯”

### å½“å‰æµç¨‹ï¼ˆé”™è¯¯ï¼‰
```
Purchase API
    â†“
å‰ç«¯ç›´æ¥ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    â†“
æ˜¾ç¤ºå‡çš„æ”¯ä»˜ç¼–å· âŒ
```

### æ­£ç¡®æµç¨‹
```
Purchase API
    â†“
PaymentIntent API
    â†“
Konbini Details API
    â†“
æ˜¾ç¤ºçœŸå®çš„æ”¯ä»˜ç¼–å· âœ…
```

## ğŸ”‘ å…³é”®é—®é¢˜

### é—®é¢˜ 1: API è°ƒç”¨ç¼ºå¤±
```dart
// âŒ å½“å‰ä»£ç ç¼ºå°‘è¿™äº›è°ƒç”¨ï¼š
// POST /api/payments/create-intent
// GET /api/payments/konbini/:id
```

### é—®é¢˜ 2: æ•°æ®æºæ–¹æ³•ç¼ºå¤±
```dart
// âŒ purchase_remote_datasource.dart ä¸­ç¼ºå°‘ï¼š
Future<PaymentIntentModel> createPaymentIntent(...);
Future<KonbiniPaymentInfo> getKonbiniDetails(...);
```

### é—®é¢˜ 3: æ—¶åºé—®é¢˜
```
å½“å‰: Purchase â†’ ç«‹å³æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
æ­£ç¡®: Purchase â†’ PaymentIntent â†’ KonbiniInfo â†’ æ˜¾ç¤ºçœŸå®æ•°æ®
```

## ğŸ’¡ ä¸ºä»€ä¹ˆä¸èƒ½ç”¨çœŸå®æ•°æ®ï¼Ÿ

### æŠ€æœ¯å±‚é¢
1. **æ²¡æœ‰ PaymentIntent ID**
   - å‰ç«¯æ²¡æœ‰è°ƒç”¨ `createPaymentIntent` API
   - å› æ­¤æ²¡æœ‰ `payment_intent_id`
   - æ²¡æœ‰ ID å°±æ— æ³•è·å– Konbini è¯¦æƒ…

2. **æ•°æ®æµæ–­è£‚**
   - åç«¯è®¾è®¡ï¼šPurchase â†’ PaymentIntent â†’ KonbiniInfo
   - å‰ç«¯å®ç°ï¼šPurchase â†’ æ¨¡æ‹Ÿæ•°æ®
   - ä¸­é—´ç¯èŠ‚ç¼ºå¤±

### ä¸šåŠ¡å±‚é¢
1. **ç”¨æˆ·æ— æ³•æ”¯ä»˜**
   - æ¨¡æ‹Ÿçš„æ”¯ä»˜ç¼–å· `123456789012` åœ¨ Stripe ä¸­ä¸å­˜åœ¨
   - ç”¨æˆ·åœ¨ä¾¿åˆ©åº—æ— æ³•ä½¿ç”¨è¿™ä¸ªç¼–å·æ”¯ä»˜
   - å¯¼è‡´è´­ä¹°æµç¨‹æ— æ³•å®Œæˆ

2. **æ•°æ®ä¸ä¸€è‡´**
   - å‰ç«¯æ˜¾ç¤ºçš„æ˜¯å‡æ•°æ®
   - åç«¯æ²¡æœ‰å¯¹åº”çš„ PaymentIntent
   - æ”¯ä»˜çŠ¶æ€æ— æ³•åŒæ­¥

## ğŸ¯ ä¿®å¤åçš„æ•ˆæœ

### ä¿®å¤å‰
```
ç”¨æˆ·çœ‹åˆ°: "123456789012" (å‡çš„)
Stripe ä¸­: ä¸å­˜åœ¨è¿™ä¸ª PaymentIntent
ç»“æœ: ç”¨æˆ·æ— æ³•æ”¯ä»˜ âŒ
```

### ä¿®å¤å
```
ç”¨æˆ·çœ‹åˆ°: "987654321098" (çœŸå®çš„)
Stripe ä¸­: å­˜åœ¨å¯¹åº”çš„ PaymentIntent
ç»“æœ: ç”¨æˆ·å¯ä»¥åœ¨ä¾¿åˆ©åº—æ”¯ä»˜ âœ…
```
