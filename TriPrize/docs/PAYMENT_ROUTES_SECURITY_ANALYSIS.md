# æ”¯ä»˜è·¯ç”±å®‰å…¨åˆ†æï¼šé€Ÿç‡é™åˆ¶å’Œå¹‚ç­‰æ€§ä¸­é—´ä»¶

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

éƒ¨åˆ†æ”¯ä»˜è·¯ç”±ç¼ºå°‘**é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰**å’Œ**å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰**ä¸­é—´ä»¶ï¼Œå­˜åœ¨å®‰å…¨é£é™©å’Œé‡å¤æ“ä½œé£é™©ã€‚

## ğŸ” ä»€ä¹ˆæ˜¯é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶ï¼Ÿ

### å®šä¹‰

**é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰**æ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶ï¼Œç”¨äºé™åˆ¶ç”¨æˆ·åœ¨ç‰¹å®šæ—¶é—´çª—å£å†…å¯ä»¥å‘é€çš„è¯·æ±‚æ•°é‡ã€‚

### å·¥ä½œåŸç†

```typescript
// ç¤ºä¾‹ï¼špurchase é€Ÿç‡é™åˆ¶é…ç½®
rateLimits.purchase = rateLimit({
  windowMs: 60 * 1000,      // æ—¶é—´çª—å£ï¼š1åˆ†é’Ÿ
  maxRequests: 5,            // æœ€å¤§è¯·æ±‚æ•°ï¼š5æ¬¡
  keyPrefix: 'purchase',     // Redis key å‰ç¼€
});
```

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·å‘é€è¯·æ±‚
  â†“
æ£€æŸ¥ Redis ä¸­è¯¥ç”¨æˆ·çš„è¯·æ±‚è®¡æ•°
  â†“
å¦‚æœè®¡æ•° < 5 â†’ å…è®¸è¯·æ±‚ï¼Œè®¡æ•° +1
å¦‚æœè®¡æ•° >= 5 â†’ æ‹’ç»è¯·æ±‚ï¼Œè¿”å› 429 Too Many Requests
  â†“
1åˆ†é’Ÿåï¼Œè®¡æ•°é‡ç½®
```

### ä¸ºä»€ä¹ˆéœ€è¦é€Ÿç‡é™åˆ¶ï¼Ÿ

#### 1. **é˜²æ­¢æ»¥ç”¨å’Œæ”»å‡»**
- âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼šæ”»å‡»è€…å¯ä»¥æ¯ç§’å‘é€1000æ¬¡è¯·æ±‚ï¼Œå¯¼è‡´æœåŠ¡å™¨å´©æºƒ
- âœ… æœ‰é€Ÿç‡é™åˆ¶ï¼šæ¯åˆ†é’Ÿæœ€å¤š5æ¬¡è¯·æ±‚ï¼Œæœ‰æ•ˆé˜²æ­¢æ”»å‡»

#### 2. **ä¿æŠ¤æ”¯ä»˜ç³»ç»Ÿ**
- æ”¯ä»˜æ“ä½œæ¶‰åŠèµ„é‡‘ï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶é¢‘ç‡
- é˜²æ­¢æ¶æ„ç”¨æˆ·å¿«é€Ÿåˆ›å»ºå¤§é‡æ”¯ä»˜è¯·æ±‚
- é˜²æ­¢è‡ªåŠ¨åŒ–è„šæœ¬æ”»å‡»

#### 3. **å…¬å¹³ä½¿ç”¨èµ„æº**
- ç¡®ä¿æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½æ­£å¸¸ä½¿ç”¨æœåŠ¡
- é˜²æ­¢å•ä¸ªç”¨æˆ·å ç”¨è¿‡å¤šèµ„æº

## ğŸ” ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ä¸­é—´ä»¶ï¼Ÿ

### å®šä¹‰

**å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰**æ˜¯æŒ‡åŒä¸€ä¸ªè¯·æ±‚æ‰§è¡Œå¤šæ¬¡å’Œæ‰§è¡Œä¸€æ¬¡çš„æ•ˆæœç›¸åŒã€‚

### å·¥ä½œåŸç†

```typescript
// å¹‚ç­‰æ€§ä¸­é—´ä»¶ç¤ºä¾‹
idempotencyMiddleware(24 * 60 * 60) // 24å°æ—¶å¹‚ç­‰æ€§çª—å£
```

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·å‘é€è¯·æ±‚ï¼ˆåŒ…å«è¯·æ±‚ä½“ï¼‰
  â†“
è®¡ç®—è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†ï¼šhash(ç”¨æˆ·ID + è·¯å¾„ + è¯·æ±‚ä½“)
  â†“
æ£€æŸ¥ Redis ä¸­æ˜¯å¦å­˜åœ¨è¯¥æ ‡è¯†
  â†“
å¦‚æœä¸å­˜åœ¨ â†’ å¤„ç†è¯·æ±‚ï¼Œå­˜å‚¨å“åº”åˆ° Redis
å¦‚æœå­˜åœ¨ â†’ ç›´æ¥è¿”å›ç¼“å­˜çš„å“åº”ï¼ˆä¸é‡å¤å¤„ç†ï¼‰
  â†“
24å°æ—¶åï¼Œç¼“å­˜è¿‡æœŸ
```

### ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§ï¼Ÿ

#### 1. **é˜²æ­¢é‡å¤æ”¯ä»˜**
```
åœºæ™¯ï¼šç”¨æˆ·ç‚¹å‡»"æ”¯ä»˜"æŒ‰é’®ï¼Œç½‘ç»œå»¶è¿Ÿå¯¼è‡´é‡å¤è¯·æ±‚

âŒ æ²¡æœ‰å¹‚ç­‰æ€§ï¼š
  è¯·æ±‚1 â†’ åˆ›å»º PaymentIntent A
  è¯·æ±‚2 â†’ åˆ›å»º PaymentIntent B  (é‡å¤ï¼)
  ç»“æœï¼šç”¨æˆ·è¢«æ‰£æ¬¾ä¸¤æ¬¡ï¼

âœ… æœ‰å¹‚ç­‰æ€§ï¼š
  è¯·æ±‚1 â†’ åˆ›å»º PaymentIntent Aï¼Œç¼“å­˜å“åº”
  è¯·æ±‚2 â†’ æ£€æµ‹åˆ°é‡å¤ï¼Œç›´æ¥è¿”å› PaymentIntent A
  ç»“æœï¼šç”¨æˆ·åªè¢«æ‰£æ¬¾ä¸€æ¬¡
```

#### 2. **å¤„ç†ç½‘ç»œé‡è¯•**
```
åœºæ™¯ï¼šç§»åŠ¨ç½‘ç»œä¸ç¨³å®šï¼Œè‡ªåŠ¨é‡è¯•æœºåˆ¶è§¦å‘

âŒ æ²¡æœ‰å¹‚ç­‰æ€§ï¼š
  åŸå§‹è¯·æ±‚ â†’ å·²å¤„ç†ï¼Œä½†å“åº”ä¸¢å¤±
  é‡è¯•è¯·æ±‚ â†’ å†æ¬¡å¤„ç†ï¼Œå¯¼è‡´é‡å¤æ“ä½œ

âœ… æœ‰å¹‚ç­‰æ€§ï¼š
  åŸå§‹è¯·æ±‚ â†’ å·²å¤„ç†ï¼Œå“åº”å·²ç¼“å­˜
  é‡è¯•è¯·æ±‚ â†’ è¿”å›ç¼“å­˜å“åº”ï¼Œä¸é‡å¤å¤„ç†
```

#### 3. **é˜²æ­¢å¹¶å‘é‡å¤è¯·æ±‚**
```
åœºæ™¯ï¼šç”¨æˆ·å¿«é€ŸåŒå‡»æŒ‰é’®ï¼ŒåŒæ—¶å‘é€ä¸¤ä¸ªç›¸åŒè¯·æ±‚

âŒ æ²¡æœ‰å¹‚ç­‰æ€§ï¼š
  è¯·æ±‚A â†’ æ­£åœ¨å¤„ç†...
  è¯·æ±‚B â†’ ä¹Ÿåœ¨å¤„ç†... (é‡å¤ï¼)

âœ… æœ‰å¹‚ç­‰æ€§ï¼š
  è¯·æ±‚A â†’ è·å–é”ï¼Œæ­£åœ¨å¤„ç†...
  è¯·æ±‚B â†’ æ£€æµ‹åˆ°é”ï¼Œè¿”å› 409 Conflict
```

## ğŸ“Š å½“å‰æ”¯ä»˜è·¯ç”±å®‰å…¨çŠ¶æ€

### âœ… å·²ä¿æŠ¤çš„è·¯ç”±

```typescript
// POST /api/payments/create-intent
router.post(
  '/create-intent',
  rateLimits.purchase,                    // âœ… é€Ÿç‡é™åˆ¶ï¼š1åˆ†é’Ÿ5æ¬¡
  idempotencyMiddleware(24 * 60 * 60),  // âœ… å¹‚ç­‰æ€§ï¼š24å°æ—¶çª—å£
  validateBody(createPaymentIntentSchema),
  paymentController.createPaymentIntent
);
```

**ä¿æŠ¤æ•ˆæœ**ï¼š
- âœ… é˜²æ­¢é¢‘ç¹åˆ›å»ºæ”¯ä»˜æ„å›¾
- âœ… é˜²æ­¢é‡å¤åˆ›å»ºæ”¯ä»˜æ„å›¾
- âœ… é˜²æ­¢ç½‘ç»œé‡è¯•å¯¼è‡´çš„é‡å¤æ“ä½œ

### âŒ ç¼ºå°‘ä¿æŠ¤çš„è·¯ç”±

#### 1. **POST /api/payments/confirm** - ç¡®è®¤æ”¯ä»˜

```typescript
// å½“å‰ä»£ç 
router.post(
  '/confirm',
  validateBody(confirmPaymentSchema),
  paymentController.confirmPayment
);
```

**é£é™©**ï¼š
- âŒ **æ²¡æœ‰é€Ÿç‡é™åˆ¶**ï¼šæ”»å‡»è€…å¯ä»¥å¿«é€Ÿå‘é€å¤§é‡ç¡®è®¤è¯·æ±‚
- âŒ **æ²¡æœ‰å¹‚ç­‰æ€§**ï¼šç½‘ç»œé‡è¯•å¯èƒ½å¯¼è‡´é‡å¤ç¡®è®¤æ”¯ä»˜
- âš ï¸ **ä¸¥é‡æ€§**ï¼š**é«˜** - æ¶‰åŠå®é™…æ‰£æ¬¾æ“ä½œ

**æ”»å‡»åœºæ™¯**ï¼š
```
æ¶æ„ç”¨æˆ·ï¼š
1. åˆ›å»ºæ”¯ä»˜æ„å›¾
2. å¿«é€Ÿå‘é€100æ¬¡ç¡®è®¤è¯·æ±‚
3. å¯èƒ½å¯¼è‡´å¤šæ¬¡æ‰£æ¬¾æˆ–ç³»ç»Ÿå´©æºƒ
```

#### 2. **POST /api/payments/refund** - å‘èµ·é€€æ¬¾ï¼ˆç®¡ç†å‘˜ï¼‰

```typescript
// å½“å‰ä»£ç 
router.post(
  '/refund',
  validateBody(initiateRefundSchema),
  paymentController.initiateRefund
);
```

**é£é™©**ï¼š
- âŒ **æ²¡æœ‰é€Ÿç‡é™åˆ¶**ï¼šç®¡ç†å‘˜å¯èƒ½è¯¯æ“ä½œï¼Œå¿«é€Ÿå‘èµ·å¤šæ¬¡é€€æ¬¾
- âŒ **æ²¡æœ‰å¹‚ç­‰æ€§**ï¼šç½‘ç»œé‡è¯•å¯èƒ½å¯¼è‡´é‡å¤é€€æ¬¾
- âš ï¸ **ä¸¥é‡æ€§**ï¼š**é«˜** - æ¶‰åŠèµ„é‡‘é€€æ¬¾æ“ä½œ

**æ”»å‡»åœºæ™¯**ï¼š
```
æ¶æ„ç®¡ç†å‘˜æˆ–è´¦æˆ·è¢«ç›—ï¼š
1. å¿«é€Ÿå‘èµ·å¤šæ¬¡é€€æ¬¾è¯·æ±‚
2. å¯èƒ½å¯¼è‡´é‡å¤é€€æ¬¾ï¼Œé€ æˆèµ„é‡‘æŸå¤±
```

#### 3. **GET /api/payments/konbini/:paymentIntentId** - è·å– Konbini è¯¦æƒ…

```typescript
// å½“å‰ä»£ç 
router.get(
  '/konbini/:paymentIntentId',
  validateParams(paymentIntentIdSchema),
  paymentController.getKonbiniDetails
);
```

**é£é™©**ï¼š
- âŒ **æ²¡æœ‰é€Ÿç‡é™åˆ¶**ï¼šå¯èƒ½è¢«ç”¨äºä¿¡æ¯æ”¶é›†æ”»å‡»
- âš ï¸ **ä¸¥é‡æ€§**ï¼š**ä¸­** - åªè¯»æ“ä½œï¼Œä½†å¯èƒ½æ³„éœ²ä¿¡æ¯

#### 4. **GET /api/payments/transactions/me** - è·å–ç”¨æˆ·äº¤æ˜“åˆ—è¡¨

```typescript
// å½“å‰ä»£ç 
router.get(
  '/transactions/me',
  validateQuery(listTransactionsSchema),
  paymentController.getMyTransactions
);
```

**é£é™©**ï¼š
- âŒ **æ²¡æœ‰é€Ÿç‡é™åˆ¶**ï¼šå¯èƒ½è¢«ç”¨äºæ•°æ®çˆ¬å–
- âš ï¸ **ä¸¥é‡æ€§**ï¼š**ä½** - åªè¯»æ“ä½œï¼Œä½†å¯èƒ½å½±å“æ€§èƒ½

#### 5. **GET /api/payments/transactions/:transactionId** - è·å–äº¤æ˜“è¯¦æƒ…

```typescript
// å½“å‰ä»£ç 
router.get(
  '/transactions/:transactionId',
  validateParams(transactionIdSchema),
  paymentController.getTransaction
);
```

**é£é™©**ï¼š
- âŒ **æ²¡æœ‰é€Ÿç‡é™åˆ¶**ï¼šå¯èƒ½è¢«ç”¨äºä¿¡æ¯æ”¶é›†
- âš ï¸ **ä¸¥é‡æ€§**ï¼š**ä½** - åªè¯»æ“ä½œ

## ğŸ¯ æ¨èä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¸ºå…³é”®è·¯ç”±æ·»åŠ ä¿æŠ¤ï¼ˆæ¨èï¼‰

#### 1.1 ç¡®è®¤æ”¯ä»˜è·¯ç”±ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

```typescript
router.post(
  '/confirm',
  rateLimits.purchase,                    // âœ… æ·»åŠ é€Ÿç‡é™åˆ¶
  idempotencyMiddleware(24 * 60 * 60),   // âœ… æ·»åŠ å¹‚ç­‰æ€§ï¼ˆ24å°æ—¶ï¼‰
  validateBody(confirmPaymentSchema),
  paymentController.confirmPayment
);
```

**ç†ç”±**ï¼š
- ç¡®è®¤æ”¯ä»˜æ¶‰åŠå®é™…æ‰£æ¬¾ï¼Œå¿…é¡»é˜²æ­¢é‡å¤å’Œæ»¥ç”¨
- 24å°æ—¶å¹‚ç­‰æ€§çª—å£ç¡®ä¿ç½‘ç»œé‡è¯•ä¸ä¼šé‡å¤æ‰£æ¬¾

#### 1.2 é€€æ¬¾è·¯ç”±ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

```typescript
router.post(
  '/refund',
  rateLimits.purchase,                    // âœ… æ·»åŠ é€Ÿç‡é™åˆ¶
  idempotencyMiddleware(24 * 60 * 60),   // âœ… æ·»åŠ å¹‚ç­‰æ€§ï¼ˆ24å°æ—¶ï¼‰
  validateBody(initiateRefundSchema),
  paymentController.initiateRefund
);
```

**ç†ç”±**ï¼š
- é€€æ¬¾æ¶‰åŠèµ„é‡‘æ“ä½œï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶
- é˜²æ­¢è¯¯æ“ä½œæˆ–æ¶æ„é€€æ¬¾

#### 1.3 æŸ¥è¯¢è·¯ç”±ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

```typescript
// ä¸ºæŸ¥è¯¢è·¯ç”±æ·»åŠ è¾ƒå®½æ¾çš„é€Ÿç‡é™åˆ¶
router.get(
  '/konbini/:paymentIntentId',
  rateLimits.api,  // âœ… ä½¿ç”¨é€šç”¨ API é€Ÿç‡é™åˆ¶ï¼ˆ15åˆ†é’Ÿ100æ¬¡ï¼‰
  validateParams(paymentIntentIdSchema),
  paymentController.getKonbiniDetails
);

router.get(
  '/transactions/me',
  rateLimits.api,  // âœ… ä½¿ç”¨é€šç”¨ API é€Ÿç‡é™åˆ¶
  validateQuery(listTransactionsSchema),
  paymentController.getMyTransactions
);

router.get(
  '/transactions/:transactionId',
  rateLimits.api,  // âœ… ä½¿ç”¨é€šç”¨ API é€Ÿç‡é™åˆ¶
  validateParams(transactionIdSchema),
  paymentController.getTransaction
);
```

**ç†ç”±**ï¼š
- æŸ¥è¯¢æ“ä½œä¸æ¶‰åŠèµ„é‡‘ï¼Œä½¿ç”¨è¾ƒå®½æ¾çš„é™åˆ¶å³å¯
- é˜²æ­¢æ•°æ®çˆ¬å–å’Œæ€§èƒ½é—®é¢˜

### æ–¹æ¡ˆ 2: åˆ›å»ºä¸“é—¨çš„é€Ÿç‡é™åˆ¶é…ç½®

å¦‚æœéœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå¯ä»¥åˆ›å»ºä¸“é—¨çš„é…ç½®ï¼š

```typescript
// rate-limit.middleware.ts
export const rateLimits = {
  // ... ç°æœ‰é…ç½® ...
  
  // æ”¯ä»˜ç¡®è®¤ï¼ˆéå¸¸ä¸¥æ ¼ï¼‰
  paymentConfirm: rateLimit({
    windowMs: 60 * 1000,      // 1åˆ†é’Ÿ
    maxRequests: 3,            // æœ€å¤š3æ¬¡ï¼ˆæ¯” purchase æ›´ä¸¥æ ¼ï¼‰
    keyPrefix: 'payment-confirm',
  }),
  
  // é€€æ¬¾ï¼ˆéå¸¸ä¸¥æ ¼ï¼‰
  refund: rateLimit({
    windowMs: 60 * 60 * 1000,  // 1å°æ—¶
    maxRequests: 10,            // æ¯å°æ—¶æœ€å¤š10æ¬¡
    keyPrefix: 'refund',
  }),
};
```

## ğŸ“ ä¿®å¤åçš„å®Œæ•´è·¯ç”±é…ç½®

```typescript
// payment.routes.ts

// Webhookï¼ˆä¸éœ€è¦é€Ÿç‡é™åˆ¶å’Œå¹‚ç­‰æ€§ï¼Œç”± Stripe æ§åˆ¶ï¼‰
router.post(
  '/webhook',
  express.raw({ type: 'application/json' }),
  paymentController.handleWebhook
);

// æ‰€æœ‰å…¶ä»–è·¯ç”±éœ€è¦è®¤è¯
router.use(authenticate);
router.use(loadUser);

// âœ… åˆ›å»ºæ”¯ä»˜æ„å›¾ï¼ˆå·²æœ‰ä¿æŠ¤ï¼‰
router.post(
  '/create-intent',
  rateLimits.purchase,
  idempotencyMiddleware(24 * 60 * 60),
  validateBody(createPaymentIntentSchema),
  paymentController.createPaymentIntent
);

// âœ… ç¡®è®¤æ”¯ä»˜ï¼ˆæ·»åŠ ä¿æŠ¤ï¼‰
router.post(
  '/confirm',
  rateLimits.purchase,                    // æ–°å¢
  idempotencyMiddleware(24 * 60 * 60),   // æ–°å¢
  validateBody(confirmPaymentSchema),
  paymentController.confirmPayment
);

// âœ… è·å– Konbini è¯¦æƒ…ï¼ˆæ·»åŠ é€Ÿç‡é™åˆ¶ï¼‰
router.get(
  '/konbini/:paymentIntentId',
  rateLimits.api,                         // æ–°å¢
  validateParams(paymentIntentIdSchema),
  paymentController.getKonbiniDetails
);

// âœ… è·å–ç”¨æˆ·äº¤æ˜“åˆ—è¡¨ï¼ˆæ·»åŠ é€Ÿç‡é™åˆ¶ï¼‰
router.get(
  '/transactions/me',
  rateLimits.api,                         // æ–°å¢
  validateQuery(listTransactionsSchema),
  paymentController.getMyTransactions
);

// âœ… è·å–äº¤æ˜“è¯¦æƒ…ï¼ˆæ·»åŠ é€Ÿç‡é™åˆ¶ï¼‰
router.get(
  '/transactions/:transactionId',
  rateLimits.api,                         // æ–°å¢
  validateParams(transactionIdSchema),
  paymentController.getTransaction
);

// âœ… å‘èµ·é€€æ¬¾ï¼ˆæ·»åŠ ä¿æŠ¤ï¼‰
router.post(
  '/refund',
  rateLimits.purchase,                    // æ–°å¢
  idempotencyMiddleware(24 * 60 * 60),   // æ–°å¢
  validateBody(initiateRefundSchema),
  paymentController.initiateRefund
);
```

## ğŸ¯ æ€»ç»“

### ä»€ä¹ˆæ˜¯é€Ÿç‡é™åˆ¶ï¼Ÿ
- **å®šä¹‰**ï¼šé™åˆ¶ç”¨æˆ·åœ¨ç‰¹å®šæ—¶é—´å†…çš„è¯·æ±‚æ•°é‡
- **ç›®çš„**ï¼šé˜²æ­¢æ»¥ç”¨ã€æ”»å‡»å’Œèµ„æºè€—å°½
- **å®ç°**ï¼šä½¿ç”¨ Redis è®¡æ•°å™¨ï¼ŒæŒ‰ç”¨æˆ·IDæˆ–IPé™åˆ¶

### ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿ
- **å®šä¹‰**ï¼šç›¸åŒè¯·æ±‚æ‰§è¡Œå¤šæ¬¡å’Œæ‰§è¡Œä¸€æ¬¡æ•ˆæœç›¸åŒ
- **ç›®çš„**ï¼šé˜²æ­¢é‡å¤æ“ä½œï¼ˆç‰¹åˆ«æ˜¯æ”¯ä»˜å’Œé€€æ¬¾ï¼‰
- **å®ç°**ï¼šä½¿ç”¨ Redis ç¼“å­˜å“åº”ï¼ŒåŸºäºè¯·æ±‚å†…å®¹ç”Ÿæˆå”¯ä¸€æ ‡è¯†

### ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬ï¼Ÿ
1. **å®‰å…¨æ€§**ï¼šé˜²æ­¢æ¶æ„æ”»å‡»å’Œæ»¥ç”¨
2. **å¯é æ€§**ï¼šé˜²æ­¢ç½‘ç»œé‡è¯•å¯¼è‡´çš„é‡å¤æ“ä½œ
3. **èµ„é‡‘å®‰å…¨**ï¼šé˜²æ­¢é‡å¤æ”¯ä»˜æˆ–é€€æ¬¾
4. **ç³»ç»Ÿç¨³å®šæ€§**ï¼šé˜²æ­¢èµ„æºè€—å°½

### å“ªäº›è·¯ç”±ç¼ºå°‘ä¿æŠ¤ï¼Ÿ
- âŒ **POST /confirm** - ç¼ºå°‘é€Ÿç‡é™åˆ¶å’Œå¹‚ç­‰æ€§ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- âŒ **POST /refund** - ç¼ºå°‘é€Ÿç‡é™åˆ¶å’Œå¹‚ç­‰æ€§ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- âŒ **GET /konbini/:id** - ç¼ºå°‘é€Ÿç‡é™åˆ¶ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- âŒ **GET /transactions/me** - ç¼ºå°‘é€Ÿç‡é™åˆ¶ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
- âŒ **GET /transactions/:id** - ç¼ºå°‘é€Ÿç‡é™åˆ¶ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

### ä¿®å¤ä¼˜å…ˆçº§
1. **ç«‹å³ä¿®å¤**ï¼š`/confirm` å’Œ `/refund`ï¼ˆæ¶‰åŠèµ„é‡‘æ“ä½œï¼‰
2. **å°½å¿«ä¿®å¤**ï¼š`/konbini/:id`ï¼ˆå¯èƒ½æ³„éœ²ä¿¡æ¯ï¼‰
3. **å»ºè®®ä¿®å¤**ï¼šæŸ¥è¯¢è·¯ç”±ï¼ˆé˜²æ­¢æ€§èƒ½é—®é¢˜ï¼‰
