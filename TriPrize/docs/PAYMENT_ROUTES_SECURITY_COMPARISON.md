# æ”¯ä»˜è·¯ç”±å®‰å…¨å¯¹æ¯”å›¾

## ğŸ”´ å½“å‰çŠ¶æ€ï¼ˆéƒ¨åˆ†è·¯ç”±ç¼ºå°‘ä¿æŠ¤ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ”¯ä»˜è·¯ç”±å®‰å…¨çŠ¶æ€                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST /api/payments/create-intent
  âœ… rateLimits.purchase (1åˆ†é’Ÿ5æ¬¡)
  âœ… idempotencyMiddleware (24å°æ—¶)
  âœ… çŠ¶æ€ï¼šå·²ä¿æŠ¤

POST /api/payments/confirm
  âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶
  âŒ æ²¡æœ‰å¹‚ç­‰æ€§
  âš ï¸  é£é™©ï¼šé«˜ï¼ˆæ¶‰åŠå®é™…æ‰£æ¬¾ï¼‰

POST /api/payments/refund
  âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶
  âŒ æ²¡æœ‰å¹‚ç­‰æ€§
  âš ï¸  é£é™©ï¼šé«˜ï¼ˆæ¶‰åŠèµ„é‡‘é€€æ¬¾ï¼‰

GET /api/payments/konbini/:id
  âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶
  âš ï¸  é£é™©ï¼šä¸­ï¼ˆä¿¡æ¯æ³„éœ²ï¼‰

GET /api/payments/transactions/me
  âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶
  âš ï¸  é£é™©ï¼šä½ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰

GET /api/payments/transactions/:id
  âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶
  âš ï¸  é£é™©ï¼šä½ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰
```

## âœ… ä¿®å¤åçŠ¶æ€ï¼ˆæ‰€æœ‰è·¯ç”±éƒ½æœ‰ä¿æŠ¤ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ”¯ä»˜è·¯ç”±å®‰å…¨çŠ¶æ€                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST /api/payments/create-intent
  âœ… rateLimits.purchase (1åˆ†é’Ÿ5æ¬¡)
  âœ… idempotencyMiddleware (24å°æ—¶)
  âœ… çŠ¶æ€ï¼šå·²ä¿æŠ¤

POST /api/payments/confirm
  âœ… rateLimits.purchase (1åˆ†é’Ÿ5æ¬¡)
  âœ… idempotencyMiddleware (24å°æ—¶)
  âœ… çŠ¶æ€ï¼šå·²ä¿æŠ¤

POST /api/payments/refund
  âœ… rateLimits.purchase (1åˆ†é’Ÿ5æ¬¡)
  âœ… idempotencyMiddleware (24å°æ—¶)
  âœ… çŠ¶æ€ï¼šå·²ä¿æŠ¤

GET /api/payments/konbini/:id
  âœ… rateLimits.api (15åˆ†é’Ÿ100æ¬¡)
  âœ… çŠ¶æ€ï¼šå·²ä¿æŠ¤

GET /api/payments/transactions/me
  âœ… rateLimits.api (15åˆ†é’Ÿ100æ¬¡)
  âœ… çŠ¶æ€ï¼šå·²ä¿æŠ¤

GET /api/payments/transactions/:id
  âœ… rateLimits.api (15åˆ†é’Ÿ100æ¬¡)
  âœ… çŠ¶æ€ï¼šå·²ä¿æŠ¤
```

## ğŸ“Š æ”»å‡»åœºæ™¯å¯¹æ¯”

### åœºæ™¯ 1: é‡å¤ç¡®è®¤æ”¯ä»˜

#### âŒ æ²¡æœ‰ä¿æŠ¤
```
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"æŒ‰é’®
  â†“
ç½‘ç»œå»¶è¿Ÿï¼Œç”¨æˆ·å†æ¬¡ç‚¹å‡»
  â†“
è¯·æ±‚1 â†’ ç¡®è®¤æ”¯ä»˜ï¼Œæ‰£æ¬¾ Â¥1000
è¯·æ±‚2 â†’ å†æ¬¡ç¡®è®¤æ”¯ä»˜ï¼Œæ‰£æ¬¾ Â¥1000  (é‡å¤ï¼)
  â†“
ç»“æœï¼šç”¨æˆ·è¢«æ‰£æ¬¾ Â¥2000 âŒ
```

#### âœ… æœ‰ä¿æŠ¤
```
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"æŒ‰é’®
  â†“
ç½‘ç»œå»¶è¿Ÿï¼Œç”¨æˆ·å†æ¬¡ç‚¹å‡»
  â†“
è¯·æ±‚1 â†’ ç¡®è®¤æ”¯ä»˜ï¼Œæ‰£æ¬¾ Â¥1000ï¼Œç¼“å­˜å“åº”
è¯·æ±‚2 â†’ æ£€æµ‹åˆ°é‡å¤ï¼Œè¿”å›ç¼“å­˜å“åº”
  â†“
ç»“æœï¼šç”¨æˆ·åªè¢«æ‰£æ¬¾ Â¥1000 âœ…
```

### åœºæ™¯ 2: æ¶æ„é¢‘ç¹è¯·æ±‚

#### âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶
```
æ”»å‡»è€…è„šæœ¬ï¼š
æ¯ç§’å‘é€100æ¬¡ç¡®è®¤æ”¯ä»˜è¯·æ±‚
  â†“
æœåŠ¡å™¨å¤„ç†100ä¸ªè¯·æ±‚/ç§’
  â†“
ç»“æœï¼šæœåŠ¡å™¨å´©æºƒæˆ–èµ„æºè€—å°½ âŒ
```

#### âœ… æœ‰é€Ÿç‡é™åˆ¶
```
æ”»å‡»è€…è„šæœ¬ï¼š
æ¯ç§’å‘é€100æ¬¡ç¡®è®¤æ”¯ä»˜è¯·æ±‚
  â†“
é€Ÿç‡é™åˆ¶ï¼š1åˆ†é’Ÿæœ€å¤š5æ¬¡
  â†“
å‰5ä¸ªè¯·æ±‚ â†’ å…è®¸
åç»­è¯·æ±‚ â†’ è¿”å› 429 Too Many Requests
  â†“
ç»“æœï¼šæœåŠ¡å™¨æ­£å¸¸è¿è¡Œ âœ…
```

### åœºæ™¯ 3: ç®¡ç†å‘˜è¯¯æ“ä½œé€€æ¬¾

#### âŒ æ²¡æœ‰ä¿æŠ¤
```
ç®¡ç†å‘˜è¯¯æ“ä½œï¼š
å¿«é€Ÿç‚¹å‡»"é€€æ¬¾"æŒ‰é’®3æ¬¡
  â†“
è¯·æ±‚1 â†’ é€€æ¬¾ Â¥1000
è¯·æ±‚2 â†’ é€€æ¬¾ Â¥1000  (é‡å¤ï¼)
è¯·æ±‚3 â†’ é€€æ¬¾ Â¥1000  (é‡å¤ï¼)
  â†“
ç»“æœï¼šç”¨æˆ·æ”¶åˆ° Â¥3000 é€€æ¬¾ âŒ
```

#### âœ… æœ‰ä¿æŠ¤
```
ç®¡ç†å‘˜è¯¯æ“ä½œï¼š
å¿«é€Ÿç‚¹å‡»"é€€æ¬¾"æŒ‰é’®3æ¬¡
  â†“
è¯·æ±‚1 â†’ é€€æ¬¾ Â¥1000ï¼Œç¼“å­˜å“åº”
è¯·æ±‚2 â†’ æ£€æµ‹åˆ°é‡å¤ï¼Œè¿”å›ç¼“å­˜å“åº”
è¯·æ±‚3 â†’ æ£€æµ‹åˆ°é‡å¤ï¼Œè¿”å›ç¼“å­˜å“åº”
  â†“
ç»“æœï¼šç”¨æˆ·åªæ”¶åˆ° Â¥1000 é€€æ¬¾ âœ…
```

## ğŸ”‘ å…³é”®æ¦‚å¿µè§£é‡Š

### é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¯·æ±‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥ Redis è®¡æ•°å™¨                       â”‚
â”‚  Key: ratelimit:purchase:user123        â”‚
â”‚  Value: 3 (å½“å‰è®¡æ•°)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       è®¡æ•° < 5?
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ˜¯                â”‚ å¦
    â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…è®¸è¯·æ±‚  â”‚      â”‚ æ‹’ç»è¯·æ±‚  â”‚
â”‚ è®¡æ•° +1   â”‚      â”‚ è¿”å› 429  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¯·æ±‚                                â”‚
â”‚  Body: { payment_intent_id: "pi_xxx" } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿæˆå”¯ä¸€æ ‡è¯†                            â”‚
â”‚  Key = hash(userId + path + body)       â”‚
â”‚  = "idempotency:user123:/confirm:abc"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥ Redis ç¼“å­˜                         â”‚
â”‚  Key æ˜¯å¦å­˜åœ¨?                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ä¸å­˜åœ¨             â”‚ å­˜åœ¨
    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤„ç†è¯·æ±‚  â”‚      â”‚ è¿”å›ç¼“å­˜  â”‚
â”‚ å­˜å‚¨å“åº”  â”‚      â”‚ å“åº”      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›ä¿æŠ¤ï¼Ÿ

### 1. èµ„é‡‘å®‰å…¨
```
æ²¡æœ‰ä¿æŠ¤ â†’ é‡å¤æ‰£æ¬¾/é€€æ¬¾ â†’ èµ„é‡‘æŸå¤±
æœ‰ä¿æŠ¤ â†’ é˜²æ­¢é‡å¤æ“ä½œ â†’ èµ„é‡‘å®‰å…¨
```

### 2. ç³»ç»Ÿç¨³å®šæ€§
```
æ²¡æœ‰ä¿æŠ¤ â†’ æ¶æ„æ”»å‡» â†’ æœåŠ¡å™¨å´©æºƒ
æœ‰ä¿æŠ¤ â†’ é™åˆ¶è¯·æ±‚é¢‘ç‡ â†’ ç³»ç»Ÿç¨³å®š
```

### 3. ç”¨æˆ·ä½“éªŒ
```
æ²¡æœ‰ä¿æŠ¤ â†’ ç½‘ç»œé‡è¯•å¯¼è‡´é‡å¤æ“ä½œ â†’ ç”¨æˆ·å›°æƒ‘
æœ‰ä¿æŠ¤ â†’ è‡ªåŠ¨å¤„ç†é‡å¤è¯·æ±‚ â†’ ç”¨æˆ·ä½“éªŒå¥½
```

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
- `POST /confirm` - æ¶‰åŠå®é™…æ‰£æ¬¾
- `POST /refund` - æ¶‰åŠèµ„é‡‘é€€æ¬¾

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå°½å¿«ä¿®å¤ï¼‰
- `GET /konbini/:id` - å¯èƒ½æ³„éœ²æ”¯ä»˜ä¿¡æ¯

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
- `GET /transactions/me` - æ€§èƒ½ä¼˜åŒ–
- `GET /transactions/:id` - æ€§èƒ½ä¼˜åŒ–
